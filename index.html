<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>세호로리 뽑기</title>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            width: 100vw;
            height: 100vh;
            transition: transform 0.3s ease;
        }

        .screen {
            min-width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
            width: 95%;
        }

        .navigation-dots {
      position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        /* 세호코인 & 버프 UI (우측 상단) */
        #coinBuffContainer {
            position: fixed;
            top: 16px;
            right: 16px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 2100;
            flex-direction: row-reverse;
        }

        #coinDisplay {
            background: #ffffff;
            border: 3px solid #ffd700;
            border-radius: 12px;
            padding: 12px 30px;
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
            min-width: 200px;
            text-align: center;
        }

        #buffContainer {
            display: flex;
            gap: 10px;
        }

        .buff-icon {
            width: 60px;
            height: 60px;
            background: #ffffff;
            border: 3px solid #28a745;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            font-size: 0.75em;
            font-weight: bold;
            cursor: help;
            position: relative;
        }

        .buff-icon.luck {
            border-color: #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        }

        .buff-icon.speed {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
        }

        .buff-icon .buff-name {
            font-size: 0.8em;
            color: #333;
        }

        .buff-icon .buff-timer {
            font-size: 0.7em;
            color: #666;
            margin-top: 2px;
        }

        /* 설정 패널 (좌측 상단) */
        #settingsPanel {
            position: fixed;
            top: 16px;
            left: 16px;
            background: #ffffff;
            border: 2px solid #adb5bd; /* 연한 회색 테두리 */
            border-radius: 12px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            overflow: hidden;
            z-index: 2100;
            transition: width 0.25s ease, height 0.25s ease;
        }
        #settingsPanel.collapsed {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        #settingsPanel.open {
            width: auto;
            min-width: 320px;
            max-width: 600px;
            max-height: 70vh;
        }
        /* 마우스 오버시 자동 확장 */
        #settingsPanel:hover {
            width: auto;
            min-width: 320px;
            max-width: 600px;
            height: auto; /* 세로로 길게 펼침 */
            max-height: 70vh;
        }
        #settingsPanel:hover #settingsContent { display: block; }
        #settingsHeader {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
        }
        #settingsHeader .title { display: none; }
        #settingsContent {
            padding: 10px 12px;
            display: none;
        }
        #settingsPanel.open #settingsContent { display: block; }
        .settings-row { display: flex; align-items: center; justify-content: space-between; margin: 8px 0; gap: 10px; }
        .settings-row.rarest { flex-direction: column; align-items: flex-start; }
        .settings-key { color: #495057; font-weight: 700; white-space: nowrap; }
        .settings-val { color: #212529; font-weight: 800; text-align: right; word-break: break-word; max-width: 400px; }
        .settings-row.rarest .settings-val { text-align: left; width: 100%; }
        .settings-reset {
            margin-top: 10px;
            width: 100%;
            background: #dc3545;
            color: #fff;
            border: none;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* 햄버거 아이콘 (회색 선 3개) */
        .hamburger { display: inline-flex; flex-direction: column; gap: 4px; padding: 6px; }
        .hamburger span { display: block; width: 22px; height: 3px; background: #6c757d; border-radius: 2px; }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .dot.active {
            background: white;
            transform: scale(1.2);
        }

        .dot.locked {
            background: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
            opacity: 0.5;
        }


        h1 {
            color: #333;
            margin-bottom: 40px;
            font-size: 3em;
            font-weight: bold;
        }

        .draw-area {
            margin: 40px 0;
        }

        .result-display {
            background: #f8f9fa;
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            padding: 50px 30px;
            margin: 30px 0;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .result-display.reset {
            font-size: 1.2em;
            color: #6c757d;
            background: #f8f9fa;
            border-color: #dee2e6;
        }
        .result-display.miss {
            background: white;
            border-color: #dee2e6;
            color: #333;
            font-weight: bold;
            font-size: 2.5em;
            animation: pulse 0.5s ease-in-out;
        }

        .result-display.winner {
            background: white;
            border-color: #dee2e6;
            color: #333;
            font-weight: bold;
            font-size: 2.5em;
            animation: pulse 0.5s ease-in-out;
        }

        .result-display.shining {
            background: #fff3cd;
            border-color: #ffc107;
            color: #f0ad4e;
            font-weight: bold;
            font-size: 2.5em;
            animation: pulse 0.5s ease-in-out;
        }

        .result-display.sparkling {
            background: #ffeaa7;
            border-color: #f39c12;
            color: #e67e22;
            font-weight: bold;
            font-size: 2.5em;
            animation: pulse 0.5s ease-in-out;
        }

        .result-display.golden {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
            border: 3px solid #b8860b;
            color: #8b4513;
            font-weight: bold;
            font-size: 2.5em;
            animation: goldenGlow 2s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .result-display.diamond {
            background: linear-gradient(135deg, #b9f2ff 0%, #87ceeb 50%, #00bfff 100%);
            border: 3px solid #4682b4;
            color: #191970;
            font-weight: bold;
            font-size: 2.5em;
            animation: diamondSparkle 2s ease-in-out infinite;
            box-shadow: 0 0 25px rgba(0, 191, 255, 0.6);
        }

        .result-display.rainbow {
            background: #ff4d4d; /* 더 진한 시작 색 */
            border: none; /* 테두리 제거 */
            color: #000000; /* 글자색 검정 고정 */
            font-weight: bold;
            font-size: 2.5em;
            animation: rainbowCycle 1.6s linear infinite, rainbowAura 1.6s ease-in-out infinite alternate, rainbowSparkle 0.7s ease-in-out infinite alternate;
            box-shadow: 0 0 22px rgba(255,255,255,0.35);
            position: relative;
        }

        .result-display.rainbow::after { display: none; }

        /* 광택 효과 제거 (before 요소 삭제) */

        @keyframes rainbowCycle {
            0%   { background: #ff4d4d; color: #000000; }
            16%  { background: #ff9f1a; color: #000000; }
            33%  { background: #ffd60a; color: #000000; }
            50%  { background: #2ecc71; color: #000000; }
            66%  { background: #3498db; color: #000000; }
            83%  { background: #6c5ce7; color: #000000; }
            100% { background: #9b59b6; color: #000000; }
        }

        @keyframes rainbowAura {
            0%   { box-shadow: 0 0 14px rgba(255,179,186,0.35), 0 0 28px rgba(255,217,179,0.25); }
            50%  { box-shadow: 0 0 22px rgba(186,255,201,0.45), 0 0 36px rgba(186,225,255,0.35); }
            100% { box-shadow: 0 0 18px rgba(208,179,255,0.4), 0 0 30px rgba(255,179,186,0.3); }
        }

        @keyframes rainbowBorder {
            0%   { border-color: rgba(255,179,186,0.6); }
            16%  { border-color: rgba(255,217,179,0.6); }
            33%  { border-color: rgba(255,243,179,0.6); }
            50%  { border-color: rgba(186,255,201,0.6); }
            66%  { border-color: rgba(186,225,255,0.6); }
            83%  { border-color: rgba(208,179,255,0.6); }
            100% { border-color: rgba(255,179,186,0.6); }
        }

        @keyframes rainbowSparkle {
            0% { filter: brightness(1) saturate(1); }
            100% { filter: brightness(1.25) saturate(1.1); }
        }

        /* 광택 키프레임 제거 */

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes goldenGlow {
            0% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 215, 0, 0.3), 0 0 60px rgba(255, 215, 0, 0.1); }
            50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.5), 0 0 90px rgba(255, 215, 0, 0.2); }
            100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 215, 0, 0.3), 0 0 60px rgba(255, 215, 0, 0.1); }
        }

        @keyframes diamondSparkle {
            0% { box-shadow: 0 0 20px rgba(0, 191, 255, 0.5), 0 0 40px rgba(0, 191, 255, 0.3), 0 0 60px rgba(0, 191, 255, 0.1); }
            25% { box-shadow: 0 0 30px rgba(0, 191, 255, 0.8), 0 0 60px rgba(0, 191, 255, 0.5), 0 0 90px rgba(0, 191, 255, 0.2); }
            50% { box-shadow: 0 0 25px rgba(0, 191, 255, 0.6), 0 0 50px rgba(0, 191, 255, 0.4), 0 0 75px rgba(0, 191, 255, 0.15); }
            75% { box-shadow: 0 0 35px rgba(0, 191, 255, 0.9), 0 0 70px rgba(0, 191, 255, 0.6), 0 0 100px rgba(0, 191, 255, 0.25); }
            100% { box-shadow: 0 0 20px rgba(0, 191, 255, 0.5), 0 0 40px rgba(0, 191, 255, 0.3), 0 0 60px rgba(0, 191, 255, 0.1); }
        }

        @keyframes confetti {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ffd700;
            animation: confetti 3s linear infinite;
            z-index: 1000;
        }

        .confetti:nth-child(odd) {
            background: #ff6b6b;
            animation-delay: 0.5s;
        }

        .confetti:nth-child(3n) {
            background: #4ecdc4;
            animation-delay: 1s;
        }

        .confetti:nth-child(4n) {
            background: #45b7d1;
            animation-delay: 1.5s;
        }

        .confetti:nth-child(5n) {
            background: #96ceb4;
            animation-delay: 2s;
        }

        .draw-button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 1.4em;
            border-radius: 50px;
      cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
            margin: 15px;
        }

        .draw-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        .draw-button:active {
            transform: translateY(0);
        }

        .draw-button[disabled], .draw-button.disabled {
            background: #adb5bd;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* 접이식 패널 공통 스타일 */
        .collapse-panel {
            margin-top: 15px;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 12px;
            display: none;
        }
        .panel-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .tab-button {
            background: #e9ecef;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .tab-button.active {
            background: #007bff;
            color: #fff;
        }
        .panel-content {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
        }

        /* 독립 오버레이 패널 */
        .overlay {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            max-height: 60vh;
            background: #ffffff;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.2);
            border-top: 4px solid #007bff;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 2000;
            padding: 16px;
            overflow-y: auto;
        }
        .overlay.open {
            transform: translateY(0);
        }
        .overlay .overlay-header {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .overlay .overlay-header .tab-button { flex: none; }

        /* 아래로 내려오는 패널 */
        .bottom-panel {
            display: none;
            margin-top: 12px;
            background: #ffffff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 16px;
        }
        .bottom-panel h2 {
            font-size: 1.4em;
            margin: 10px 0;
            color: #333;
        }
        .bottom-row { display: flex; gap: 16px; align-items: flex-start; }
        .bottom-col { flex: 1; min-width: 0; }

        /* 유물 컬렉션 그리드 */
        /* 유물 컬렉션: 3x3 그리드 */
        .artifact-carousel { 
            width: 100%; 
            height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .artifact-grid { 
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 15px;
            width: 100%;
            max-width: 1100px;
            height: 100%;
        }
        .artifact-card {
            border-radius: 16px;
            background: #f1f3f5;
            border: 3px solid #ced4da;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #495057;
            font-weight: 700;
            text-decoration: none;
            transition: all 0.6s ease;
            position: relative;
            font-size: 0.9em;
            cursor: pointer;
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        .artifact-card:hover { 
            transform: rotateY(180deg);
        }
        .artifact-card.locked { 
            background: repeating-linear-gradient(135deg, #e9ecef 0 8px, #dee2e6 8px 16px); 
            color: #868e96; 
            border-color: #adb5bd;
            opacity: 0.6;
        }
        .artifact-card.locked::before {
            content: "🔒";
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 1.2em;
        }
        .artifact-card.locked:hover {
            transform: none !important;
        }
        .artifact-card.owned {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-color: #1e7e34;
        }
        .artifact-card.owned::after {
            content: "✓";
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 1.2em;
            color: white;
            z-index: 10;
            transform: rotateY(0deg);
        }
        .artifact-card.owned:hover::after {
            transform: rotateY(0deg);
        }
        .artifact-front {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px;
        }
        .artifact-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-radius: 13px;
        }
        .artifact-level {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .artifact-stats {
            font-size: 0.8em;
            line-height: 1.3;
        }

        /* 상점 스타일 */
        .shop-container {
            background: white;
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 1100px;
            width: 95%;
        }

        .shop-container h2 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
            font-size: 2.2em;
        }

        .shop-timer {
            text-align: center;
            color: #6c757d;
            font-size: 1.1em;
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .shop-probability {
            text-align: center;
            color: #495057;
            font-size: 0.85em;
            margin-bottom: 25px;
            padding: 8px 12px;
            background: #e9ecef;
            border-radius: 6px;
            font-weight: 500;
        }

        .shop-items {
            display: flex;
            flex-direction: row;
            gap: 30px;
            justify-content: center;
        }

        .shop-item {
            background: #f8f9fa;
            border: 4px solid #dee2e6;
            border-radius: 12px;
            padding: 35px 25px;
            text-align: center;
            height: 450px;
            width: 280px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 18px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .shop-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .shop-item.sold-out {
            background: #e9ecef !important;
            border-color: #adb5bd !important;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .shop-item.sold-out:hover {
            transform: none;
            box-shadow: none;
        }

        .shop-item .sold-out-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.5em;
            font-weight: bold;
            pointer-events: none;
        }

        /* 상점 물품 등급별 배경색 */
        .shop-item.common {
            background: #ffffff;
            border-color: #dee2e6;
        }

        .shop-item.common:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
        }

        .shop-item.rare {
            background: linear-gradient(135deg, #d4f4dd 0%, #a8e6cf 100%);
            border-color: #28a745;
        }

        .shop-item.rare:hover {
            background: linear-gradient(135deg, #c3f0d0 0%, #90e0b8 100%);
            border-color: #218838;
        }

        .shop-item.epic {
            background: linear-gradient(135deg, #cfe2ff 0%, #9ec5fe 100%);
            border-color: #0d6efd;
        }

        .shop-item.epic:hover {
            background: linear-gradient(135deg, #b6d4fe 0%, #85b5fc 100%);
            border-color: #0a58ca;
        }

        .shop-item.hero {
            background: linear-gradient(135deg, #e0cffc 0%, #c29ffa 100%);
            border-color: #6f42c1;
        }

        .shop-item.hero:hover {
            background: linear-gradient(135deg, #d4bef9 0%, #b085f5 100%);
            border-color: #5a32a3;
        }

        .shop-item.legendary {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
            border-color: #ffc107;
        }

        .shop-item.legendary:hover {
            background: linear-gradient(135deg, #ffecb5 0%, #ffd966 100%);
            border-color: #e0a800;
        }

        .shop-item-name {
            font-weight: bold;
            font-size: 1.4em;
            color: #333;
        }

        .shop-item-price {
            font-size: 1.3em;
            color: #495057;
            font-weight: bold;
        }

        .shop-item-desc {
            font-size: 1em;
            color: #6c757d;
            line-height: 1.5;
        }

        /* 확률표 스타일 */
        .probability-list {
            margin-top: 20px;
        }

        .probability-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin: 6px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            font-size: 1.1em;
            position: relative;
            transition: all 0.3s ease;
            z-index: 20;
        }

        .probability-item:not(.no-hover):hover {
            background: #e3f2fd;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
        }

        .shining-info {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #f39c12;
            border-radius: 0 0 15px 15px;
            padding: 12px 15px;
            font-size: 0.85em;
            color: #8b4513;
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.3);
            transform: translateY(-100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
            opacity: 0;
            backdrop-filter: blur(10px);
            pointer-events: none;
        }

        .probability-item:not(.no-hover):hover .shining-info {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .probability-item:not(.no-hover):hover .shining-info:hover {
            transform: translateY(0);
            opacity: 1;
        }

        .shining-info .effect-title {
            font-weight: bold;
            font-size: 1.05em;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .shining-info         .effect-probability {
            background: rgba(255, 255, 255, 0.7);
            padding: 4px 8px;
            border-radius: 10px;
            margin: 2px 0;
            font-weight: bold;
            color: #8b4513;
            border: 1px solid rgba(243, 156, 18, 0.3);
            display: flex;
            flex-direction: column;
            gap: 1px;
            font-size: 0.9em;
        }

        .shining-info .effect-probability small {
            font-size: 0.8em;
            color: #8b4513;
            font-weight: normal;
            opacity: 0.8;
        }

        .shining-info .effect-description {
            font-size: 0.85em;
            color: #8b4513;
            margin-top: 8px;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            border-left: 3px solid #f39c12;
        }

        .probability-item:not(.no-hover):hover {
            margin-bottom: 380px;
        }
        .artifact-effect {
            color: #007bff;
            font-weight: bold;
        }

        .participant-name {
            font-weight: bold;
            color: #333;
        }

        .probability-value {
            color: #007bff;
            font-weight: bold;
            font-size: 1.1em;
        }

        /* 보관소 스타일 */
        .storage-container .container {
            max-width: 600px;
            width: 95%;
        }

        .storage-list {
            max-height: 600px;
            overflow-y: auto;
            margin-top: 20px;
        }

        /* 아이템 보관소 전용 그리드 레이아웃 */
        #itemStorageList {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
            margin-top: 20px;
        }

        #itemStorageList .storage-item {
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 8px;
        }

        #itemStorageList .storage-item-header {
            flex-direction: column;
            gap: 3px;
        }

        #itemStorageList .storage-item-name {
            font-size: 0.85em;
            font-weight: bold;
            text-align: center;
        }

        #itemStorageList .storage-item-count {
            font-size: 1em;
            font-weight: bold;
        }

        #itemStorageList .storage-item-info {
            font-size: 0.6em;
            margin-top: auto;
        }

        /* 아이템 보관소 컨테이너 너비 확장 */
        .item-storage-screen .container {
            max-width: 900px;
        }

        /* 테마별 배경 그라데이션 */
        body.theme-orange {
            background: linear-gradient(135deg, #ff7043 0%, #ff5722 100%) !important;
        }

        body.theme-green {
            background: linear-gradient(135deg, #66bb6a 0%, #2e7d32 100%) !important;
        }

        body.theme-gray {
            background: linear-gradient(135deg, #78909c 0%, #37474f 100%) !important;
        }

        body.theme-yellow {
            background: linear-gradient(135deg, #ffeb3b 0%, #ff8f00 100%) !important;
        }

        body.theme-pink {
            background: linear-gradient(135deg, #f06292 0%, #ad1457 100%) !important;
        }

        body.theme-purple {
            background: linear-gradient(135deg, #ba68c8 0%, #7b1fa2 100%) !important;
        }

        /* 테마 선택 버튼 */
        .theme-selector {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .theme-button {
            width: 30px;
            height: 30px;
            border: 2px solid #fff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-button:hover {
            transform: scale(1.1);
            border-color: #007bff;
        }

        .theme-button.active {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
        }

        .theme-button.default {
            background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
        }

        .theme-button.orange {
            background: linear-gradient(135deg, #ff8a65 0%, #ff5722 100%);
        }

        .theme-button.green {
            background: linear-gradient(135deg, #81c784 0%, #4caf50 100%);
        }

        .theme-button.gray {
            background: linear-gradient(135deg, #90a4ae 0%, #607d8b 100%);
        }

        .theme-button.yellow {
            background: linear-gradient(135deg, #fff176 0%, #ffc107 100%);
        }

        .theme-button.pink {
            background: linear-gradient(135deg, #f48fb1 0%, #e91e63 100%);
        }

        .theme-button.purple {
            background: linear-gradient(135deg, #ba68c8 0%, #7b1fa2 100%);
        }

        .storage-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .storage-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #28a745;
            width: 240px;
            min-width: 240px;
            transition: all 0.3s ease;
            position: relative;
        }

        /* 보관소 아이템 선택 시 살짝 연해 보이도록 */
        .storage-item.selected { filter: brightness(1.08) saturate(0.9); }
        /* 오버 시에도 연해 보이도록 */
        .storage-item:hover { filter: brightness(1.08) saturate(0.9); }

        /* 보관소 아이템 내 액션 버튼들 */
        .storage-item .action-btn {
            position: absolute;
            bottom: 8px;
            padding: 6px 10px;
            font-size: 0.85em;
            font-weight: 800;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            user-select: none;
            display: none; /* 기본 숨김 */
        }
        .storage-item .action-back {
            left: 10px;
            background: #dc3545; /* 빨간색 */
        }
        .storage-item .action-upgrade {
            right: 10px;
            background: #28a745; /* 초록색 */
        }
        .storage-item .enhance-info {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 42px; /* 버튼들 위에 표시 */
            background: rgba(0,0,0,0.65);
            color: #fff;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.8em;
            white-space: nowrap;
            display: none; /* 기본 숨김 */
        }

        /* 오버 시 컨트롤과 정보 표시 */
        .storage-item:hover .action-btn { display: block; }
        .storage-item:hover .enhance-info { display: block; }

        /* 기본 마우스 오버 효과 제거 - 강화된 아이템만 효과 적용 */

        .storage-item.diamond {
            background: linear-gradient(135deg, #b9f2ff 0%, #87ceeb 50%, #00bfff 100%);
            border-left-color: #4682b4;
            color: #191970;
            box-shadow: 0 4px 15px rgba(0, 191, 255, 0.3);
        }

        .storage-item.golden {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
            border-left-color: #b8860b;
            color: #8b4513;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .storage-item.sparkling {
            background: #ffeaa7;
            border-left-color: #f39c12;
            color: #e67e22;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .storage-item.shining {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #f0ad4e;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .storage-item.rainbow {
            background: #ffe3e8; /* 조금 더 연한 파스텔톤 */
            border-left-color: #ced4da; /* 연한 회색 구분선 */
            color: #2b2d42;
            animation: rainbowCycle 1.8s linear infinite;
            box-shadow: 0 4px 10px rgba(255, 255, 255, 0.2);
            filter: brightness(1.03) saturate(0.7);
        }

        .storage-item .name {
            font-weight: bold;
            font-size: 1.4em;
            color: #333;
            word-break: break-word;
        }

        .storage-item .probability {
            color: #007bff;
            font-size: 0.9em;
            margin-top: 4px;
            font-weight: bold;
        }

        .storage-item .time {
            color: #6c757d;
            font-size: 0.85em;
            margin-top: 4px;
        }

        .storage-item .count {
            position: absolute;
            bottom: 8px;
            right: 12px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }

        .storage-item .sell-button {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 24px;
            height: 24px;
            background: #dc3545;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            display: none;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .storage-item .sell-button:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .storage-item:hover .sell-button {
            display: flex;
        }

        .clear-storage {
            background: #dc3545;
      color: white;
      border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 25px;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .clear-storage:hover {
            background: #c82333;
        }

        /* 강화 확률/파괴 확률 하단 좌측 표시 */
        .storage-item .enhance-stats {
            position: absolute;
            bottom: 8px;
            left: 10px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 0.8em;
            line-height: 1.2;
            display: none;
        }
         .storage-item:hover .enhance-stats { display: block; }

         /* 강화됨 라벨 스타일 */
         .enhanced-label {
             color: #6c757d;
             font-size: 0.75em;
             font-style: italic;
             margin-top: 2px;
         }

         /* 강화 단계별 누적 효과 */
         
         /* 1강: 효과 없음 */
         
        /* 2강: 마우스 오버시 광택 효과 */
        .storage-item[data-enhance-level="2"]:hover {
             position: relative;
             overflow: hidden;
         }
        .storage-item[data-enhance-level="2"]:hover::after {
             content: '';
             position: absolute;
             top: -50%;
             left: -50%;
             width: 200%;
             height: 200%;
             background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shine 0.8s ease-in-out;
             pointer-events: none;
         }

         /* 3강 이상: 마우스 오버시 광택 효과 */
         .storage-item[data-enhance-level="3"]:hover,
         .storage-item[data-enhance-level="4"]:hover,
         .storage-item[data-enhance-level="5"]:hover {
             position: relative;
             overflow: hidden;
         }
         .storage-item[data-enhance-level="3"]:hover::after,
         .storage-item[data-enhance-level="4"]:hover::after,
         .storage-item[data-enhance-level="5"]:hover::after {
             content: '';
             position: absolute;
             top: -50%;
             left: -50%;
             width: 200%;
             height: 200%;
             background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
             animation: shine 0.8s ease-in-out;
             pointer-events: none;
         }

        /* 3강: 마우스 오버시 적당히 올라감 */
        .storage-item[data-enhance-level="3"]:hover,
        .storage-item[data-enhance-level="4"]:hover,
        .storage-item[data-enhance-level="5"]:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }

        /* 4강: 검은색 테두리와 두꺼운 글씨 */
        .storage-item[data-enhance-level="4"] {
            border: 3px solid #000000;
            font-weight: bold;
        }
        .storage-item[data-enhance-level="4"] .name {
            font-weight: 900;
        }
        
        /* 4강: 마우스 오버시 추가 효과 */
        .storage-item[data-enhance-level="4"]:hover,
        .storage-item[data-enhance-level="5"]:hover {
            border: 3px solid #6c757d;
            transform: translateY(-4px);
        }

        /* 5강: 마우스 오버시 흔들림 효과 */
        .storage-item[data-enhance-level="5"]:hover {
            animation: maxLevelShake 0.8s ease-in-out infinite alternate;
            z-index: 1;
            position: relative;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        @keyframes autoShine {
            0% { 
                opacity: 0;
                transform: translateX(-100%) translateY(-100%) rotate(45deg); 
            }
            50% { 
                opacity: 1;
                transform: translateX(0%) translateY(0%) rotate(45deg); 
            }
            100% { 
                opacity: 0;
                transform: translateX(100%) translateY(100%) rotate(45deg); 
            }
        }

        @keyframes maxLevelShake {
            0% {
                transform: translateY(-4px) rotate(-1.5deg);
                box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            }
            100% {
                transform: translateY(-4px) rotate(1.5deg);
                box-shadow: 0 8px 24px rgba(0,0,0,0.18);
            }
        }


         /* 강화된 세호 표시 스타일 */
         .probability-item.enhanced {
             background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
             border-left: 4px solid #f39c12;
         }

         .probability-item.enhanced .participant-name {
             color: #d68910;
             font-weight: bold;
         }

         .enhancement-indicator {
             display: inline-block;
             background: #f39c12;
             color: white;
             padding: 2px 8px;
             border-radius: 12px;
             font-size: 0.75em;
             font-weight: bold;
             margin-left: 8px;
             animation: pulse 2s infinite;
        }

  </style>
</head>
<body>
    <!-- 세호코인 & 버프 UI -->
    <div id="coinBuffContainer">
        <div id="coinDisplay">
            <span id="coinAmount">0</span> 세호코인
        </div>
        <div id="buffContainer">
            <!-- 버프 아이콘들이 여기에 동적으로 추가됩니다 -->
        </div>
    </div>

    <!-- 설정 패널 -->
    <div id="settingsPanel" class="collapsed" onclick="toggleSettingsPanelClick(event)">
        <div id="settingsHeader">
            <span class="title"></span>
            <span class="hamburger" aria-label="menu">
                <span></span>
                <span></span>
                <span></span>
            </span>
            <span id="settingsChevron" style="display:none">▼</span>
        </div>
        <div id="settingsContent">
            <div class="settings-row"><span class="settings-key">총 뽑기 횟수</span><span class="settings-val" id="statTotalDraws">0</span></div>
            <div class="settings-row rarest"><span class="settings-key">가장 낮은 확률로 획득</span><span class="settings-val" id="statRarest">-</span></div>
            <div class="settings-row"><span class="settings-key">플레이 시간</span><span class="settings-val" id="statPlaytime">00:00:00</span></div>
            <div class="settings-row"><span class="settings-key">테마 변경</span></div>
            <div class="theme-selector" id="themeSelector">
                <!-- 테마 버튼들이 여기에 동적으로 추가됩니다 -->
            </div>
            <button class="settings-reset" onclick="resetAllData()">초기화</button>
        </div>
    </div>
    <div class="main-container" id="mainContainer">
        <!-- 아이템 보관소 화면 (맨 왼쪽) -->
        <div class="screen storage-container item-storage-screen">
            <div class="container">
                <h1>📦 아이템 보관소</h1>
                <div id="itemStorageContent">
                    <div class="storage-list" id="itemStorageList">
                        <p>아이템이 없습니다.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 상점 화면 -->
        <div class="screen">
            <div class="shop-container">
                <h2>🛒 상점</h2>
                <div class="shop-timer" id="shopTimer">갱신까지: 30:00</div>
                <div class="shop-probability" id="shopProbability">일반 45% | 희귀 27.5% | 레어 17.5% | 영웅 7.5% | 전설 2.5%</div>
                <div class="shop-items" id="shopItems">
                    <div class="shop-item">
                        <div class="shop-item-name">???</div>
                        <div class="shop-item-desc">물품을 준비중입니다...</div>
                        <div class="shop-item-price">??? 골드</div>
                    </div>
                    <div class="shop-item">
                        <div class="shop-item-name">???</div>
                        <div class="shop-item-desc">물품을 준비중입니다...</div>
                        <div class="shop-item-price">??? 골드</div>
                    </div>
                    <div class="shop-item">
                        <div class="shop-item-name">???</div>
                        <div class="shop-item-desc">물품을 준비중입니다...</div>
                        <div class="shop-item-price">??? 골드</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 확률표 화면 -->
        <div class="screen">
            <div class="container">
                <h1>📊 확률표</h1>
                <div id="probabilityContent">
                    <p>참가자가 없습니다.</p>
                </div>
            </div>
        </div>

        <!-- 뽑기 화면 (가운데) -->
        <div class="screen">
            <div class="container">
                <h1>🎲 세호뽑기</h1>
                
                <div class="draw-area">
                    <div id="resultDisplay" class="result-display">
                        뽑기를 시작해보세요!
                    </div>
                    
                    <button id="drawButton" class="draw-button" onclick="startDraw()">
                        🎯 뽑기 시작!
                    </button>
                    <div id="trumpCardInfo" style="margin-top: 10px; color: #adb5bd; font-size: 0.9em; text-align: center; display: none;">
                        <!-- 트럼프카드 정보가 여기에 표시됩니다 -->
                    </div>
                </div>
            </div>
  </div>

        <!-- 보관소 화면 (오른쪽) -->
        <div class="screen storage-container">
            <div class="container">
                <h1>📦 보관소</h1>
                <div id="storageContent">
                    <div class="storage-list" id="storageList">
                        <p>뽑힌 결과가 여기에 저장됩니다.</p>
                    </div>
                    <button class="clear-storage" onclick="clearStorage()">
                        🗑️ 전체 삭제
                    </button>
                </div>
            </div>
        </div>

        <!-- 4번째 화면: 🏺 유물 뽑기 -->
        <div class="screen">
            <div class="container">
                <h1>🏺 유물 뽑기</h1>
                <div class="draw-area">
                    <div class="result-display reset" id="artifactResult">유물 뽑기를 준비해주세요!</div>
                    <button class="draw-button" id="artifactDrawButton" onclick="startArtifactDraw()">🏺 유물 뽑기</button>
                    <div id="artifactCooldown" style="margin-top: 10px; color: #6c757d; font-size: 0.9em;"></div>
                    <div style="margin-top: 15px; color: #adb5bd; font-size: 0.8em; text-align: center; line-height: 1.4;">
                        (유물을 뽑을 확률은 50%이고, 유물별 확률은 모두 균일합니다)
                    </div>
                </div>
            </div>
        </div>

        <!-- 5번째 화면: 🏺 유물 컬렉션 (가로 회전 캐러셀) -->
        <div class="screen">
            <div class="container">
                <h1>🏺 유물 컬렉션</h1>
                <div id="artifactCarousel" class="artifact-carousel">
                    <div class="artifact-grid" id="artifactGrid"></div>
                </div>
            </div>
        </div>
  </div>

    <!-- 네비게이션 도트 -->
    <div class="navigation-dots">
         <div class="dot" id="dot-0" onclick="goToScreen(0)"></div>
         <div class="dot" id="dot-1" onclick="goToScreen(1)"></div>
         <div class="dot" id="dot-2" onclick="goToScreen(2)"></div>
         <div class="dot active" id="dot-3" onclick="goToScreen(3)"></div>
         <div class="dot" id="dot-4" onclick="goToScreen(4)"></div>
         <div class="dot" id="dot-5" onclick="goToScreen(5)"></div>
         <div class="dot" id="dot-6" onclick="goToScreen(6)"></div>
    </div>

  <script>
        // 소수 표시 포맷터: 유한소수는 끝자리까지, 무한소수는 소수 3자리 + '...'
        function formatFiniteOrEllipsis(value, maxCheckDecimals = 12) {
            const num = Number(value);
            if (!isFinite(num)) return String(value);
            const abs = Math.abs(num);
            if (Math.abs(abs - Math.round(abs)) < 1e-12) return String(Math.round(num));
            for (let k = 0; k <= maxCheckDecimals; k++) {
                const scaled = num * Math.pow(10, k);
                if (Math.abs(scaled - Math.round(scaled)) < 1e-9) {
                    const fixed = num.toFixed(k);
                    return fixed.replace(/\.?0+$/, '');
                }
            }
            return num.toFixed(3) + '...';
        }

        // 확률표: 마우스 오버 시 상세 표시 (클릭 토글 제거)
        function attachProbabilityToggle(hostId) {
            const host = document.getElementById(hostId);
            if (!host) return;
            host.querySelectorAll('.probability-item').forEach(item => {
                const detail = item.querySelector('.shining-info');
                if (!detail) return;
                // 인라인 스타일/클릭 핸들러 제거하여 CSS :hover로 동작
                detail.style.display = '';
                item.classList.remove('no-hover');
                item.onclick = null;
            });
        }
        // 참가자 목록과 확률 설정 (세호뽑기 확률: 꽝 70%, 10명의 세호 각각 3%)
        let participants = [
            { name: "꽝", weight: 70 },
            { name: "세호로리", weight: 3 },
            { name: "세호게이", weight: 3 },
            { name: "세호퍼리", weight: 3 },
            { name: "씹덕세호", weight: 3 },
            { name: "마죠이스트 세호", weight: 3 },
            { name: "평범한 세호", weight: 3 },
            { name: "TS세호", weight: 3 },
            { name: "쇼타세호", weight: 3 },
            { name: "에겐세호", weight: 3 },
            { name: "니거세호", weight: 3 }
        ];
        // 유물석 기반 유효 확률(가중치) 계산: 레벨당 꽝 -7, 각 세호 +0.7
        function getEffectiveParticipants() {
            const stone = artifactStorage.find(item => item.name === '세호로리의 유물석');
            const level = stone ? stone.level : 0;
            let adjusted = participants.map(p => ({ ...p }));
            
            // 유물석 효과 적용 - 레벨당 8%p 절대값 감소하고 줄어든 만큼을 세호에게 분배
            if (level) {
            const miss = adjusted.find(p => p.name === '꽝');
                if (miss) {
                    const totalWeight = adjusted.reduce((sum, p) => sum + p.weight, 0);
                    const reductionPercent = 8 * level; // 레벨당 8%p (절대값)
                    const reducedWeight = totalWeight * (reductionPercent / 100); // 전체 가중치의 8%
                    miss.weight = Math.max(0, miss.weight - reducedWeight);
                    // 줄어든 확률을 모든 세호에게 균등 분배
                    const sehos = adjusted.filter(p => p.name !== '꽝');
                    const perSeho = reducedWeight / sehos.length;
                    sehos.forEach(p => p.weight += perSeho);
                }
            }
            
            // 행운 포션 효과 적용 - 절대값으로 줄이고 분배
            const luckBuff = activeBuffs.find(b => b.type === 'luck' && b.endTime > Date.now());
            if (luckBuff) {
                const reductionPercent = [5, 10, 20][luckBuff.level - 1]; // 5%p, 10%p, 20%p
                const miss = adjusted.find(p => p.name === '꽝');
                if (miss) {
                    const totalWeight = adjusted.reduce((sum, p) => sum + p.weight, 0);
                    const reducedWeight = totalWeight * (reductionPercent / 100); // 전체 가중치의 x%
                    miss.weight = Math.max(0, miss.weight - reducedWeight);
                    // 줄어든 확률을 모든 세호에게 균등 분배
                    const sehos = adjusted.filter(p => p.name !== '꽝');
                    const perSeho = reducedWeight / sehos.length;
                    sehos.forEach(p => p.weight += perSeho);
                }
            }
            
            // 트럼프카드 효과 적용: 꽝 제외
            if (shouldGuaranteeSpecialEffect()) {
                adjusted = adjusted.filter(p => p.name !== '꽝');
            }
            
            // 용사의 심판 효과 적용
            if (specialItemCount > 0) {
                // 꽝 제거
                adjusted = adjusted.filter(p => p.name !== '꽝');
                
                // 모든 특별효과 확률을 20%로 설정
                const specialEffects = adjusted.filter(p => 
                    p.name.includes('무지갯빛') || 
                    p.name.includes('다이아몬드색') || 
                    p.name.includes('황금색') || 
                    p.name.includes('번쩍이는') || 
                    p.name.includes('빛나는')
                );
                
                if (specialEffects.length > 0) {
                    // 특별효과들의 가중치를 20%로 통일
                    const specialWeight = 20;
                    specialEffects.forEach(p => p.weight = specialWeight);
                    
                    // 나머지 확률을 일반 세호들에게 분배
                    const normalSehos = adjusted.filter(p => !specialEffects.includes(p));
                    const remainingWeight = 100 - (specialEffects.length * specialWeight);
                    const normalWeight = remainingWeight / normalSehos.length;
                    normalSehos.forEach(p => p.weight = normalWeight);
                }
            }
            
            return adjusted;
        }
        let isDrawing = false;
        let currentScreen = 3; // 0: 아이템 보관소, 1: 상점, 2: 확률표, 3: 뽑기, 4: 세호 보관소, 5: 유물 뽑기, 6: 유물 컬렉션
        
        // 세호코인 & 버프 관련 변수
        let sehoCoin = 0; // 초기 세호코인
        let activeBuffs = []; // 활성 버프 목록 { type, level, endTime }
        let purchasedThemes = []; // 구매한 테마 목록
         let currentTheme = 'default'; // 현재 테마
         let specialItemCount = 0; // 용사의 심판 개수
         let noCooldownCount = 0; // 주말 효과 카운터
         let nameChangedItems = []; // 이름이 바뀐 아이템들 (변환기 효과)
         let nameChangeTimer = null; // 이름 변경 효과 타이머
        
        // 상점 관련 변수
        let shopItems = []; // 현재 상점에 있는 물품들
        let purchasedInCurrentShop = []; // 현재 상점에서 구매한 아이템 인덱스
        let allShopItems = [
            // 포션류 - 일반 등급
            { name: '행운포션Ⅰ', price: 10, rarity: 'common', type: 'potion', effect: 'luck', level: 1, minQty: 1, maxQty: 10 },
            { name: '속도포션Ⅰ', price: 10, rarity: 'common', type: 'potion', effect: 'speed', level: 1, minQty: 1, maxQty: 10 },
            // 포션류 - 희귀 등급
            { name: '행운포션Ⅱ', price: 30, rarity: 'rare', type: 'potion', effect: 'luck', level: 2, minQty: 1, maxQty: 5 },
            { name: '속도포션Ⅱ', price: 30, rarity: 'rare', type: 'potion', effect: 'speed', level: 2, minQty: 1, maxQty: 5 },
            // 포션류 - 레어 등급 그룹
            { name: '행운포션Ⅲ', price: 100, rarity: 'epic', type: 'potion', effect: 'luck', level: 3, minQty: 1, maxQty: 3 },
            { name: '속도포션Ⅲ', price: 100, rarity: 'epic', type: 'potion', effect: 'speed', level: 3, minQty: 1, maxQty: 3 },
            // 희귀 등급 아이템
            { name: '쓸데없는 변환기', price: 30, rarity: 'rare', type: 'special', effect: 'name_converter', minQty: 1, maxQty: 1 },
            // 레어 등급 아이템
            { name: '주말', price: 250, rarity: 'epic', type: 'special', effect: 'remove_cooldown', minQty: 1, maxQty: 1 },
            { name: '1339포션', price: 250, rarity: 'epic', type: 'potion', effect: 'speed_boost', level: 4, minQty: 1, maxQty: 1 },
            { name: '보조배터리', price: 250, rarity: 'epic', type: 'special', effect: 'refresh_shop', minQty: 1, maxQty: 1 },
            { name: '럭키박스', price: 250, rarity: 'epic', type: 'special', effect: 'lucky_box', minQty: 1, maxQty: 1 },
            // 테마 - 영웅 등급
            { name: '테마_주황', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'orange', oneTime: true },
            { name: '테마_초록', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'green', oneTime: true },
            { name: '테마_회색', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'gray', oneTime: true },
            { name: '테마_노란색', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'yellow', oneTime: true },
            { name: '테마_핑크색', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'pink', oneTime: true },
            { name: '테마_보라', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'purple', oneTime: true },
            // 특수 아이템 - 영웅 등급
            { name: '용사의 심판', price: 5000, rarity: 'hero', type: 'potion', effect: 'guaranteed_special', minQty: 1, maxQty: 1 }
        ]; // 전체 상점 물품 목록
        let shopRefreshTime = 0; // 다음 상점 갱신 시간 (타임스탬프)
        let shopTimerInterval = null;
        
        // 페이지 로드 시 랜덤뽑기 화면으로 시작
        window.onload = function() {
             // 테스트용: localStorage 초기화 (한 번만 실행)
             // localStorage.removeItem('sehorory_state_v1');
             
             goToScreen(3); // 랜덤뽑기 화면(가운데)으로 시작
            updateProbabilityTable(); // 확률표 초기화
            loadState(); // 저장된 상태 불러오기
            startPlaytimeTicker();
             updateTrumpCardInfo(); // 트럼프카드 정보 업데이트
             initShop(); // 상점 초기화
             updateItemStorageDisplay(); // 아이템 보관소 초기화
             updateCoinDisplay(); // 세호코인 표시 업데이트
             updateBuffDisplay(); // 버프 표시 업데이트
             startBuffTimer(); // 버프 타이머 시작
             updateDotStates(); // 도트 상태 초기화
             // 테마 선택기 초기화 (DOM이 준비된 후)
             setTimeout(() => {
                 initThemeSelector();
                 applyTheme(currentTheme);
             }, 100);
        };
        let storage = []; // 뽑힌 결과 저장소
        let startX = 0;
        let startY = 0;
        let artifactStorage = []; // 유물 저장소
        let lastArtifactDraw = 0; // 마지막 유물 뽑기 시간
        let baseArtifactCooldown = 180; // 기본 유물 뽑기 쿨다운 (초)
        let totalDraws = 0; // 총 뽑기 횟수
        let rarestItem = null; // { name, realProbabilityNum }
        let startTime = Date.now();
        let playtimeTimer = null;
        let lastEnhancementTime = 0; // 마지막 강화 시간
        let pausedTime = 0; // 일시정지된 시간 누적
        let lastPauseTime = 0; // 마지막 일시정지 시점
        let enhancementCooldown = 1000; // 강화 쿨다운 (1초)
        let sehoDrawCount = 0; // 세호 뽑기 횟수 추적

        // 상태 저장/불러오기 (localStorage)
        function saveState() {
            try {
                 const data = {
                     storage,
                     artifactStorage,
                     lastArtifactDraw,
                     totalDraws,
                     rarestItem,
                     startTime,
                     pausedTime,
                     sehoDrawCount,
                     shopItems,
                     shopRefreshTime,
                     purchasedInCurrentShop,
                     sehoCoin,
                     activeBuffs,
                     purchasedThemes,
                     currentTheme,
                     itemStorage,
                     specialItemCount,
                     noCooldownCount,
                     nameChangedItems
                 };
                localStorage.setItem('sehorory_state_v1', JSON.stringify(data));
            } catch (e) { console.log('save failed'); }
        }

        // 테스트용 유물 초기화 함수
        function initializeTestArtifacts() {
            const artifactNames = [
                '세호로리의 부적', '세호퍼리의 부적', '세호게이의 부적',
                '마죠이스트세호의 부적', '씹덕세호의 부적', 'TS세호의 부적',
                '쇼타세호의 부적', '에겐세호의 부적', '니거세호의 부적',
                '세호로리의 시간가속기', '세호로리의 7목걸이',
                '세호로리의 유물석', '세호로리의 무지갯빛 보석',
                '세호로리의 신성한 망치', '세호로리의 트럼프카드'
            ];
            artifactNames.forEach(name => {
                artifactStorage.push({
                    name: name,
                    level: 3,
                    date: new Date().toLocaleDateString('ko-KR'),
                    time: new Date().toLocaleTimeString('ko-KR')
                });
            });
            saveState(); // 상태 저장
        }

        function loadState() {
            try {
                const raw = localStorage.getItem('sehorory_state_v1');
                if (!raw) {
                    // 저장된 데이터가 없으면 기본 상태 유지
                    updateStorageDisplay();
                    initArtifactCarousel();
                    updateSettingsStats();
                    return;
                }
                const data = JSON.parse(raw);
                if (Array.isArray(data.storage)) storage = data.storage;
                if (Array.isArray(data.artifactStorage)) artifactStorage = data.artifactStorage;
                if (typeof data.lastArtifactDraw === 'number') lastArtifactDraw = data.lastArtifactDraw;
                if (typeof data.totalDraws === 'number') totalDraws = data.totalDraws;
                if (data.rarestItem) rarestItem = data.rarestItem;
                if (typeof data.startTime === 'number') startTime = data.startTime;
                if (typeof data.pausedTime === 'number') pausedTime = data.pausedTime;
                if (typeof data.sehoDrawCount === 'number') sehoDrawCount = data.sehoDrawCount;
                if (Array.isArray(data.shopItems)) shopItems = data.shopItems;
                if (typeof data.shopRefreshTime === 'number') shopRefreshTime = data.shopRefreshTime;
                if (Array.isArray(data.purchasedInCurrentShop)) purchasedInCurrentShop = data.purchasedInCurrentShop;
                if (typeof data.sehoCoin === 'number') sehoCoin = data.sehoCoin;
                if (Array.isArray(data.activeBuffs)) activeBuffs = data.activeBuffs;
                if (Array.isArray(data.purchasedThemes)) purchasedThemes = data.purchasedThemes;
                if (typeof data.currentTheme === 'string') currentTheme = data.currentTheme;
                 if (Array.isArray(data.itemStorage)) itemStorage = data.itemStorage;
                 if (typeof data.specialItemCount === 'number') specialItemCount = data.specialItemCount;
                 if (typeof data.noCooldownCount === 'number') noCooldownCount = data.noCooldownCount;
                 if (Array.isArray(data.nameChangedItems)) nameChangedItems = data.nameChangedItems;
                
                updateStorageDisplay();
                initArtifactCarousel();
                updateSettingsStats();
                // 유물 뽑기 쿨다운 복구
                const now = Date.now();
                const remainingMs = getArtifactCooldown() * 1000 - (now - lastArtifactDraw);
                if (remainingMs > 0) startArtifactCooldown();
            } catch (e) { console.log('load failed'); }
        }

        // 가중치 기반 랜덤 선택 함수
        function getWeightedRandom() {
            const pool = getEffectiveParticipants();
            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            let random = Math.random() * totalWeight;
            
            for (let participant of pool) {
                random -= participant.weight;
                if (random <= 0) {
                    return participant;
                }
            }
            return pool[pool.length - 1]; // fallback
        }

        // 뽑기 시작
        function startDraw() {
            if (isDrawing) return;
            
            if (participants.length === 0) {
                document.getElementById('resultDisplay').textContent = '참가자가 없습니다!';
                return;
            }

            isDrawing = true;
            const button = document.getElementById('drawButton');
            button.textContent = '뽑는 중...';
            button.disabled = true;

            // 결과 표시 영역 초기화
            const resultDisplay = document.getElementById('resultDisplay');
            resultDisplay.textContent = '뽑는 중...';
            resultDisplay.className = 'result-display reset';
            resultDisplay.style.fontSize = '2.2em';

            // 애니메이션 효과 (속도포션 적용)
            let count = 0;
            const spinInterval = getSpinInterval();
            const interval = setInterval(() => {
                const randomParticipant = getWeightedRandom();
                resultDisplay.textContent = randomParticipant.name;
                resultDisplay.className = 'result-display reset';
                resultDisplay.style.fontSize = '2.2em';
                count++;
                
                if (count > 45) {
                    clearInterval(interval);
                    finishDraw();
                }
            }, spinInterval);
        }

        // 뽑기 완료
        function finishDraw() {
            const winner = getWeightedRandom(); // 가중치 기반 랜덤 선택
            
            const resultDisplay = document.getElementById('resultDisplay');
            
             // 꽝 처리: 통계 증가만 하고 종료 (트럼프카드 효과 발동 시에는 꽝이 나올 수 없음)
            if (winner && winner.name === '꽝') {
                resultDisplay.textContent = '꽝';
                resultDisplay.className = 'result-display miss';
                totalDraws += 1;
                 // 꽝이어도 세호 뽑기 횟수 증가 (트럼프카드 효과를 위해)
                 sehoDrawCount += 1;
                updateSettingsStats();
                 updateDotStates(); // 도트 상태 업데이트
                 // 트럼프카드 정보 업데이트
                 updateTrumpCardInfo();
                const button = document.getElementById('drawButton');
                button.textContent = '🎯 뽑기 시작!';
                button.disabled = false;
                isDrawing = false;
                saveState();
                return;
             }
            
            // 세호를 뽑았을 때 세호 뽑기 횟수 증가
            if (winner && winner.name !== '꽝') {
                sehoDrawCount += 1;
                // 트럼프카드 정보 업데이트
                updateTrumpCardInfo();
            }
            
            // 유물 효과 적용
            const specialEffectBonus = getSpecialEffectBonus(winner.name);
            const rainbowBonus = getRainbowBonus();
            
            // 독립적인 5단계 뽑기: 빛나는 20%, 번쩍이는 5%, 황금 1%, 다이아 0.2%, 무지갯빛 0.02%
            const random1 = Math.random();
            const random2 = Math.random();
            const random3 = Math.random();
            const random4 = Math.random();
            const random5 = Math.random();
            let effectType = 'normal';
            let displayText = winner.name;
            
            // 꽝 처리: 효과 없음, 보관소 저장 안 함
            if (winner.name === '꽝') {
                resultDisplay.textContent = '꽝';
                resultDisplay.className = 'result-display miss';
                const button = document.getElementById('drawButton');
                button.textContent = '🎯 뽑기 시작!';
                button.disabled = false;
                isDrawing = false;
                return;
            }
            
            // 트럼프카드 효과 확인 (세호를 뽑았을 때만)
            const isGuaranteedSpecial = shouldGuaranteeSpecialEffect();
            
            if (isGuaranteedSpecial) {
                // 트럼프카드 효과 발동: 원래 특별효과 비율을 유지하면서 일반 세호만 제외
                const totalSpecialChance = 0.0002 * (1 + rainbowBonus) + 0.002 * (1 + specialEffectBonus) + 
                                         0.01 * (1 + specialEffectBonus) + 0.2 * (1 + specialEffectBonus) + 
                                         0.05 * (1 + specialEffectBonus);
                
                // 특별효과 비율을 100%로 정규화
                const normalizedRainbow = (0.0002 * (1 + rainbowBonus)) / totalSpecialChance;
                const normalizedDiamond = (0.002 * (1 + specialEffectBonus)) / totalSpecialChance;
                const normalizedGolden = (0.01 * (1 + specialEffectBonus)) / totalSpecialChance;
                const normalizedShining = (0.2 * (1 + specialEffectBonus)) / totalSpecialChance;
                const normalizedSparkling = (0.05 * (1 + specialEffectBonus)) / totalSpecialChance;
                
                const specialRandom = Math.random();
                let cumulative = 0;
                
                if (specialRandom < (cumulative += normalizedRainbow)) {
                    effectType = 'rainbow';
                    displayText = `무지갯빛 ${winner.name}`;
                } else if (specialRandom < (cumulative += normalizedDiamond)) {
                    effectType = 'diamond';
                    displayText = `다이아몬드색 ${winner.name}`;
                } else if (specialRandom < (cumulative += normalizedGolden)) {
                    effectType = 'golden';
                    displayText = `황금색 ${winner.name}`;
                } else if (specialRandom < (cumulative += normalizedShining)) {
                    effectType = 'shining';
                    displayText = `빛나는 ${winner.name}`;
                } else {
                    effectType = 'sparkling';
                    displayText = `번쩍이는 ${winner.name}`;
                }
            } else {
                // 일반 뽑기: 원래 확률대로
            if (random5 < 0.0002 * (1 + rainbowBonus)) {
                effectType = 'rainbow';
                displayText = `무지갯빛 ${winner.name}`;
            } else if (random4 < 0.002 * (1 + specialEffectBonus)) {
                effectType = 'diamond';
                displayText = `다이아몬드색 ${winner.name}`;
            } else if (random3 < 0.01 * (1 + specialEffectBonus)) {
                effectType = 'golden';
                displayText = `황금색 ${winner.name}`;
            } else if (random1 < 0.2 * (1 + specialEffectBonus)) {
                effectType = 'shining';
                displayText = `빛나는 ${winner.name}`;
            } else if (random2 < 0.05 * (1 + specialEffectBonus)) {
                effectType = 'sparkling';
                displayText = `번쩍이는 ${winner.name}`;
                }
            }
            
            resultDisplay.textContent = displayText;
            
            // 효과에 따른 클래스 설정
            if (effectType === 'rainbow') {
                resultDisplay.className = 'result-display rainbow';
                playRainbowSound();
            } else if (effectType === 'diamond') {
                resultDisplay.className = 'result-display diamond';
                playDiamondSound();
            } else if (effectType === 'golden') {
                resultDisplay.className = 'result-display golden';
                playGoldenSound();
            } else if (effectType === 'shining') {
                resultDisplay.className = 'result-display shining';
            } else if (effectType === 'sparkling') {
                resultDisplay.className = 'result-display sparkling';
            } else {
                resultDisplay.className = 'result-display winner';
            }
            
             // 보관소에 추가 (원본 이름만 전달, effectType은 별도로)
             addToStorage(winner.name, effectType, winner);
            totalDraws += 1;
            updateSettingsStats();
             updateDotStates(); // 도트 상태 업데이트
            saveState();
            
            // 화면들 동기화 갱신
            renderBelowProbability();
            updateStorageDisplay();
            
            // 버튼 상태 복원
            const button = document.getElementById('drawButton');
            button.textContent = '🎯 뽑기 시작!';
            button.disabled = false;
            isDrawing = false;
        }

        // 보관소에 추가
        function addToStorage(winner, effectType = 'normal', participant = null) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR');
            
            // 원본 확률 계산
            const pool = getEffectiveParticipants();
            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            const participantData = participant || pool.find(p => p.name === winner);
            const baseProbabilityNum = participantData ? ((participantData.weight / totalWeight) * 100) : 0;
            const baseProbability = formatFiniteOrEllipsis(baseProbabilityNum);
            
            // 실제 확률 계산 (효과 포함, 강화 효과 반영)
            let realProbabilityNum = baseProbabilityNum;
            // participant.name을 사용하여 원본 세호 이름으로 특별효과 보너스 계산
            const specialEffectBonus = getSpecialEffectBonus(participant ? participant.name : winner);
            
            if (effectType === 'rainbow') {
                // 무지갯빛의 실확률 (독립 단계) 표기: 기본 확률 * 0.0002 * (1 + 무지갯빛 보석 보너스)
                realProbabilityNum = baseProbabilityNum * 0.0002 * (1 + getRainbowBonus());
            } else if (effectType === 'diamond') {
                realProbabilityNum = baseProbabilityNum * 0.002 * (1 + specialEffectBonus);
            } else if (effectType === 'golden') {
                realProbabilityNum = baseProbabilityNum * 0.01 * (1 + specialEffectBonus);
            } else if (effectType === 'shining') {
                realProbabilityNum = baseProbabilityNum * 0.2 * (1 + specialEffectBonus);
            } else if (effectType === 'sparkling') {
                realProbabilityNum = baseProbabilityNum * 0.05 * (1 + specialEffectBonus);
            }
            const realProbability = formatFiniteOrEllipsis(realProbabilityNum);
            // 레어도 갱신 (가장 낮은 실확률)
            try {
                const rp = Number(realProbabilityNum);
                if (!isNaN(rp) && rp >= 0) {
                    if (!rarestItem || rp < rarestItem.realProbabilityNum) {
                        // 원본 이름과 effectType을 함께 저장
                        let displayName = winner;
                        if (effectType === 'rainbow') {
                            displayName = `🌈 ${winner} 🌈`;
                        } else if (effectType === 'diamond') {
                            displayName = `💎 다이아몬드색 ${winner} 💎`;
                        } else if (effectType === 'golden') {
                            displayName = `🏆 황금색 ${winner} 🏆`;
                        } else if (effectType === 'sparkling') {
                            displayName = `⚡ 번쩍이는 ${winner} ⚡`;
                        } else if (effectType === 'shining') {
                            displayName = `✨ 빛나는 ${winner} ✨`;
                        }
                        rarestItem = { name: displayName, realProbabilityNum: rp };
                    }
                }
            } catch (e) {}
            
            // 같은 아이템이 있는지 확인 (강화 단계도 고려)
            // 뽑기로 얻은 아이템은 항상 강화 단계 0이므로, 강화 단계 0인 것만 찾음
            const existingItem = storage.find(item => 
                item.name === winner && 
                item.effectType === effectType &&
                (item.enhanceLevel || 0) === 0
            );
            
            if (existingItem) {
                // 같은 아이템이 있으면 개수 증가
                existingItem.count = (existingItem.count || 1) + 1;
                existingItem.time = timeString; // 최신 시간으로 업데이트
                existingItem.date = now.toLocaleDateString('ko-KR');
            } else {
                // 새로운 아이템 추가
            storage.push({
                name: winner,
                time: timeString,
                date: now.toLocaleDateString('ko-KR'),
                effectType: effectType,
                baseProbability: baseProbability,
                realProbability: realProbability,
                count: 1,
                enhanceLevel: 0
            });
            }
            
            // 용사의 심판 효과 사용
            if (specialItemCount > 0) {
                specialItemCount--;
            }
            
            updateStorageDisplay();
            saveState();
        }

        // 보관소 표시 업데이트
        function updateStorageDisplay() {
            // 메인 보관소 영역 (기존)
            const storageList = document.getElementById('storageList');
            // 오버레이 보관소 영역들
            const storageSehoOverlay = document.querySelector('#sehoOverlay #sehoStor .storage-list');
            const storageArtiOverlay = document.querySelector('#artiOverlay #artiStor .storage-list');
            
            if (storage.length === 0) {
                if (storageList) storageList.innerHTML = '<p>뽑힌 결과가 여기에 저장됩니다.</p>';
                if (storageSehoOverlay) storageSehoOverlay.innerHTML = '<p>뽑힌 결과가 여기에 저장됩니다.</p>';
                if (storageArtiOverlay) storageArtiOverlay.innerHTML = '<p>뽑힌 결과가 여기에 저장됩니다.</p>';
                return;
            }

            // 이벤트 위임으로 강화 버튼 처리 (메인/오버레이 각각)
            function bindUpgradeDelegation(host) {
                if (!host) return;
                host.onclick = (e) => {
                    const target = e.target;
                    if (target && target.classList && target.classList.contains('action-upgrade')) {
                        const itemDiv = target.closest('.storage-item');
                        if (!itemDiv) return;
                        const idxAttr = itemDiv.getAttribute('data-index');
                        if (idxAttr == null) return;
                        const idx = parseInt(idxAttr, 10);
                        performUpgrade(idx);
                        e.stopPropagation();
                    }
                };
            }

            bindUpgradeDelegation(storageList);
            bindUpgradeDelegation(storageSehoOverlay);
            bindUpgradeDelegation(storageArtiOverlay);

            // 확률이 낮은 순으로 정렬 (강화된 확률 기준)
            const sortedStorage = [...storage].sort((a, b) => {
                // 강화된 확률 계산
                const getEffectiveProbability = (item) => {
                    const baseProb = parseFloat(item.realProbability) || 0;
                    const level = item.enhanceLevel || 0;
                    if (level === 0) return baseProb;
                    
                    // 강화 단계에 따른 성공 확률들
                    const enhanceChances = [0.8, 0.7, 0.55, 0.35, 0.1];
                    let effectiveProb = baseProb;
                    
                    // 각 강화 단계의 성공 확률을 곱해서 최종 확률 계산
                    for (let i = 0; i < level; i++) {
                        effectiveProb *= enhanceChances[i] || 1;
                    }
                    
                    return effectiveProb;
                };
                
                const aProb = getEffectiveProbability(a);
                const bProb = getEffectiveProbability(b);
                
                // 확률이 낮은 순으로 정렬
                return aProb - bProb;
            });

            if (storageList) storageList.innerHTML = '';
            if (storageSehoOverlay) storageSehoOverlay.innerHTML = '';
            if (storageArtiOverlay) storageArtiOverlay.innerHTML = '';
            
            // 2개씩 그룹으로 나누어 표시
            for (let i = 0; i < sortedStorage.length; i += 2) {
                const row = document.createElement('div');
                row.className = 'storage-row';
                
                for (let j = 0; j < 2 && i + j < sortedStorage.length; j++) {
                    const item = sortedStorage[i + j];
                    const div = document.createElement('div');
                    
                     div.className = `storage-item ${item.effectType}`;
                     const originalIndex = storage.indexOf(item);
                     div.setAttribute('data-index', String(originalIndex));
                     
                     // 이름이 바뀐 아이템 표시
                     if (nameChangedItems.includes(originalIndex)) {
                         div.style.border = '3px solid #ff6b6b';
                         div.style.animation = 'pulse 1s ease-in-out infinite';
                     }
                    
                    // 강화 단계에 따른 시각적 효과 적용
                    const enhanceLevel = item.enhanceLevel || 0;
                    if (enhanceLevel > 0) {
                        div.setAttribute('data-enhance-level', String(enhanceLevel));
                    }
                    
                    let displayName = item.name;
                    const level = Math.max(0, item.enhanceLevel || 0);
                    if (level > 0) displayName = `${displayName} (+${level})`;
                    let probabilityText = `${item.realProbability}%`;
                    
                    if (item.effectType === 'rainbow') {
                        displayName = `🌈 ${displayName} 🌈`;
                    } else if (item.effectType === 'diamond') {
                        displayName = `💎 다이아몬드색 ${displayName} 💎`;
                    } else if (item.effectType === 'golden') {
                        displayName = `🏆 황금색 ${displayName} 🏆`;
                    } else if (item.effectType === 'sparkling') {
                        displayName = `⚡ 번쩍이는 ${displayName} ⚡`;
                    } else if (item.effectType === 'shining') {
                        displayName = `✨ 빛나는 ${displayName} ✨`;
                    }
                    
                    let countHtml = '';
                    if (item.count && item.count > 1) {
                        countHtml = `<div class="count">×${item.count}</div>`;
                    }
                    
                    const infoText = getEnhanceInfoText(level);
                    const rates = calculateEnhanceRates(level);
                    const enhancedLabel = level > 0 ? '<div class="enhanced-label">(강화됨)</div>' : '';
                    
                    // 유물 효과가 있을 때 색상 적용
                    const successColor = rates.hasArtifactEffect ? 'style="color: #87CEEB;"' : '';
                    const destroyColor = rates.hasArtifactEffect ? 'style="color: #87CEEB;"' : '';
                    
                    div.innerHTML = `
                        <button class=\"sell-button\" onclick=\"sellItem(${originalIndex}, event)\" title=\"판매\">🗑️</button>
                        <div class=\"name\">${displayName}</div>
                        <div class=\"probability\">${probabilityText}</div>
                        ${enhancedLabel}
                        <div class=\"time\">${item.date} ${item.time}</div>
                        ${countHtml}
                        <div class=\"enhance-stats\">성공확률: <span ${successColor}>${formatPercent(rates.success)}</span><br>파괴확률: <span ${destroyColor}>${formatPercent(rates.destroy)}</span></div>
                        <div class=\"action-btn action-upgrade\">강화하기</div>
                    `;

                    const upgBtn = div.querySelector('.action-upgrade');
                    if (upgBtn) {
                        if (level >= 5) {
                            upgBtn.style.opacity = '0.5';
                            upgBtn.style.cursor = 'not-allowed';
                            upgBtn.disabled = true;
                        } else {
                            // 쿨타임 확인
                            const now = Date.now();
                            const isOnCooldown = (now - lastEnhancementTime) < enhancementCooldown;
                            
                            if (isOnCooldown) {
                                upgBtn.disabled = true;
                                upgBtn.style.opacity = '0.5';
                                upgBtn.style.cursor = 'not-allowed';
                                upgBtn.style.backgroundColor = '#adb5bd';
                                upgBtn.textContent = '쿨타임...';
                            } else {
                                upgBtn.disabled = false;
                                upgBtn.style.opacity = '1';
                                upgBtn.style.cursor = 'pointer';
                                upgBtn.style.backgroundColor = '#28a745';
                                upgBtn.textContent = '강화하기';
                                upgBtn.onclick = (e) => { performUpgrade(originalIndex); e.stopPropagation(); };
                            }
                        }
                    }
                    row.appendChild(div);
                }
                
                if (storageList) storageList.appendChild(row);
                if (storageSehoOverlay) storageSehoOverlay.appendChild(row.cloneNode(true));
                if (storageArtiOverlay) storageArtiOverlay.appendChild(row.cloneNode(true));
            }
        }

        // 오버레이 초기화/제어
        function initOverlayPanels() {
            // 세호 오버레이
            const sehoOverlay = document.createElement('div');
            sehoOverlay.id = 'sehoOverlay';
            sehoOverlay.className = 'overlay';
            sehoOverlay.innerHTML = `
                <div class="overlay-header">
                    <button class="tab-button active" data-target="sehoProb" onclick="switchOverlayTab(event, 'sehoOverlay')">확률표</button>
                    <button class="tab-button" data-target="sehoStor" onclick="switchOverlayTab(event, 'sehoOverlay')">보관소</button>
                </div>
                <div id="sehoProb" class="panel-content"></div>
                <div id="sehoStor" class="panel-content" style="display:none"><div class="storage-list"></div></div>
            `;
            document.body.appendChild(sehoOverlay);

            // 유물 오버레이
            const artiOverlay = document.createElement('div');
            artiOverlay.id = 'artiOverlay';
            artiOverlay.className = 'overlay';
            artiOverlay.innerHTML = `
                <div class="overlay-header">
                    <button class="tab-button active" data-target="artiColl" onclick="switchOverlayTab(event, 'artiOverlay')">유물 컬렉션</button>
                    <button class="tab-button" data-target="artiStor" onclick="switchOverlayTab(event, 'artiOverlay')">보관소</button>
                </div>
                <div id="artiColl" class="panel-content"><div class="artifact-grid" id="artifactGridOverlay"></div></div>
                <div id="artiStor" class="panel-content" style="display:none"><div class="storage-list"></div></div>
            `;
            document.body.appendChild(artiOverlay);

            renderOverlayProbability();
            updateStorageDisplay();
            initArtifactCollection();
        }

        // 강화 시스템
        const enhanceChances = [0.8, 0.7, 0.55, 0.35, 0.1]; // 0->1 ... 4->5 (원래 확률)

        function formatPercent(p) { return Math.round(p * 1000) / 10 + '%'; }

        // 세호로리의 신성한 망치 유물 효과 확인
        function getHammerArtifactEffect() {
            const hammer = artifactStorage.find(item => item.name === '세호로리의 신성한 망치');
            return hammer ? hammer.level : 0;
        }

        // 세호로리의 트럼프카드 유물 효과 확인
        function getTrumpCardArtifactEffect() {
            const trumpCard = artifactStorage.find(item => item.name === '세호로리의 트럼프카드');
            return trumpCard ? trumpCard.level : 0;
        }

        // 트럼프카드 효과로 특별효과 보장 여부 확인
        function shouldGuaranteeSpecialEffect() {
            const trumpLevel = getTrumpCardArtifactEffect();
            if (trumpLevel === 0) return false;
            
            // 레벨별 보장 횟수: 25회/15회/10회
            const guaranteeInterval = trumpLevel === 1 ? 25 : trumpLevel === 2 ? 15 : 10;
            // 1번째, 26번째, 51번째... 에서 발동 (0이 아닌 1부터 시작)
            return sehoDrawCount > 0 && sehoDrawCount % guaranteeInterval === 1;
        }

        // 트럼프카드 정보 업데이트
        function updateTrumpCardInfo() {
            const trumpCardInfo = document.getElementById('trumpCardInfo');
            const trumpLevel = getTrumpCardArtifactEffect();
            
            if (trumpLevel > 0) {
                const guaranteeInterval = trumpLevel === 1 ? 25 : trumpLevel === 2 ? 15 : 10;
                const nextGuarantee = guaranteeInterval - ((sehoDrawCount - 1) % guaranteeInterval);
                
                if (nextGuarantee === 1) {
                    trumpCardInfo.innerHTML = `🎴 트럼프카드 효과: 준비 완료! 다음 뽑기에서 특별효과 보장`;
                } else {
                    trumpCardInfo.innerHTML = `🎴 트럼프카드 효과: ${nextGuarantee}회 후 특별효과 보장`;
                }
                trumpCardInfo.style.display = 'block';
            } else {
                trumpCardInfo.style.display = 'none';
            }
        }

        // 강화 확률 계산 (유물 효과 포함)
        function calculateEnhanceRates(level) {
            const baseSuccess = enhanceChances[level] || 0;
            const baseFail = 1 - baseSuccess;
            const baseDestroy = baseFail * 0.10;
            
            const hammerLevel = getHammerArtifactEffect();
            let finalSuccess = baseSuccess;
            let finalDestroy = baseDestroy;
            
            if (hammerLevel > 0) {
                // 파괴확률 감소량 계산: 레벨별 고정 수치 0.5%/1%/2%
                const destroyReduction = hammerLevel === 1 ? 0.005 : hammerLevel === 2 ? 0.01 : 0.02;
                const reducedDestroy = Math.max(0, baseDestroy - destroyReduction);
                const destroyReductionAmount = baseDestroy - reducedDestroy;
                
                // 감소된 파괴확률을 성공확률에 추가
                finalSuccess = baseSuccess + destroyReductionAmount;
                finalDestroy = reducedDestroy;
            }
            
            return { success: finalSuccess, destroy: finalDestroy, hasArtifactEffect: hammerLevel > 0 };
        }

        function getEnhanceInfoText(level) {
            if (level >= 5) return '최대 강화 단계(5강)입니다.';
            const rates = calculateEnhanceRates(level);
            const colorStyle = rates.hasArtifactEffect ? 'style="color: #87CEEB;"' : '';
            return `강화 확률: <span ${colorStyle}>${formatPercent(rates.success)}</span> / 파괴 확률: <span ${colorStyle}>${formatPercent(rates.destroy)}</span> (실패 시 1단계 하락, 0강 미만 하락 없음)`;
        }

        function injectEnhanceControls(container, index) {
            const item = storage[index];
            if (!item) return;
            const level = Math.max(0, item.enhanceLevel || 0);
            const info = document.createElement('div');
            info.className = 'enhance-info';
            info.textContent = getEnhanceInfoText(level);
            container.appendChild(info);

            const back = document.createElement('div');
            back.className = 'action-btn action-back';
            back.textContent = '뒤로가기';
            back.onclick = (e) => {
                container.classList.remove('selected');
                if (info) info.remove();
                back.remove();
                if (upg) upg.remove();
                e.stopPropagation();
            };
            container.appendChild(back);

            const upg = document.createElement('div');
            upg.className = 'action-btn action-upgrade';
            upg.textContent = '강화하기';
            if (level >= 5) {
                upg.style.opacity = '0.5';
                upg.style.cursor = 'not-allowed';
            } else {
                upg.onclick = (e) => {
                    performUpgrade(index);
                    e.stopPropagation();
                };
            }
            container.appendChild(upg);
        }

         function performUpgrade(index) {
             const item = storage[index];
             if (!item) return;
             
             // 쿨타임 확인 (주말 효과가 있으면 쿨타임 무시)
             const now = Date.now();
             if (noCooldownCount <= 0 && now - lastEnhancementTime < enhancementCooldown) {
                 const remainingTime = Math.ceil((enhancementCooldown - (now - lastEnhancementTime)) / 1000);
                 alert(`강화 쿨타임 중입니다. ${remainingTime}초 후에 다시 시도해주세요.`);
                 return;
             }
             
             // 주말 효과 사용
             if (noCooldownCount > 0) {
                 noCooldownCount--;
             }
            
            // 강화 시작 사운드
            playEnhanceStartSound();
            
            let level = Math.max(0, item.enhanceLevel || 0);
            if (level >= 5) return;
            
            // 유물 효과를 포함한 강화 확률 계산
            const rates = calculateEnhanceRates(level);
            const success = rates.success;
            const destroy = rates.destroy;
            const r = Math.random();
            if (r < success) {
                level += 1;
                
                // 강화 성공 시 - 같은 강화 단계 아이템이 있으면 합치기
                const now = new Date();
                const timeString = now.toLocaleTimeString('ko-KR');
                
                // 같은 강화 단계의 아이템이 있는지 확인
                const existingEnhancedItem = storage.find(storageItem => 
                    storageItem.name === item.name && 
                    storageItem.effectType === item.effectType &&
                    (storageItem.enhanceLevel || 0) === level
                );
                
                if (existingEnhancedItem) {
                    // 같은 강화 단계가 있으면 개수 증가
                    existingEnhancedItem.count = (existingEnhancedItem.count || 1) + 1;
                    existingEnhancedItem.time = timeString;
                    existingEnhancedItem.date = now.toLocaleDateString('ko-KR');
                } else {
                    // 새로운 강화 단계 아이템 추가
                    const newItem = {
                        name: item.name,
                        time: timeString,
                        date: now.toLocaleDateString('ko-KR'),
                        effectType: item.effectType,
                        baseProbability: item.baseProbability,
                        realProbability: item.realProbability,
                        count: 1,
                        enhanceLevel: level
                    };
                    storage.push(newItem);
                }
                
                // 기존 아이템 개수 감소 또는 제거
                if ((item.count || 1) > 1) {
                    item.count -= 1;
                } else {
                    storage.splice(index, 1);
                }
                
                // 강화 성공 사운드 (5강은 특별한 사운드)
                if (level === 5) {
                    setTimeout(() => playMaxEnhanceSuccessSound(), 200);
                } else {
                    setTimeout(() => playEnhanceSuccessSound(), 200);
                }
            } else {
                // 실패
                const r2 = Math.random();
                if (r2 < destroy) {
                    // 파괴: 동일 항목 수량 감소 또는 제거
                    if ((item.count || 1) > 1) {
                        item.count -= 1;
                    } else {
                        storage.splice(index, 1);
                    }
                    // 파괴 사운드
                    setTimeout(() => playEnhanceDestroySound(), 200);
                } else {
                    // 하락: 0 미만으로는 내려가지 않음
                    const newLevel = Math.max(0, level - 1);
                    
                    if (newLevel !== level) {
                        // 강화 단계가 바뀌는 경우
                        const now = new Date();
                        const timeString = now.toLocaleTimeString('ko-KR');
                        
                        // 같은 강화 단계의 아이템이 있는지 확인
                        const existingItem = storage.find(storageItem => 
                            storageItem.name === item.name && 
                            storageItem.effectType === item.effectType &&
                            (storageItem.enhanceLevel || 0) === newLevel
                        );
                        
                        if (existingItem) {
                            // 같은 강화 단계가 있으면 개수 증가
                            existingItem.count = (existingItem.count || 1) + 1;
                            existingItem.time = timeString;
                            existingItem.date = now.toLocaleDateString('ko-KR');
                        } else {
                            // 새로운 강화 단계 아이템 추가
                            const newItem = {
                                name: item.name,
                                time: timeString,
                                date: now.toLocaleDateString('ko-KR'),
                                effectType: item.effectType,
                                baseProbability: item.baseProbability,
                                realProbability: item.realProbability,
                                count: 1,
                                enhanceLevel: newLevel
                            };
                            storage.push(newItem);
                        }
                        
                        // 기존 아이템 개수 감소 또는 제거
                        if ((item.count || 1) > 1) {
                            item.count -= 1;
                        } else {
                            storage.splice(index, 1);
                        }
                    }
                    
                    // 실패 사운드
                    setTimeout(() => playEnhanceFailSound(), 200);
                }
            }
            
            // 강화 시간 기록
            lastEnhancementTime = now;
            
            // 모든 강화 버튼 비활성화
            disableAllEnhanceButtons();
            
            // 1초 후 버튼 다시 활성화
            setTimeout(() => {
                enableAllEnhanceButtons();
            }, enhancementCooldown);
            
            saveState();
            updateStorageDisplay();
        }

        // 모든 강화 버튼 비활성화
        function disableAllEnhanceButtons() {
            const buttons = document.querySelectorAll('.action-upgrade');
            buttons.forEach(button => {
                button.disabled = true;
                button.style.opacity = '0.5';
                button.style.cursor = 'not-allowed';
                button.style.backgroundColor = '#adb5bd';
                button.textContent = '강화중';
            });
        }

        // 모든 강화 버튼 활성화
        function enableAllEnhanceButtons() {
            const buttons = document.querySelectorAll('.action-upgrade');
            buttons.forEach(button => {
                const itemDiv = button.closest('.storage-item');
                if (!itemDiv) return;
                
                const idxAttr = itemDiv.getAttribute('data-index');
                if (idxAttr == null) return;
                const idx = parseInt(idxAttr, 10);
                const item = storage[idx];
                
                if (item && (item.enhanceLevel || 0) < 5) {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                    button.style.backgroundColor = '#28a745';
                    button.textContent = '강화하기';
                }
            });
        }

        function switchOverlayTab(e, overlayId) {
            const overlay = document.getElementById(overlayId);
            overlay.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            e.currentTarget.classList.add('active');
            const target = e.currentTarget.getAttribute('data-target');
            overlay.querySelectorAll('.panel-content').forEach(p => p.style.display = 'none');
            overlay.querySelector('#' + target).style.display = 'block';
            if (target.endsWith('Stor')) updateStorageDisplay();
            if (target === 'artiColl') initArtifactCollection();
        }

        function openOverlay(which) {
            if (which === 'seho') {
                document.getElementById('sehoOverlay').classList.add('open');
                renderOverlayProbability();
                updateStorageDisplay();
            } else if (which === 'arti') {
                document.getElementById('artiOverlay').classList.add('open');
                initArtifactCollection();
                updateStorageDisplay();
            }
        }

        function closeOverlays() {
            const s = document.getElementById('sehoOverlay');
            const a = document.getElementById('artiOverlay');
            if (s) s.classList.remove('open');
            if (a) a.classList.remove('open');
        }

        function renderOverlayProbability() {
            const probHost = document.querySelector('#sehoOverlay #sehoProb');
            if (!probHost) return;
            const pool = getEffectiveParticipants();
            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            const sortedParticipants = [...pool].sort((a, b) => b.weight - a.weight);
            let listHTML = '<div class="probability-list" id="probListInline">';
            sortedParticipants.forEach(participant => {
                const probability = ((participant.weight / totalWeight) * 100).toFixed(2);
                if (participant.name === '꽝') {
                    listHTML += `
                        <div class="probability-item no-hover">
                            <span class="participant-name">${participant.name}</span>
                            <span class="probability-value">${probability}%</span>
                        </div>
                    `;
                    return;
                }
                // 유물 효과 적용
                const specialEffectBonus = getSpecialEffectBonus(participant.name);
                const rainbowBonus = getRainbowBonus();
                
                const rainbowProbability = (probability * 0.0002 * (1 + rainbowBonus)).toFixed(5);
                const diamondProbability = (probability * 0.002 * (1 + specialEffectBonus)).toFixed(4);
                const goldenProbability = (probability * 0.01 * (1 + specialEffectBonus)).toFixed(3);
                const shiningProbability = (probability * 0.2 * (1 + specialEffectBonus)).toFixed(2);
                const sparklingProbability = (probability * 0.05 * (1 + specialEffectBonus)).toFixed(3);
                
                listHTML += `
                    <div class="probability-item">
                        <span class="participant-name">${participant.name}</span>
                        <span class="probability-value">${probability}%</span>
                        <div class="shining-info">
                            <div class="effect-title">
                                <span>✨</span>
                                <span>특별 효과 확률</span>
                            </div>
                            <div class="effect-probability">
                                ✨ 빛나는 ${participant.name}: ${shiningProbability}% <span class="artifact-effect">(+${(shiningProbability - (probability * 0.2)).toFixed(2)}%)</span>
                                <small>(뽑힌 후 20% 확률)</small>
                            </div>
                            <div class="effect-probability">
                                ⚡ 번쩍이는 ${participant.name}: ${sparklingProbability}% <span class="artifact-effect">(+${(sparklingProbability - (probability * 0.05)).toFixed(3)}%)</span>
                                <small>(뽑힌 후 5% 확률)</small>
                            </div>
                            <div class="effect-probability">
                                🏆 황금색 ${participant.name}: ${goldenProbability}% <span class="artifact-effect">(+${(goldenProbability - (probability * 0.01)).toFixed(3)}%)</span>
                                <small>(뽑힌 후 1% 확률)</small>
                            </div>
                            <div class="effect-probability">
                                💎 다이아몬드색 ${participant.name}: ${diamondProbability}% <span class="artifact-effect">(+${(diamondProbability - (probability * 0.002)).toFixed(4)}%)</span>
                                <small>(뽑힌 후 0.2% 확률)</small>
                            </div>
                            <div class="effect-probability">
                                🌈 무지갯빛 ${participant.name}: ${rainbowProbability}% <span class="artifact-effect">(+${(rainbowProbability - (probability * 0.0002)).toFixed(5)}%)</span>
                                <small>(뽑힌 후 0.02% 확률)</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            listHTML += '</div>';
            probHost.innerHTML = listHTML;
            attachProbabilityToggle('probListOverlay');
        }

        // 세호 인라인 패널 초기화 및 토글/탭
        function initInlinePanels() {
            // 처음 열릴 때 현재 확률표를 인라인에도 렌더
            renderInlineProbability();
        }

        function toggleSehoPanel() {
            const panel = document.getElementById('sehoExtraPanel');
            panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none';
            if (panel.style.display === 'block') {
                // 열릴 때 최신 데이터로 갱신
                renderInlineProbability();
                updateStorageDisplay();
            }
        }

        function switchSehoTab(e) {
            document.querySelectorAll('#sehoExtraPanel .tab-button').forEach(btn => btn.classList.remove('active'));
            e.currentTarget.classList.add('active');
            const target = e.currentTarget.getAttribute('data-target');
            const prob = document.getElementById('probabilityContentInline');
            const stor = document.getElementById('storageListInline');
            if (target === 'probabilityContentInline') {
                prob.style.display = 'block';
                stor.style.display = 'none';
                renderInlineProbability();
            } else {
                prob.style.display = 'none';
                stor.style.display = 'block';
                updateStorageDisplay();
            }
        }

        function renderInlineProbability() {
            const inline = document.getElementById('probabilityContentInline');
            if (!inline) return;
            // 기존 updateProbabilityTable 로직을 재사용하여 HTML 생성
            const pool = getEffectiveParticipants();
            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            const sortedParticipants = [...pool].sort((a, b) => b.weight - a.weight);
            let listHTML = '<div class="probability-list" id="probListOverlay">';
            sortedParticipants.forEach(participant => {
                const probNum = (participant.weight / totalWeight) * 100;
                const probability = formatFiniteOrEllipsis(probNum);
                if (participant.name === '꽝') {
                    listHTML += `
                        <div class="probability-item no-hover">
                            <span class="participant-name">${participant.name}</span>
                            <span class="probability-value">${probability}%</span>
                        </div>
                    `;
                    return;
                }
                // 유물 효과 적용
                const specialEffectBonus = getSpecialEffectBonus(participant.name);
                const rainbowBonus = getRainbowBonus();
                
                const rainbowProbability = formatFiniteOrEllipsis(probNum * 0.0002 * (1 + rainbowBonus));
                const diamondProbability = formatFiniteOrEllipsis(probNum * 0.002 * (1 + specialEffectBonus));
                const goldenProbability = formatFiniteOrEllipsis(probNum * 0.01 * (1 + specialEffectBonus));
                const shiningProbability = formatFiniteOrEllipsis(probNum * 0.2 * (1 + specialEffectBonus));
                const sparklingProbability = formatFiniteOrEllipsis(probNum * 0.05 * (1 + specialEffectBonus));
                
                listHTML += `
                    <div class="probability-item">
                        <span class="participant-name">${participant.name}</span>
                        <span class="probability-value">${probability}%</span>
                        <div class="shining-info">
                            <div class="effect-title">
                                <span>✨</span>
                                <span>특별 효과 확률</span>
                            </div>
                            <div class="effect-probability">
                                ✨ 빛나는 ${participant.name}: ${shiningProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.2 * specialEffectBonus)}%)</span>
                                <small>(뽑힌 후 20% 확률)</small>
                            </div>
                            <div class="effect-probability">
                                ⚡ 번쩍이는 ${participant.name}: ${sparklingProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.05 * specialEffectBonus)}%)</span>
                                <small>(뽑힌 후 5% 확률)</small>
                            </div>
                            <div class="effect-probability">
                                🏆 황금색 ${participant.name}: ${goldenProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.01 * specialEffectBonus)}%)</span>
                                <small>(뽑힌 후 1% 확률)</small>
                            </div>
                            <div class="effect-probability">
                                💎 다이아몬드색 ${participant.name}: ${diamondProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.002 * specialEffectBonus)}%)</span>
                                <small>(뽑힌 후 0.2% 확률)</small>
                            </div>
                            <div class="effect-probability">
                                🌈 무지갯빛 ${participant.name}: ${rainbowProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.0002 * rainbowBonus)}%)</span>
                                <small>(뽑힌 후 0.02% 확률)</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            listHTML += '</div>';
            inline.innerHTML = listHTML;
            attachProbabilityToggle('probListInline');
        }

        // 유물 컬렉션 그리드 초기화
        function initArtifactCarousel() {
            const grid = document.getElementById('artifactGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            // 유물 이름들 (컬렉션)
            const artifactNames = [
                '세호로리의 부적', '세호퍼리의 부적', '세호게이의 부적',
                '마죠이스트세호의 부적', '씹덕세호의 부적', 'TS세호의 부적',
                '쇼타세호의 부적', '에겐세호의 부적', '니거세호의 부적',
                '세호로리의 시간가속기', '세호로리의 7목걸이',
                '세호로리의 유물석', '세호로리의 무지갯빛 보석',
                '세호로리의 신성한 망치', '세호로리의 트럼프카드'
            ];
            
            
            for (let i = 0; i < artifactNames.length; i++) {
                const card = document.createElement('div');
                const isLocked = false; // 테스트용: 모든 유물이 잠겨있지 않음
                card.className = 'artifact-card' + (isLocked ? ' locked' : '');
                
                // 앞면
                const front = document.createElement('div');
                front.className = 'artifact-front';
                front.textContent = artifactNames[i];
                
                // 뒷면
                const back = document.createElement('div');
                back.className = 'artifact-back';
                
                // 실제 유물 레벨 확인
                const ownedArtifact = artifactStorage.find(item => item.name === artifactNames[i]);
                const artifactLevel = ownedArtifact ? ownedArtifact.level : 0;
                
                const level = document.createElement('div');
                level.className = 'artifact-level';
                level.textContent = `레벨 ${artifactLevel}`;
                
                const stats = document.createElement('div');
                stats.className = 'artifact-stats';
                stats.textContent = getArtifactStats(artifactNames[i], artifactLevel);
                
                back.appendChild(level);
                back.appendChild(stats);
                
                card.appendChild(front);
                card.appendChild(back);
                
                grid.appendChild(card);
            }
            
            updateArtifactDisplay();
        }
        
        // 유물 표시 업데이트
        function updateArtifactDisplay() {
            const grid = document.getElementById('artifactGrid');
            if (!grid) return;
            
            const cards = grid.children;
            
            for (let i = 0; i < cards.length; i++) {
                const card = cards[i];
                const front = card.querySelector('.artifact-front');
                const back = card.querySelector('.artifact-back');
                const levelEl = back.querySelector('.artifact-level');
                const statsEl = back.querySelector('.artifact-stats');
                
                if (!front || !back || !levelEl || !statsEl) continue;
                
                const artifactName = front.textContent;
                
                // owned 클래스 제거
                card.classList.remove('owned', 'locked');
                
                // 보유한 유물인지 확인
                const ownedArtifact = artifactStorage.find(item => item.name === artifactName);
                if (ownedArtifact) {
                    card.classList.add('owned');
                    levelEl.textContent = `레벨 ${ownedArtifact.level}`;
                    statsEl.textContent = getArtifactStats(artifactName, ownedArtifact.level);
                } else {
                    card.classList.add('locked');
                    levelEl.textContent = '레벨 0';
                    statsEl.textContent = getArtifactStats(artifactName, 0);
                }
            }
        }
        
        // 유물 능력치 반환
        function getArtifactStats(artifactName, level) {
            const baseStats = {
                '세호로리의 부적': '특별효과 확률 증가',
                '세호퍼리의 부적': '특별효과 확률 증가',
                '세호게이의 부적': '특별효과 확률 증가',
                '마죠이스트세호의 부적': '특별효과 확률 증가',
                '씹덕세호의 부적': '특별효과 확률 증가',
                'TS세호의 부적': '특별효과 확률 증가',
                '쇼타세호의 부적': '특별효과 확률 증가',
                '에겐세호의 부적': '특별효과 확률 증가',
                '니거세호의 부적': '특별효과 확률 증가',
                '세호로리의 시간가속기': '뽑기 속도 증가',
                '세호로리의 7목걸이': '꽝 확률 감소',
                '세호로리의 유물석': '유물 뽑기 대기시간 감소',
                '세호로리의 무지갯빛 보석': '무지갯빛 확률 증가',
                '세호로리의 신성한 망치': '강화 파괴확률 감소',
                '세호로리의 트럼프카드': '세호 특별효과 보장'
            };
            
            const baseStat = baseStats[artifactName] || '알 수 없는 능력';
            
            if (level === 0) {
                return '획득하지 않음';
            } else if (level === 1) {
                if (artifactName.includes('부적')) {
                    return baseStat + ' (15% 증가)';
                } else if (artifactName === '세호로리의 시간가속기') {
                    return baseStat + ' (10% 감소)';
                } else if (artifactName === '세호로리의 7목걸이') {
                    return baseStat + ' (7% 감소)';
                } else if (artifactName === '세호로리의 유물석') {
                    return baseStat + ' (꽝 8% 감소, 유물뽑기 시간 10% 감소)';
                } else if (artifactName === '세호로리의 무지갯빛 보석') {
                    return baseStat + ' (75% 증가)';
                }
                return baseStat + ' (레벨 1)';
            } else if (level === 2) {
                if (artifactName.includes('부적')) {
                    return baseStat + ' (30% 증가)';
                } else if (artifactName === '세호로리의 시간가속기') {
                    return baseStat + ' (25% 감소)';
                } else if (artifactName === '세호로리의 7목걸이') {
                    return baseStat + ' (14% 감소)';
                } else if (artifactName === '세호로리의 유물석') {
                    return baseStat + ' (꽝 16% 감소, 유물뽑기 시간 20% 감소)';
                } else if (artifactName === '세호로리의 무지갯빛 보석') {
                    return baseStat + ' (150% 증가)';
                }
                return baseStat + ' (레벨 2)';
            } else if (level === 3) {
                if (artifactName.includes('부적')) {
                    return baseStat + ' (45% 증가)';
                } else if (artifactName === '세호로리의 시간가속기') {
                    return baseStat + ' (50% 감소)';
                } else if (artifactName === '세호로리의 7목걸이') {
                    return baseStat + ' (21% 감소)';
                } else if (artifactName === '세호로리의 유물석') {
                    return baseStat + ' (꽝 24% 감소, 유물뽑기 시간 30% 감소)';
                } else if (artifactName === '세호로리의 무지갯빛 보석') {
                    return baseStat + ' (225% 증가)';
                }
                return baseStat + ' (레벨 3)';
            }
            
            return baseStat;
        }

        function toggleArtifactPanel() {
            const panel = document.getElementById('artifactPanel');
            panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none';
        }

        function switchArtifactTab(e) {
            document.querySelectorAll('#artifactPanel .tab-button').forEach(btn => btn.classList.remove('active'));
            e.currentTarget.classList.add('active');
        }

        function startArtifactDraw() {
            // 테스트용으로 쿨다운 제거
             const now = Date.now();
             const cooldownTime = getArtifactCooldown() * 1000; // 유물 효과 적용된 쿨다운
             
            // // 쿨다운 확인
             if (now - lastArtifactDraw < cooldownTime) {
                 const remainingTime = Math.ceil((cooldownTime - (now - lastArtifactDraw)) / 1000);
                 const button = document.getElementById('artifactDrawButton');
                 if (button) {
                     button.disabled = true;
                     button.classList.add('disabled');
                     button.textContent = `대기중... (${remainingTime}s)`;
                 }
                 return;
             }
            
            const button = document.getElementById('artifactDrawButton');
            const resultEl = document.getElementById('artifactResult');
            const cooldownEl = document.getElementById('artifactCooldown');
            
            if (!button || !resultEl) return;
            
            // 버튼 비활성화
            button.disabled = true;
            button.textContent = '뽑는 중...';
            button.classList.add('disabled');
            
            // 사용 가능한 유물 목록 기반 (전체 유물 획득 확률 50%, 유물 간 균등 분배)
            const availableArtifacts = getAvailableArtifacts();
            
            // 애니메이션
            resultEl.className = 'result-display reset';
            let count = 0;
            const interval = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * Math.max(availableArtifacts.length, 1));
                resultEl.textContent = availableArtifacts.length > 0 ? availableArtifacts[randomIndex] : '꽝';
                count++;
                
                if (count > 20) {
                    clearInterval(interval);
                    
                    // 최종 결과
                    const random = Math.random();
                    let result = '꽝';
                    let resultClass = 'result-display reset';
                    
                    if (random < 0.5) { // 50% 확률로 유물 획득 (유물 간 균등)
                        if (availableArtifacts.length > 0) {
                            const artifactIndex = Math.floor(Math.random() * availableArtifacts.length);
                            result = availableArtifacts[artifactIndex];
                            resultClass = 'result-display golden';
                            
                            // 유물 저장소에 추가
                            addToArtifactStorage(result);
                        } else {
                            result = '꽝';
                            resultClass = 'result-display reset';
                        }
                    }
                    
                    resultEl.textContent = result;
                    resultEl.className = resultClass;
                    
                // 쿨다운 시작 (테스트용으로 비활성화)
                 lastArtifactDraw = now;
                 startArtifactCooldown();
                 saveState();
                    
                    // 버튼 복원
                    button.disabled = true;
                    button.classList.add('disabled');
                    startArtifactCooldown();
                }
            }, 80);
        }
        
        // 유물 저장소에 추가
        function addToArtifactStorage(artifactName) {
            const existingArtifact = artifactStorage.find(item => item.name === artifactName);
            
            if (existingArtifact) {
                // 같은 유물이 있으면 레벨 증가 (최대 3레벨)
                if (existingArtifact.level < 3) {
                    existingArtifact.level = (existingArtifact.level || 1) + 1;
                    existingArtifact.count = (existingArtifact.count || 1) + 1;
                } else {
                    // 이미 최대 레벨이면 개수만 증가
                    existingArtifact.count = (existingArtifact.count || 1) + 1;
                }
            } else {
                // 새로운 유물 추가
                artifactStorage.push({
                    name: artifactName,
                    level: 1,
                    count: 1
                });
            }
            
            // 유물 컬렉션 업데이트
            updateArtifactDisplay();
            // 트럼프카드 정보 업데이트
            updateTrumpCardInfo();
            saveState();
        }
        
        // 유물 뽑기 쿨다운 시작
        function startArtifactCooldown() {
            const cooldownEl = document.getElementById('artifactCooldown');
            const button = document.getElementById('artifactDrawButton');
            if (!cooldownEl) return;
            
            let remainingTime = Math.ceil((getArtifactCooldown() * 1000 - (Date.now() - lastArtifactDraw)) / 1000);
            if (isNaN(remainingTime) || remainingTime < 0) remainingTime = getArtifactCooldown();
            
            const updateCooldown = () => {
                if (remainingTime > 0) {
                    cooldownEl.textContent = `다음 뽑기까지 ${remainingTime}초`;
                    if (button) {
                        button.disabled = true;
                        button.classList.add('disabled');
                        button.textContent = `대기중... (${remainingTime}s)`;
                    }
                    remainingTime--;
                    setTimeout(updateCooldown, 1000);
                } else {
                    cooldownEl.textContent = '유물 뽑기 준비 완료!';
                    if (button) {
                        button.disabled = false;
                        button.classList.remove('disabled');
                        button.textContent = '🏺 유물 뽑기';
                    }
                    saveState();
                }
            };
            
            updateCooldown();
        }

        // 설정 패널 토글 및 통계 갱신/초기화
        function toggleSettingsPanel() {
            const panel = document.getElementById('settingsPanel');
            if (!panel) return;
            const isOpen = panel.classList.contains('open');
            panel.classList.toggle('open', !isOpen);
            panel.classList.toggle('collapsed', isOpen);
        }

        function updateSettingsStats() {
            const td = document.getElementById('statTotalDraws');
            const rr = document.getElementById('statRarest');
            if (td) td.textContent = totalDraws;
            if (rr) {
                if (!rarestItem) rr.textContent = '-';
                else {
                    rr.textContent = `${rarestItem.name} (${formatFiniteOrEllipsis(rarestItem.realProbabilityNum)}%)`;
                }
            }
            const pt = document.getElementById('statPlaytime');
            if (pt) pt.textContent = formatElapsedTime(Date.now() - startTime);
        }

        function resetAllData() {
            if (!confirm('정말 초기화하시겠습니까? 모든 기록이 삭제됩니다.')) return;
            
            // 모든 게임 데이터 초기화
            storage = [];
            artifactStorage = [];
            lastArtifactDraw = 0;
            totalDraws = 0;
            rarestItem = null;
            startTime = Date.now();
            pausedTime = 0;
            lastPauseTime = 0;
            sehoDrawCount = 0;
            
            // 상점 관련 데이터 초기화
            shopItems = [];
            shopRefreshTime = 0;
            purchasedInCurrentShop = [];
            
            // 세호코인 & 버프 관련 데이터 초기화
            sehoCoin = 0;
            activeBuffs = [];
            purchasedThemes = [];
            currentTheme = 'default';
            
            // 아이템 보관소 초기화
            itemStorage = [];
            
             // 특수 아이템 초기화
             specialItemCount = 0;
             noCooldownCount = 0;
             nameChangedItems = [];
             if (nameChangeTimer) clearTimeout(nameChangeTimer);
            
            // 화면 업데이트
            updateStorageDisplay();
            updateItemStorageDisplay();
            initArtifactCarousel();
            updateSettingsStats();
            updateCoinDisplay();
            updateBuffDisplay();
            updateDotStates();
            updateShopDisplay();
            initThemeSelector();
            applyTheme(currentTheme);
            
            // localStorage 완전 삭제
            localStorage.removeItem('sehorory_state_v1');
            
            saveState();
            alert('모든 데이터가 초기화되었습니다.');
        }
        
        // 유물 효과 계산 함수들
        function getArtifactCooldown() {
            const artifact = artifactStorage.find(item => item.name === '세호로리의 유물석');
            if (!artifact) return baseArtifactCooldown;
            
            const reduction = artifact.level * 0.1; // 레벨당 10% 감소
            return Math.max(10, baseArtifactCooldown * (1 - reduction)); // 최소 10초
        }
        
        function getMissReduction() {
            // 유물석 기준: 레벨당 7%p 꽝 감소
            const artifact = artifactStorage.find(item => item.name === '세호로리의 유물석');
            if (!artifact) return 0;
            return artifact.level * 7;
        }

         // 속도포션 레벨에 따라 뽑기 스핀 간격 감소 (기본 40ms)
         function getSpinInterval() {
             const base = 40;
             let totalReduction = 0;
             
             // 유물 시간가속기 효과
             const speedArtifact = artifactStorage.find(item => item.name === '세호로리의 시간가속기');
             if (speedArtifact) {
                 const lv = speedArtifact.level || 1;
             const map = { 1: 0.10, 2: 0.25, 3: 0.50 };
                 totalReduction += map[lv] || 0.10;
             }
             
             // 속도 포션 효과
             const speedBuff = activeBuffs.find(b => b.type === 'speed' && b.endTime > Date.now());
             if (speedBuff) {
                 const buffReduction = [0.075, 0.15, 0.30][speedBuff.level - 1];
                 totalReduction += buffReduction;
             }
             
             // 1339포션 효과 (15~50% 랜덤 감소)
             const speedBoostBuff = activeBuffs.find(b => b.type === 'speed_boost' && b.endTime > Date.now());
             if (speedBoostBuff) {
                 const randomReduction = 0.15 + Math.random() * 0.35; // 15%~50%
                 totalReduction += randomReduction;
             }
             
             return Math.max(8, Math.round(base * (1 - totalReduction)));
         }
        
        function getSpecialEffectBonus(participantName) {
            // 해당 세호의 부적만 적용
            const amuletName = `${participantName}의 부적`;
            const artifact = artifactStorage.find(item => item.name === amuletName);
            
            if (!artifact) return 0;
            
            // 레벨별 특별효과 확률 증가: 10%, 30%, 50%
            const level = artifact.level;
            if (level === 1) return 0.10; // 10%
            if (level === 2) return 0.30; // 30%
            if (level === 3) return 0.50; // 50%
            return 0;
        }
        
        function getRainbowBonus() {
            const artifact = artifactStorage.find(item => item.name === '세호로리의 무지갯빛 보석');
            if (!artifact) return 0;
            
            return artifact.level * 0.75; // 레벨당 75% 증가
        }
        
        // 사용 가능한 유물 목록 반환 (3레벨 달성한 유물 제외)
        function getAvailableArtifacts() {
            const allArtifacts = [
                '세호로리의 부적', '세호퍼리의 부적', '세호게이의 부적',
                '마죠이스트세호의 부적', '씹덕세호의 부적', 'TS세호의 부적',
                '쇼타세호의 부적', '에겐세호의 부적', '니거세호의 부적',
                '세호로리의 시간가속기', '세호로리의 7목걸이',
                '세호로리의 유물석', '세호로리의 무지갯빛 보석',
                '세호로리의 신성한 망치', '세호로리의 트럼프카드'
            ];
            
            return allArtifacts.filter(artifactName => {
                const artifact = artifactStorage.find(item => item.name === artifactName);
                return !artifact || artifact.level < 3;
            });
        }

        // 보관소 전체 삭제
        function clearStorage() {
            if (confirm('보관소를 모두 삭제하시겠습니까?')) {
                storage = [];
                updateStorageDisplay();
            }
        }

        // 확률표 업데이트
        function updateProbabilityTable() {
            const content = document.getElementById('probabilityContent');
            
      if (participants.length === 0) {
                content.innerHTML = '<p>참가자가 없습니다.</p>';
        return;
      }

            // 유물 및 포션 효과가 적용된 참가자 목록 사용
            const effectiveParticipants = getEffectiveParticipants();
            const totalWeight = effectiveParticipants.reduce((sum, p) => sum + p.weight, 0);
            
            // 확률순으로 정렬 (높은 확률부터)
            const sortedParticipants = [...effectiveParticipants].sort((a, b) => b.weight - a.weight);
            
            let listHTML = '<div class="probability-list" id="probListBelow">';
            
            sortedParticipants.forEach(participant => {
                const probNum = (participant.weight / totalWeight) * 100;
                const probability = formatFiniteOrEllipsis(probNum);
                if (participant.name === '꽝') {
                    // 원래 꽝 확률 계산
                    const originalMiss = participants.find(p => p.name === '꽝');
                    const originalTotal = participants.reduce((sum, p) => sum + p.weight, 0);
                    const originalProbNum = (originalMiss.weight / originalTotal) * 100;
                    
                    // 감소량 계산
                    const reduction = originalProbNum - probNum;
                    const displayText = reduction > 0 
                        ? `${formatFiniteOrEllipsis(originalProbNum)}% <span class="artifact-effect">(-${formatFiniteOrEllipsis(reduction)}%)</span>`
                        : `${probability}%`;
                    
                    listHTML += `
                    <div class="probability-item no-hover">
                        <span class="participant-name">${participant.name}</span>
                        <span class="probability-value">${displayText}</span>
                    </div>`;
                    return;
                }
                
                // 유물 효과 적용
                const specialEffectBonus = getSpecialEffectBonus(participant.name);
                const rainbowBonus = getRainbowBonus();
                
                const rainbowProbability = formatFiniteOrEllipsis(probNum * 0.0002 * (1 + rainbowBonus));
                const diamondProbability = formatFiniteOrEllipsis(probNum * 0.002 * (1 + specialEffectBonus));
                const goldenProbability = formatFiniteOrEllipsis(probNum * 0.01 * (1 + specialEffectBonus));
                const shiningProbability = formatFiniteOrEllipsis(probNum * 0.2 * (1 + specialEffectBonus));
                const sparklingProbability = formatFiniteOrEllipsis(probNum * 0.05 * (1 + specialEffectBonus));
                
                listHTML += `
                    <div class="probability-item">
                        <span class="participant-name">${participant.name}</span>
                        <span class="probability-value">${probability}%</span>
                        <div class="shining-info">
                            <div class="effect-title">
                                <span>✨</span>
                                <span>특별 효과 확률</span>
                            </div>
                            <div class="effect-probability">
                                ✨ 빛나는 ${participant.name}: ${shiningProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.2 * specialEffectBonus)}%)</span>
                                <small>(뽑힌 후 20% 확률)</small>
                            </div>
                            <div class="effect-probability">
                                ⚡ 번쩍이는 ${participant.name}: ${sparklingProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.05 * specialEffectBonus)}%)</span>
                                <small>(뽑힌 후 5% 확률)</small>
                            </div>
                            <div class="effect-probability">
                                🏆 황금색 ${participant.name}: ${goldenProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.01 * specialEffectBonus)}%)</span>
                                <small>(뽑힌 후 1% 확률)</small>
                            </div>
                            <div class="effect-probability">
                                💎 다이아몬드색 ${participant.name}: ${diamondProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.002 * specialEffectBonus)}%)</span>
                                <small>(뽑힌 후 0.2% 확률)</small>
                            </div>
                            <div class="effect-probability">
                                🌈 무지갯빛 ${participant.name}: ${rainbowProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.0002 * rainbowBonus)}%)</span>
                                <small>(뽑힌 후 0.02% 확률)</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listHTML += '</div>';
            content.innerHTML = listHTML;
            attachProbabilityToggle('probListMain');
        }

         // 도트 상태 업데이트 (뽑기 횟수에 따른 잠금 해제)
         function updateDotStates() {
             // 아이템 보관소 (0번): 150회 이상
             const dot0 = document.getElementById('dot-0');
             if (totalDraws >= 150) {
                 dot0.classList.remove('locked');
             } else {
                 dot0.classList.add('locked');
             }
             
             // 상점 (1번): 150회 이상
             const dot1 = document.getElementById('dot-1');
             if (totalDraws >= 150) {
                 dot1.classList.remove('locked');
             } else {
                 dot1.classList.add('locked');
             }
             
             // 유물 뽑기 (5번): 50회 이상
             const dot5 = document.getElementById('dot-5');
             if (totalDraws >= 50) {
                 dot5.classList.remove('locked');
             } else {
                 dot5.classList.add('locked');
             }
             
             // 유물 컬렉션 (6번): 50회 이상
             const dot6 = document.getElementById('dot-6');
             if (totalDraws >= 50) {
                 dot6.classList.remove('locked');
             } else {
                 dot6.classList.add('locked');
             }
        }

        // 화면 전환
        function goToScreen(screenIndex) {
             // 뽑기 횟수 제한 확인
             if (screenIndex === 0 && totalDraws < 150) {
                 alert('아이템 보관소는 150회 뽑기 이상부터 이용할 수 있습니다!');
                 return;
             }
             
             if (screenIndex === 1 && totalDraws < 150) {
                 alert('상점은 150회 뽑기 이상부터 이용할 수 있습니다!');
                 return;
             }
             
             if (screenIndex === 5 && totalDraws < 50) {
                 alert('유물 뽑기는 50회 뽑기 이상부터 이용할 수 있습니다!');
                 return;
             }
             
             if (screenIndex === 6 && totalDraws < 50) {
                 alert('유물 컬렉션은 50회 뽑기 이상부터 이용할 수 있습니다!');
                 return;
             }
             
            currentScreen = screenIndex;
            const container = document.getElementById('mainContainer');
            container.style.transform = `translateX(-${screenIndex * 100}vw)`;
            
            // 도트 업데이트
            document.querySelectorAll('.dot').forEach((dot, index) => {
                dot.classList.toggle('active', index === screenIndex);
            });
            if (screenIndex === 0) {
                 updateItemStorageDisplay();
            } else if (screenIndex === 2) {
                 updateProbabilityTable();
            } else if (screenIndex === 4) {
                 updateStorageDisplay();
             } else if (screenIndex === 6) {
                initArtifactCarousel();
            }
        }

        // 터치 이벤트 처리
        document.addEventListener('touchstart', function(e) {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', function(e) {
            if (!startX || !startY) return;
            
            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            const diffX = startX - endX;
            const diffY = startY - endY;
            
            // 수평 스와이프가 수직 스와이프보다 클 때만 처리
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                if (diffX > 0) {
                    // 왼쪽으로 스와이프 (다음 화면)
                    if (currentScreen < 6) {
                        goToScreen(currentScreen + 1);
                    }
                } else {
                    // 오른쪽으로 스와이프 (이전 화면)
                    if (currentScreen > 0) {
                        goToScreen(currentScreen - 1);
                    }
                }
            }
            
            startX = 0;
            startY = 0;
        });

        // 아래 패널 렌더링
        function renderBelowProbability() {
            const probHost = document.getElementById('sehoProbBelow');
            if (!probHost) return;
            const pool = getEffectiveParticipants();
            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            const sortedParticipants = [...pool].sort((a, b) => b.weight - a.weight);
            let listHTML = '<div class="probability-list">';
            sortedParticipants.forEach(participant => {
                const probNum = (participant.weight / totalWeight) * 100;
                const probability = formatFiniteOrEllipsis(probNum);
                if (participant.name === '꽝') {
                    // 꽝 확률에 유물 효과 적용
                    const missReduction = getMissReduction();
                    const missProbability = Math.max(0, probNum - missReduction);
                    const missDisplay = missReduction > 0 ? `${formatFiniteOrEllipsis(missProbability)}% <span class="artifact-effect">(-${formatFiniteOrEllipsis(missReduction)}%)</span>` : `${probability}%`;
                    
                    listHTML += `
                    <div class="probability-item no-hover">
                        <span class="participant-name">${participant.name}</span>
                        <span class="probability-value">${missDisplay}</span>
                    </div>`;
                    return;
                }
                
                // 유물 효과 적용
                const specialEffectBonus = getSpecialEffectBonus(participant.name);
                const rainbowBonus = getRainbowBonus();
                
                const rainbowProbability = formatFiniteOrEllipsis(probNum * 0.0002 * (1 + rainbowBonus));
                const diamondProbability = formatFiniteOrEllipsis(probNum * 0.002 * (1 + specialEffectBonus));
                const goldenProbability = formatFiniteOrEllipsis(probNum * 0.01 * (1 + specialEffectBonus));
                const shiningProbability = formatFiniteOrEllipsis(probNum * 0.2 * (1 + specialEffectBonus));
                const sparklingProbability = formatFiniteOrEllipsis(probNum * 0.05 * (1 + specialEffectBonus));
                
                listHTML += `
                    <div class="probability-item">
                        <span class="participant-name">${participant.name}</span>
                        <span class="probability-value">${probability}%</span>
                        <div class="shining-info">
                            <div class="effect-title">
                                <span>✨</span>
                                <span>특별 효과 확률</span>
                            </div>
                            <div class="effect-probability">
                                ✨ 빛나는 ${participant.name}: ${shiningProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.2 * specialEffectBonus)}%)</span>
                                <small>(뽑힌 후 20% 확률)</small>
                            </div>
                            <div class="effect-probability">
                                ⚡ 번쩍이는 ${participant.name}: ${sparklingProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.05 * specialEffectBonus)}%)</span>
                                <small>(뽑힌 후 5% 확률)</small>
                            </div>
                            <div class="effect-probability">
                                🏆 황금색 ${participant.name}: ${goldenProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.01 * specialEffectBonus)}%)</span>
                                <small>(뽑힌 후 1% 확률)</small>
                            </div>
                            <div class="effect-probability">
                                💎 다이아몬드색 ${participant.name}: ${diamondProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.002 * specialEffectBonus)}%)</span>
                                <small>(뽑힌 후 0.2% 확률)</small>
                            </div>
                            <div class="effect-probability">
                                🌈 무지갯빛 ${participant.name}: ${rainbowProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.0002 * rainbowBonus)}%)</span>
                                <small>(뽑힌 후 0.02% 확률)</small>
                            </div>
                        </div>
                    </div>`;
            });
            listHTML += '</div>';
            probHost.innerHTML = listHTML;
            attachProbabilityToggle('probListBelow');
        }

        function openBottomPanel(which) {
            if (which === 'seho') {
                const panel = document.getElementById('sehoBottomPanel');
                if (panel) {
                    panel.style.display = 'block';
                    renderBelowProbability();
                    updateStorageDisplay();
                }
            } else if (which === 'arti') {
                const panel = document.getElementById('artiBottomPanel');
                const gridBelow = document.getElementById('artifactGridBelow');
                if (panel) {
                    panel.style.display = 'block';
                    if (gridBelow) {
                        gridBelow.innerHTML = '';
                        for (let i = 1; i <= 30; i++) {
                            const cell = document.createElement('div');
                            cell.className = 'artifact-cell locked';
                            cell.textContent = `슬롯 ${i}`;
                            gridBelow.appendChild(cell);
                        }
                    }
                    updateStorageDisplay();
                }
                const topGrid = document.getElementById('artifactCollection');
                if (topGrid) topGrid.style.display = 'none';
            }
        }

        function closeBottomPanels() {
            const seho = document.getElementById('sehoBottomPanel');
            const arti = document.getElementById('artiBottomPanel');
            if (seho) seho.style.display = 'none';
            if (arti) arti.style.display = 'none';
        }

        // 키보드 이벤트 처리 (컴퓨터용)
        document.addEventListener('keydown', function(e) {
            // 화살표 키로 화면 전환
            if (e.key === 'ArrowLeft') {
                // 왼쪽 화살표 - 이전 화면
                if (currentScreen > 0) {
                    goToScreen(currentScreen - 1);
                }
            } else if (e.key === 'ArrowRight') {
                // 오른쪽 화살표 - 다음 화면
                if (currentScreen < 6) {
                    goToScreen(currentScreen + 1);
                }
            }
        });

        // 특별 효과 함수들
        function createConfetti() {
            const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                
                document.body.appendChild(confetti);
                
                // 5초 후 제거
                setTimeout(() => {
                    if (confetti.parentNode) {
                        confetti.parentNode.removeChild(confetti);
                    }
                }, 5000);
            }
        }

        function playGoldenSound() {
            // 황금색 사운드 효과 (Web Audio API 사용)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playDiamondSound() {
            // 다이아몬드색 사운드 효과 (더 고급스러운 소리)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator1 = audioContext.createOscillator();
                const oscillator2 = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator1.connect(gainNode);
                oscillator2.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // 하모니를 이루는 두 음
                oscillator1.frequency.setValueAtTime(880, audioContext.currentTime); // A5
                oscillator2.frequency.setValueAtTime(1108.73, audioContext.currentTime); // C#6
                
                oscillator1.frequency.setValueAtTime(1046.5, audioContext.currentTime + 0.1); // C6
                oscillator2.frequency.setValueAtTime(1318.51, audioContext.currentTime + 0.1); // E6
                
                oscillator1.frequency.setValueAtTime(1174.66, audioContext.currentTime + 0.2); // D6
                oscillator2.frequency.setValueAtTime(1479.98, audioContext.currentTime + 0.2); // F#6
                
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
                
                oscillator1.start(audioContext.currentTime);
                oscillator2.start(audioContext.currentTime);
                oscillator1.stop(audioContext.currentTime + 0.8);
                oscillator2.stop(audioContext.currentTime + 0.8);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playRainbowSound() {
            // 무지갯빛 사운드 효과 (반짝이는 상승 아르페지오)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const gain = audioContext.createGain();
                gain.connect(audioContext.destination);
                gain.gain.setValueAtTime(0.28, audioContext.currentTime);
                const freqs = [659.25, 783.99, 987.77, 1318.51, 1567.98, 1975.53];
                freqs.forEach((f, i) => {
                    const o = audioContext.createOscillator();
                    o.type = 'triangle';
                    o.frequency.setValueAtTime(f, audioContext.currentTime + i * 0.07);
                    o.connect(gain);
                    const start = audioContext.currentTime + i * 0.07;
                    o.start(start);
                    o.stop(start + 0.22);
                });
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        // 강화 관련 사운드 함수들 (대장장이 망치 느낌)
        function playEnhanceStartSound() {
            // 강화 시작 사운드 (망치 내려치는 소리)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator1 = audioContext.createOscillator();
                const oscillator2 = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator1.connect(gainNode);
                oscillator2.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // 낮은 음과 높은 음의 조합으로 금속 충돌감 표현
                oscillator1.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator2.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator1.type = 'sawtooth';
                oscillator2.type = 'square';
                
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                
                oscillator1.start(audioContext.currentTime);
                oscillator2.start(audioContext.currentTime);
                oscillator1.stop(audioContext.currentTime + 0.15);
                oscillator2.stop(audioContext.currentTime + 0.15);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playEnhanceSuccessSound() {
            // 강화 성공 사운드 (간단한 성공음)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.12, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playEnhanceFailSound() {
            // 강화 실패 사운드 (간단한 실패음)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playEnhanceDestroySound() {
            // 강화 파괴 사운드 (간단한 파괴음)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(80, audioContext.currentTime);
                oscillator.type = 'sawtooth';
                
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.25);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.25);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playMaxEnhanceSuccessSound() {
            // 5강 성공 특별 사운드 (간단한 "띤" 소리)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // 간단한 "띤" 소리
                oscillator.frequency.setValueAtTime(1046.50, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function startPlaytimeTicker() {
            if (playtimeTimer) clearInterval(playtimeTimer);
            playtimeTimer = setInterval(() => {
                const pt = document.getElementById('statPlaytime');
                if (pt) {
                    const currentTime = Date.now();
                    const totalPlaytime = currentTime - startTime - pausedTime;
                    pt.textContent = formatElapsedTime(totalPlaytime);
                }
            }, 1000);
        }

        function formatElapsedTime(ms) {
            const totalSec = Math.max(0, Math.floor(ms / 1000));
            const h = String(Math.floor(totalSec / 3600)).padStart(2, '0');
            const m = String(Math.floor((totalSec % 3600) / 60)).padStart(2, '0');
            return `${h}:${m}`;
        }

        // 페이지 가시성 변경 처리
        function handleVisibilityChange() {
            if (document.hidden) {
                // 페이지가 숨겨졌을 때 - 일시정지 시간 기록
                lastPauseTime = Date.now();
            } else {
                // 페이지가 다시 보일 때 - 일시정지된 시간을 누적
                if (lastPauseTime > 0) {
                    pausedTime += Date.now() - lastPauseTime;
                    lastPauseTime = 0;
                }
            }
        }

        // 페이지 가시성 이벤트 리스너 등록
        document.addEventListener('visibilitychange', handleVisibilityChange);

        // ========== 상점 시스템 ==========
        
        // 상점 초기화
        function initShop() {
            const now = Date.now();
            
            // 저장된 상점 데이터가 없거나 갱신 시간이 지났을 때만 갱신
            if (shopItems.length === 0 || now >= shopRefreshTime) {
                refreshShop();
            } else {
                // 저장된 상점 데이터가 있으면 화면 업데이트만
                updateShopDisplay();
            }
            
            // 타이머 시작
            startShopTimer();
        }
        
        // 상점 물품 갱신 (랜덤 3개 선택)
        function refreshShop() {
            const now = Date.now();
            shopRefreshTime = now + 30 * 60 * 1000; // 30분 후
            
            shopItems = [];
            purchasedInCurrentShop = []; // 구매 기록 초기화
            
            // 등급별 확률: 일반 45%, 희귀 27.5%, 레어 17.5%, 영웅 7.5%, 전설 2.5%
            const rarityProbabilities = {
                'common': 45,
                'rare': 27.5,
                'epic': 17.5,
                'hero': 7.5,
                'legendary': 2.5
            };
            
            // 등급별 확률에 따라 3개 선택
            for (let i = 0; i < 3; i++) {
                // 1단계: 등급 선택
                const random = Math.random() * 100;
                let selectedRarity = 'common';
                let cumulative = 0;
                
                for (const [rarity, probability] of Object.entries(rarityProbabilities)) {
                    cumulative += probability;
                    if (random <= cumulative) {
                        selectedRarity = rarity;
                        break;
                    }
                }
                
                // 2단계: 해당 등급의 아이템 중에서 랜덤 선택
                const availableItems = allShopItems.filter(item => {
                    // 구매 가능한 아이템만 필터링
                    if (item.oneTime && purchasedThemes.includes(item.name)) {
                        return false;
                    }
                    return item.rarity === selectedRarity;
                });
                
                if (availableItems.length === 0) {
                    // 해당 등급에 아이템이 없으면 일반 등급으로 대체
                    const commonItems = allShopItems.filter(item => {
                        if (item.oneTime && purchasedThemes.includes(item.name)) {
                            return false;
                        }
                        return item.rarity === 'common';
                    });
                    if (commonItems.length > 0) {
                        const randomIndex = Math.floor(Math.random() * commonItems.length);
                        const selectedItem = commonItems[randomIndex];
                        
                        // 포션인 경우 개수 랜덤 결정
                        if (selectedItem.type === 'potion') {
                            const qty = Math.floor(Math.random() * (selectedItem.maxQty - selectedItem.minQty + 1)) + selectedItem.minQty;
                            shopItems.push({
                                ...selectedItem,
                                quantity: qty,
                                displayName: `${selectedItem.name} x${qty}`,
                                totalPrice: selectedItem.price * qty
                            });
                        } else {
                            shopItems.push({
                                ...selectedItem,
                                quantity: 1,
                                displayName: selectedItem.name,
                                totalPrice: selectedItem.price
                            });
                        }
                    }
                    continue;
                }
                
                // 해당 등급의 아이템 중에서 랜덤 선택
                const randomIndex = Math.floor(Math.random() * availableItems.length);
                const selectedItem = availableItems[randomIndex];
                
                // 포션인 경우 개수 랜덤 결정
                if (selectedItem.type === 'potion') {
                    const qty = Math.floor(Math.random() * (selectedItem.maxQty - selectedItem.minQty + 1)) + selectedItem.minQty;
                    shopItems.push({
                        ...selectedItem,
                        quantity: qty,
                        displayName: `${selectedItem.name} x${qty}`,
                        totalPrice: selectedItem.price * qty
                    });
                } else {
                    shopItems.push({
                        ...selectedItem,
                        quantity: 1,
                        displayName: selectedItem.name,
                        totalPrice: selectedItem.price
                    });
                }
            }
            
            updateShopDisplay();
            saveState();
        }
        
        // 상점 화면 업데이트
        function updateShopDisplay() {
            const container = document.getElementById('shopItems');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (shopItems.length === 0) {
                // 물품이 없을 때
                for (let i = 0; i < 3; i++) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'shop-item';
                    itemDiv.innerHTML = `
                        <div class="shop-item-name">???</div>
                        <div class="shop-item-desc">물품을 준비중입니다...</div>
                        <div class="shop-item-price">??? 세호코인</div>
                    `;
                    container.appendChild(itemDiv);
                }
            } else {
                // 물품 표시
                shopItems.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    // 등급에 따른 클래스 추가
                    const rarityClass = item.rarity || 'common';
                    const isSoldOut = purchasedInCurrentShop.includes(index);
                    itemDiv.className = `shop-item ${rarityClass}${isSoldOut ? ' sold-out' : ''}`;
                    
                     // 아이템 설명 생성
                     let description = '';
                     if (item.type === 'potion') {
                         if (item.effect === 'luck') {
                             const reduction = [5, 10, 20][item.level - 1];
                             description = `5분동안 꽝 확률 ${reduction}% 감소`;
                         } else if (item.effect === 'speed') {
                             const reduction = [7.5, 15, 30][item.level - 1];
                             description = `5분동안 뽑기 속도 ${reduction}% 감소`;
                         } else if (item.effect === 'speed_boost') {
                             description = `10분동안 뽑기 속도 15~50% 감소`;
                         }
                     } else if (item.type === 'theme') {
                         description = `배경 테마 변경 (1회 구매)`;
                     } else if (item.type === 'special') {
                         if (item.effect === 'guaranteed_special') {
                             description = `다음 뽑기에서 특별효과 확률 20%로 고정 (꽝 시 횟수 감소 안됨)`;
                         } else if (item.effect === 'remove_cooldown') {
                             description = `다음 50회 뽑기 쿨타임 삭제`;
                         } else if (item.effect === 'refresh_shop') {
                             description = `3회까지 사용가능 / 사용시 즉시 상점 갱신`;
                         } else if (item.effect === 'lucky_box') {
                             description = `행운포션Ⅱ 1~10개, 속도포션Ⅱ 1~10개 획득`;
                         } else if (item.effect === 'name_converter') {
                             description = `보관소 세호 3개의 이름 변경`;
                         }
                     }
                    
                    itemDiv.innerHTML = `
                        <div class="shop-item-name">${item.displayName || item.name}</div>
                        <div class="shop-item-desc">${description}</div>
                        <div class="shop-item-price">${item.totalPrice || item.price} 세호코인</div>
                        ${isSoldOut ? '<div class="sold-out-label">SOLD OUT</div>' : ''}
                    `;
                    
                    if (!isSoldOut) {
                        itemDiv.onclick = () => buyShopItem(item, index);
                    }
                    
                    container.appendChild(itemDiv);
                });
                
                // 3개 미만이면 빈 슬롯 추가
                for (let i = shopItems.length; i < 3; i++) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'shop-item';
                    itemDiv.innerHTML = `
                        <div class="shop-item-name">???</div>
                        <div class="shop-item-desc">물품을 준비중입니다...</div>
                        <div class="shop-item-price">??? 세호코인</div>
                    `;
                    container.appendChild(itemDiv);
                }
            }
        }
        
        // 상점 아이템 구매
        function buyShopItem(item, itemIndex) {
            const cost = item.totalPrice || item.price;
            
            // 이미 구매한 아이템인지 확인
            if (purchasedInCurrentShop.includes(itemIndex)) {
                alert('이미 구매한 아이템입니다!');
                return;
            }
            
            // 세호코인 확인
            if (sehoCoin < cost) {
                alert(`세호코인이 부족합니다! (필요: ${cost}, 보유: ${sehoCoin})`);
                return;
            }
            
            // 구매 확인
            if (!confirm(`${item.displayName || item.name}을(를) ${cost} 세호코인에 구매하시겠습니까?`)) {
                return;
            }
            
            // 세호코인 차감
            sehoCoin -= cost;
            updateCoinDisplay();
            
            // 구매 기록 추가
            purchasedInCurrentShop.push(itemIndex);
            
             // 아이템 타입에 따라 처리
             if (item.type === 'potion') {
                 // 포션은 아이템 보관소에 추가
                 addToItemStorage(item.name, item.quantity);
                 alert(`${item.displayName}을(를) 구매했습니다! 아이템 보관소를 확인하세요.`);
              } else if (item.type === 'theme') {
                  // 테마는 구매 목록에 추가
                  if (!purchasedThemes.includes(item.name)) {
                      purchasedThemes.push(item.name);
                      // 테마 선택기 업데이트
                      initThemeSelector();
                  }
                  alert(`${item.name}을(를) 구매했습니다! 설정에서 테마를 변경할 수 있습니다.`);
              } else if (item.type === 'special') {
                  if (item.effect === 'guaranteed_special') {
                      // 용사의 심판
                      specialItemCount += item.quantity;
                      alert(`${item.name}을(를) 구매했습니다! 다음 뽑기에서 특별효과가 적용됩니다.`);
                  } else {
                      // 기타 특수 아이템들은 아이템 보관소에 추가
                      addToItemStorage(item.name, item.quantity);
                      alert(`${item.displayName}을(를) 구매했습니다! 아이템 보관소를 확인하세요.`);
                  }
              }
            
            // 화면 갱신
            updateShopDisplay();
            saveState();
        }
        
        // 상점 타이머 시작
        function startShopTimer() {
            if (shopTimerInterval) clearInterval(shopTimerInterval);
            
            shopTimerInterval = setInterval(() => {
                const now = Date.now();
                const remaining = Math.max(0, shopRefreshTime - now);
                
                if (remaining === 0) {
                    // 시간이 다 되면 상점 갱신
                    refreshShop();
                }
                
                // 타이머 표시 업데이트
                updateShopTimer(remaining);
            }, 1000);
        }
        
        // 상점 타이머 표시 업데이트
        function updateShopTimer(remainingMs) {
            const timerEl = document.getElementById('shopTimer');
            if (!timerEl) return;
            
            const totalSec = Math.floor(remainingMs / 1000);
            const minutes = Math.floor(totalSec / 60);
            const seconds = totalSec % 60;
            
            timerEl.textContent = `갱신까지: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // ========== 아이템 보관소 시스템 ==========
        
        let itemStorage = []; // 아이템 보관소 (나중에 구현)
        
        // 아이템 보관소 화면 업데이트
        function updateItemStorageDisplay() {
            const storageList = document.getElementById('itemStorageList');
            if (!storageList) return;
            
            if (itemStorage.length === 0) {
                storageList.innerHTML = '<p>아이템이 없습니다.</p>';
                return;
            }

            // 아이템 목록 생성
            let html = '';
            itemStorage.forEach((item, index) => {
                const name = item.name || '???';
                const count = item.count || 1;
                const date = item.date || '';
                const time = item.time || '';
                
                html += `
                    <div class="storage-item" data-index="${index}" style="cursor: pointer;">
                        <div class="storage-item-header">
                            <span class="storage-item-name">${name}</span>
                            <span class="storage-item-count">x${count}</span>
                        </div>
                        <div class="storage-item-info">
                            <span class="storage-item-date">${date} ${time}</span>
                        </div>
                    </div>
                `;
            });
            
            storageList.innerHTML = html;
            
            // 클릭 이벤트 추가
            storageList.querySelectorAll('.storage-item').forEach((itemEl) => {
                itemEl.addEventListener('click', () => {
                    const index = parseInt(itemEl.getAttribute('data-index'));
                    useItemFromStorage(index);
                });
            });
        }

        // ========== 세호코인 & 버프 시스템 ==========
        
        // 세호코인 표시 업데이트
        function updateCoinDisplay() {
            const coinEl = document.getElementById('coinAmount');
            if (coinEl) {
                coinEl.textContent = sehoCoin.toLocaleString();
            }
        }

        // 버프 표시 업데이트
        function updateBuffDisplay() {
            const container = document.getElementById('buffContainer');
            if (!container) return;
            
            container.innerHTML = '';
            const now = Date.now();
            
            activeBuffs.forEach((buff, index) => {
                const remaining = Math.max(0, buff.endTime - now);
                if (remaining === 0) return; // 만료된 버프는 표시하지 않음
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                const timeStr = `${minutes}:${String(seconds).padStart(2, '0')}`;
                
                const buffDiv = document.createElement('div');
                buffDiv.className = `buff-icon ${buff.type}`;
                buffDiv.innerHTML = `
                    <div class="buff-name">${buff.type === 'luck' ? '행운' : '속도'}${buff.level}</div>
                    <div class="buff-timer">${timeStr}</div>
                `;
                buffDiv.title = `${buff.type === 'luck' ? '행운포션' : '속도포션'}Ⅰ`.repeat(buff.level) + '\n남은 시간: ' + timeStr;
                container.appendChild(buffDiv);
            });
        }

        // 버프 타이머 시작
        let buffTimerInterval = null;
        function startBuffTimer() {
            if (buffTimerInterval) clearInterval(buffTimerInterval);
            
            buffTimerInterval = setInterval(() => {
                const now = Date.now();
                // 만료된 버프 제거
                activeBuffs = activeBuffs.filter(buff => buff.endTime > now);
                updateBuffDisplay();
                saveState();
            }, 1000);
        }

         // 포션 사용
         function usePotion(type, level) {
             // 같은 타입의 다른 레벨 포션이 이미 활성화되어 있는지 확인
             const existingSameBuff = activeBuffs.find(b => b.type === type);
             if (existingSameBuff) {
                 alert('이미 같은 효과의 포션을 사용 중입니다!');
                 return false;
             }
             
             const now = Date.now();
             let duration = 5 * 60 * 1000; // 기본 5분
             
             // 1339포션은 10분
             if (type === 'speed_boost') {
                 duration = 10 * 60 * 1000;
             }
             
             // 같은 포션이 있으면 시간만 연장
             const existing = activeBuffs.find(b => b.type === type && b.level === level);
             if (existing) {
                 existing.endTime = Math.max(existing.endTime, now) + duration;
             } else {
                 activeBuffs.push({
                     type: type,
                     level: level,
                     endTime: now + duration
                 });
             }
             
             updateBuffDisplay();
             saveState();
             return true;
         }

         // 특수 아이템 사용
         function useSpecialItem(effect, item) {
             if (effect === 'remove_cooldown') {
                 // 주말 효과
                 noCooldownCount += 50;
                 alert('주말을 사용했습니다! 다음 50회 뽑기에서 쿨타임이 삭제됩니다.');
                 return true;
             } else if (effect === 'refresh_shop') {
                 // 보조배터리 효과
                 if (item.usesLeft === undefined) {
                     item.usesLeft = 3;
                 }
                 if (item.usesLeft > 0) {
                     item.usesLeft--;
                     refreshShop();
                     alert(`보조배터리를 사용했습니다! 상점이 갱신되었습니다. (남은 사용 횟수: ${item.usesLeft})`);
                     return true;
                 } else {
                     alert('보조배터리의 사용 횟수가 모두 소모되었습니다!');
                     return false;
                 }
             } else if (effect === 'lucky_box') {
                 // 럭키박스 효과
                 const luckCount = Math.floor(Math.random() * 10) + 1;
                 const speedCount = Math.floor(Math.random() * 10) + 1;
                 
                 addToItemStorage('행운포션Ⅱ', luckCount);
                 addToItemStorage('속도포션Ⅱ', speedCount);
                 
                 // 화면 상단에 결과 표시
                 showLuckyBoxResult(luckCount, speedCount);
                 alert(`럭키박스를 사용했습니다! 행운포션Ⅱ ${luckCount}개, 속도포션Ⅱ ${speedCount}개를 획득했습니다!`);
                 return true;
             } else if (effect === 'name_converter') {
                 // 쓸데없는 변환기 효과
                 convertSehoNames();
                 alert('쓸데없는 변환기를 사용했습니다! 보관소의 세호 3개의 이름이 바뀝니다.');
                 return true;
             }
             return false;
         }

        // 아이템 보관소에 아이템 추가
        function addToItemStorage(itemName, quantity = 1) {
            const now = new Date();
            const existing = itemStorage.find(item => item.name === itemName);
            
            if (existing) {
                existing.count += quantity;
                existing.date = now.toLocaleDateString('ko-KR');
                existing.time = now.toLocaleTimeString('ko-KR');
            } else {
                itemStorage.push({
                    name: itemName,
                    count: quantity,
                    date: now.toLocaleDateString('ko-KR'),
                    time: now.toLocaleTimeString('ko-KR')
                });
            }
            
            updateItemStorageDisplay();
            saveState();
        }

         // 아이템 보관소에서 아이템 사용
         function useItemFromStorage(index) {
             if (index < 0 || index >= itemStorage.length) return;
             
             const item = itemStorage[index];
             const itemData = allShopItems.find(si => si.name === item.name);
             
             if (!itemData) return;
             
             if (itemData.type === 'potion') {
                 if (usePotion(itemData.effect, itemData.level)) {
                     item.count--;
                     if (item.count <= 0) {
                         itemStorage.splice(index, 1);
                     }
                     updateItemStorageDisplay();
                     saveState();
                     alert(`${item.name}을(를) 사용했습니다!`);
                 }
             } else if (itemData.type === 'special') {
                 if (useSpecialItem(itemData.effect, item)) {
                     item.count--;
                     if (item.count <= 0) {
                         itemStorage.splice(index, 1);
                     }
                     updateItemStorageDisplay();
                     saveState();
                 }
             }
         }

        // 세호 판매 함수
        function sellItem(index, event) {
            event.stopPropagation(); // 이벤트 버블링 방지
            
            if (index < 0 || index >= storage.length) return;
            
            const item = storage[index];
            const sellPrice = calculateSellPrice(item, 1); // 하나씩만 판매
            
            if (!confirm(`판매하시겠습니까? (${sellPrice} 세호코인, 소수점 반올림됨)`)) {
                return;
            }
            
            // 개수가 1개 이상이면 1개만 감소, 아니면 아이템 제거
            if ((item.count || 1) > 1) {
                item.count -= 1;
            } else {
                storage.splice(index, 1);
            }
            
            // 세호코인 증가
            sehoCoin += sellPrice;
            
            // 화면 업데이트
            updateStorageDisplay();
            updateCoinDisplay();
            saveState();
            
            alert(`${item.name}을(를) ${sellPrice} 세호코인에 판매했습니다!`);
        }

        // 세호 판매 가격 계산
        function calculateSellPrice(item, sellCount = 1) {
            let basePrice;
            
            // 특수 효과별 기본 가격
            if (item.effectType === 'rainbow') {
                basePrice = 20000; // 무지갯빛 특별효과
            } else if (item.effectType === 'diamond') {
                basePrice = 1250; // 다이아몬드색 특별효과
            } else if (item.effectType === 'golden') {
                basePrice = 200; // 황금색 특별효과
            } else if (item.effectType === 'sparkling') {
                basePrice = 30; // 번쩍이는 특별효과
            } else if (item.effectType === 'shining') {
                basePrice = 5; // 빛나는 특별효과
            } else {
                basePrice = 1; // 일반종류 모든 세호
            }
            
            // 강화 단계별 가격 배수 적용
            const enhanceLevel = item.enhanceLevel || 0;
            if (enhanceLevel === 1) {
                basePrice *= 1.1; // 1강: 1.1배
            } else if (enhanceLevel === 2) {
                basePrice *= 1.25; // 2강: 1.25배
            } else if (enhanceLevel === 3) {
                basePrice *= 1.5; // 3강: 1.5배
            } else if (enhanceLevel === 4) {
                basePrice *= 2; // 4강: 2배
            } else if (enhanceLevel === 5) {
                basePrice *= 4; // 5강: 4배
            }
            
            // 판매 개수만큼 가격 증가
            basePrice *= sellCount;
            
            // 소수점 반올림
            return Math.round(basePrice);
        }

        // ========== 테마 시스템 ==========
        
        // 테마 선택기 초기화
        function initThemeSelector() {
            const selector = document.getElementById('themeSelector');
            if (!selector) return;
            
            // 기존 버튼들 제거
            selector.innerHTML = '';
            
            // 기본 테마 (항상 사용 가능)
            const defaultButton = createThemeButton('default', '기본');
            selector.appendChild(defaultButton);
            
            // 구매한 테마들만 추가
            purchasedThemes.forEach(themeName => {
                const themeColor = themeName.replace('테마_', '');
                const button = createThemeButton(themeColor, themeColor);
                selector.appendChild(button);
            });
            
            // 현재 테마 활성화 표시
            updateThemeButtons();
        }
        
        // 테마 버튼 생성
        function createThemeButton(themeColor, displayName) {
            const button = document.createElement('div');
            button.className = `theme-button ${themeColor}`;
            button.title = displayName;
            button.onclick = () => changeTheme(themeColor);
            return button;
        }
        
        // 테마 변경
        function changeTheme(themeColor) {
            if (themeColor !== 'default' && !purchasedThemes.includes(`테마_${themeColor}`)) {
                alert('이 테마는 구매하지 않았습니다!');
                return;
            }
            
            currentTheme = themeColor;
            applyTheme(themeColor);
            updateThemeButtons();
            saveState();
        }
        
        // 테마 적용
        function applyTheme(themeColor) {
            const body = document.body;
            
            // 기존 테마 클래스 제거
            body.className = body.className.replace(/theme-\w+/g, '');
            
            // 새 테마 클래스 추가
            if (themeColor !== 'default') {
                body.classList.add(`theme-${themeColor}`);
            }
            
            console.log('Applied theme:', themeColor, 'Body classes:', body.className);
        }
        
         // 테마 버튼 상태 업데이트
         function updateThemeButtons() {
             const buttons = document.querySelectorAll('.theme-button');
             buttons.forEach(button => {
                 button.classList.remove('active');
                 const themeColor = button.className.match(/theme-button (\w+)/)[1];
                 if (themeColor === currentTheme) {
                     button.classList.add('active');
                 }
             });
         }

         // 럭키박스 결과 표시
         function showLuckyBoxResult(luckCount, speedCount) {
             const resultDiv = document.createElement('div');
             resultDiv.style.cssText = `
                 position: fixed;
                 top: 50%;
                 left: 50%;
                 transform: translate(-50%, -50%);
                 background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
                 border: 3px solid #b8860b;
                 border-radius: 15px;
                 padding: 30px;
                 color: #8b4513;
                 font-size: 1.5em;
                 font-weight: bold;
                 text-align: center;
                 z-index: 10000;
                 box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
                 animation: pulse 0.5s ease-in-out;
             `;
             resultDiv.innerHTML = `
                 <div style="margin-bottom: 15px;">🎁 럭키박스 결과 🎁</div>
                 <div>행운포션Ⅱ x${luckCount}</div>
                 <div>속도포션Ⅱ x${speedCount}</div>
             `;
             document.body.appendChild(resultDiv);
             
             setTimeout(() => {
                 if (resultDiv.parentNode) {
                     resultDiv.parentNode.removeChild(resultDiv);
                 }
             }, 3000);
         }

         // 세호 이름 변환
         function convertSehoNames() {
             if (storage.length === 0) return;
             
             const sehoNames = ['세호로리', '세호게이', '세호퍼리', '씹덕세호', '마죠이스트 세호', 
                              '평범한 세호', 'TS세호', '쇼타세호', '에겐세호', '니거세호'];
             
             // 이름이 바뀐 아이템들 초기화
             nameChangedItems = [];
             
             // 랜덤하게 3개 선택 (최대 storage.length개)
             const maxItems = Math.min(3, storage.length);
             const selectedIndices = [];
             
             while (selectedIndices.length < maxItems) {
                 const randomIndex = Math.floor(Math.random() * storage.length);
                 if (!selectedIndices.includes(randomIndex)) {
                     selectedIndices.push(randomIndex);
                 }
             }
             
             selectedIndices.forEach(index => {
                 const item = storage[index];
                 if (item && item.name !== '꽝') {
                     // 원본 이름에서 특별효과 제거
                     const originalName = item.name.replace(/✨ 빛나는 |⚡ 번쩍이는 |🏆 황금색 |💎 다이아몬드색 |🌈 무지갯빛 |🌈/g, '');
                     
                     // 새로운 이름 선택
                     const newName = sehoNames[Math.floor(Math.random() * sehoNames.length)];
                     
                     // 특별효과가 있다면 다시 추가
                     let finalName = newName;
                     if (item.effectType === 'shining') finalName = `✨ 빛나는 ${newName} ✨`;
                     else if (item.effectType === 'sparkling') finalName = `⚡ 번쩍이는 ${newName} ⚡`;
                     else if (item.effectType === 'golden') finalName = `🏆 황금색 ${newName} 🏆`;
                     else if (item.effectType === 'diamond') finalName = `💎 다이아몬드색 ${newName} 💎`;
                     else if (item.effectType === 'rainbow') finalName = `🌈 ${newName} 🌈`;
                     
                     item.name = finalName;
                     nameChangedItems.push(index);
                 }
             });
             
             // 10초 후 이름 변경 효과 제거
             if (nameChangeTimer) clearTimeout(nameChangeTimer);
             nameChangeTimer = setTimeout(() => {
                 nameChangedItems = [];
                 updateStorageDisplay();
             }, 10000);
             
             updateStorageDisplay();
         }

  </script>
</body>
</html>


