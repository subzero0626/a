<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„¸í˜¸ë¡œë¦¬ ë½‘ê¸°</title>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            width: 100vw;
            height: 100vh;
            transition: transform 0.3s ease;
        }

        .screen {
            min-width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
            width: 95%;
        }

        .navigation-dots {
      position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        /* ì„¸í˜¸ì½”ì¸ & ë²„í”„ UI (ìš°ì¸¡ ìƒë‹¨) */
        #coinBuffContainer {
            position: fixed;
            top: 16px;
            right: 16px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 2100;
            flex-direction: row-reverse;
        }

        #coinDisplay {
            background: #ffffff;
            border: 3px solid #ffd700;
            border-radius: 12px;
            padding: 12px 30px;
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
            min-width: 200px;
            text-align: center;
        }

        #buffContainer {
            display: flex;
            gap: 10px;
        }

        .buff-icon {
            width: 60px;
            height: 60px;
            background: #ffffff;
            border: 3px solid #28a745;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            font-size: 0.75em;
            font-weight: bold;
            cursor: help;
            position: relative;
        }

        .buff-icon.luck {
            border-color: #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        }

        .buff-icon.speed {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
        }

        .buff-icon .buff-name {
            font-size: 0.8em;
            color: #333;
        }

        .buff-icon .buff-timer {
            font-size: 0.7em;
            color: #666;
            margin-top: 2px;
        }

        /* ì„¤ì • íŒ¨ë„ (ì¢Œì¸¡ ìƒë‹¨) */
        #settingsPanel {
            position: fixed;
            top: 16px;
            left: 16px;
            background: #ffffff;
            border: 2px solid #adb5bd; /* ì—°í•œ íšŒìƒ‰ í…Œë‘ë¦¬ */
            border-radius: 12px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            overflow: hidden;
            z-index: 2100;
            transition: width 0.25s ease, height 0.25s ease;
        }
        #settingsPanel.collapsed {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        #settingsPanel.open {
            width: auto;
            min-width: 320px;
            max-width: 600px;
            max-height: 70vh;
        }
        /* ë§ˆìš°ìŠ¤ ì˜¤ë²„ì‹œ ìë™ í™•ì¥ */
        #settingsPanel:hover {
            width: auto;
            min-width: 320px;
            max-width: 600px;
            height: auto; /* ì„¸ë¡œë¡œ ê¸¸ê²Œ í¼ì¹¨ */
            max-height: 70vh;
        }
        #settingsPanel:hover #settingsContent { display: block; }
        #settingsHeader {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
        }
        #settingsHeader .title { display: none; }
        #settingsContent {
            padding: 10px 12px;
            display: none;
        }
        #settingsPanel.open #settingsContent { display: block; }
        .settings-row { display: flex; align-items: center; justify-content: space-between; margin: 8px 0; gap: 10px; }
        .settings-row.rarest { flex-direction: column; align-items: flex-start; }
        .settings-key { color: #495057; font-weight: 700; white-space: nowrap; }
        .settings-val { color: #212529; font-weight: 800; text-align: right; word-break: break-word; max-width: 400px; }
        .settings-row.rarest .settings-val { text-align: left; width: 100%; }
        .settings-reset {
            margin-top: 10px;
            width: 100%;
            background: #dc3545;
            color: #fff;
            border: none;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* í–„ë²„ê±° ì•„ì´ì½˜ (íšŒìƒ‰ ì„  3ê°œ) */
        .hamburger { display: inline-flex; flex-direction: column; gap: 4px; padding: 6px; }
        .hamburger span { display: block; width: 22px; height: 3px; background: #6c757d; border-radius: 2px; }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .dot.active {
            background: white;
            transform: scale(1.2);
        }

        .dot.locked {
            background: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
            opacity: 0.5;
        }


        h1 {
            color: #333;
            margin-bottom: 40px;
            font-size: 3em;
            font-weight: bold;
        }

        .draw-area {
            margin: 40px 0;
        }

        .result-display {
            background: #f8f9fa;
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            padding: 50px 30px;
            margin: 30px 0;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .result-display.reset {
            font-size: 1.2em;
            color: #6c757d;
            background: #f8f9fa;
            border-color: #dee2e6;
        }
        .result-display.miss {
            background: white;
            border-color: #dee2e6;
            color: #333;
            font-weight: bold;
            font-size: 2.5em;
            animation: pulse 0.5s ease-in-out;
        }

        .result-display.winner {
            background: white;
            border-color: #dee2e6;
            color: #333;
            font-weight: bold;
            font-size: 2.5em;
            animation: pulse 0.5s ease-in-out;
        }

        .result-display.shining {
            background: #fff3cd;
            border-color: #ffc107;
            color: #f0ad4e;
            font-weight: bold;
            font-size: 2.5em;
            animation: pulse 0.5s ease-in-out;
        }

        .result-display.sparkling {
            background: #ffeaa7;
            border-color: #f39c12;
            color: #e67e22;
            font-weight: bold;
            font-size: 2.5em;
            animation: pulse 0.5s ease-in-out;
        }

        .result-display.golden {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
            border: 3px solid #b8860b;
            color: #8b4513;
            font-weight: bold;
            font-size: 2.5em;
            animation: goldenGlow 2s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .result-display.diamond {
            background: linear-gradient(135deg, #b9f2ff 0%, #87ceeb 50%, #00bfff 100%);
            border: 3px solid #4682b4;
            color: #191970;
            font-weight: bold;
            font-size: 2.5em;
            animation: diamondSparkle 2s ease-in-out infinite;
            box-shadow: 0 0 25px rgba(0, 191, 255, 0.6);
        }

        .result-display.rainbow {
            background: #ff4d4d; /* ë” ì§„í•œ ì‹œì‘ ìƒ‰ */
            border: none; /* í…Œë‘ë¦¬ ì œê±° */
            color: #000000; /* ê¸€ììƒ‰ ê²€ì • ê³ ì • */
            font-weight: bold;
            font-size: 2.5em;
            animation: rainbowCycle 1.6s linear infinite, rainbowAura 1.6s ease-in-out infinite alternate, rainbowSparkle 0.7s ease-in-out infinite alternate;
            box-shadow: 0 0 22px rgba(255,255,255,0.35);
            position: relative;
        }

        .result-display.rainbow::after { display: none; }

        /* ê´‘íƒ íš¨ê³¼ ì œê±° (before ìš”ì†Œ ì‚­ì œ) */

        @keyframes rainbowCycle {
            0%   { background: #ff4d4d; color: #000000; }
            16%  { background: #ff9f1a; color: #000000; }
            33%  { background: #ffd60a; color: #000000; }
            50%  { background: #2ecc71; color: #000000; }
            66%  { background: #3498db; color: #000000; }
            83%  { background: #6c5ce7; color: #000000; }
            100% { background: #9b59b6; color: #000000; }
        }

        @keyframes rainbowAura {
            0%   { box-shadow: 0 0 14px rgba(255,179,186,0.35), 0 0 28px rgba(255,217,179,0.25); }
            50%  { box-shadow: 0 0 22px rgba(186,255,201,0.45), 0 0 36px rgba(186,225,255,0.35); }
            100% { box-shadow: 0 0 18px rgba(208,179,255,0.4), 0 0 30px rgba(255,179,186,0.3); }
        }

        @keyframes rainbowBorder {
            0%   { border-color: rgba(255,179,186,0.6); }
            16%  { border-color: rgba(255,217,179,0.6); }
            33%  { border-color: rgba(255,243,179,0.6); }
            50%  { border-color: rgba(186,255,201,0.6); }
            66%  { border-color: rgba(186,225,255,0.6); }
            83%  { border-color: rgba(208,179,255,0.6); }
            100% { border-color: rgba(255,179,186,0.6); }
        }

        @keyframes rainbowSparkle {
            0% { filter: brightness(1) saturate(1); }
            100% { filter: brightness(1.25) saturate(1.1); }
        }

        /* ê´‘íƒ í‚¤í”„ë ˆì„ ì œê±° */

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes goldenGlow {
            0% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 215, 0, 0.3), 0 0 60px rgba(255, 215, 0, 0.1); }
            50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.5), 0 0 90px rgba(255, 215, 0, 0.2); }
            100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 215, 0, 0.3), 0 0 60px rgba(255, 215, 0, 0.1); }
        }

        @keyframes diamondSparkle {
            0% { box-shadow: 0 0 20px rgba(0, 191, 255, 0.5), 0 0 40px rgba(0, 191, 255, 0.3), 0 0 60px rgba(0, 191, 255, 0.1); }
            25% { box-shadow: 0 0 30px rgba(0, 191, 255, 0.8), 0 0 60px rgba(0, 191, 255, 0.5), 0 0 90px rgba(0, 191, 255, 0.2); }
            50% { box-shadow: 0 0 25px rgba(0, 191, 255, 0.6), 0 0 50px rgba(0, 191, 255, 0.4), 0 0 75px rgba(0, 191, 255, 0.15); }
            75% { box-shadow: 0 0 35px rgba(0, 191, 255, 0.9), 0 0 70px rgba(0, 191, 255, 0.6), 0 0 100px rgba(0, 191, 255, 0.25); }
            100% { box-shadow: 0 0 20px rgba(0, 191, 255, 0.5), 0 0 40px rgba(0, 191, 255, 0.3), 0 0 60px rgba(0, 191, 255, 0.1); }
        }

        @keyframes confetti {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ffd700;
            animation: confetti 3s linear infinite;
            z-index: 1000;
        }

        .confetti:nth-child(odd) {
            background: #ff6b6b;
            animation-delay: 0.5s;
        }

        .confetti:nth-child(3n) {
            background: #4ecdc4;
            animation-delay: 1s;
        }

        .confetti:nth-child(4n) {
            background: #45b7d1;
            animation-delay: 1.5s;
        }

        .confetti:nth-child(5n) {
            background: #96ceb4;
            animation-delay: 2s;
        }

        .draw-button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 1.4em;
            border-radius: 50px;
      cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
            margin: 15px;
        }

        .draw-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        .draw-button:active {
            transform: translateY(0);
        }

        .draw-button[disabled], .draw-button.disabled {
            background: #adb5bd;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* ì ‘ì´ì‹ íŒ¨ë„ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .collapse-panel {
            margin-top: 15px;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 12px;
            display: none;
        }
        .panel-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .tab-button {
            background: #e9ecef;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .tab-button.active {
            background: #007bff;
            color: #fff;
        }
        .panel-content {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
        }

        /* ë…ë¦½ ì˜¤ë²„ë ˆì´ íŒ¨ë„ */
        .overlay {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            max-height: 60vh;
            background: #ffffff;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.2);
            border-top: 4px solid #007bff;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 2000;
            padding: 16px;
            overflow-y: auto;
        }
        .overlay.open {
            transform: translateY(0);
        }
        .overlay .overlay-header {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .overlay .overlay-header .tab-button { flex: none; }

        /* ì•„ë˜ë¡œ ë‚´ë ¤ì˜¤ëŠ” íŒ¨ë„ */
        .bottom-panel {
            display: none;
            margin-top: 12px;
            background: #ffffff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 16px;
        }
        .bottom-panel h2 {
            font-size: 1.4em;
            margin: 10px 0;
            color: #333;
        }
        .bottom-row { display: flex; gap: 16px; align-items: flex-start; }
        .bottom-col { flex: 1; min-width: 0; }

        /* ìœ ë¬¼ ì»¬ë ‰ì…˜ ê·¸ë¦¬ë“œ */
        /* ìœ ë¬¼ ì»¬ë ‰ì…˜: 3x3 ê·¸ë¦¬ë“œ */
        .artifact-carousel { 
            width: 100%; 
            height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .artifact-grid { 
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 15px;
            width: 100%;
            max-width: 1100px;
            height: 100%;
        }
        .artifact-card {
            border-radius: 16px;
            background: #f1f3f5;
            border: 3px solid #ced4da;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #495057;
            font-weight: 700;
            text-decoration: none;
            transition: all 0.6s ease;
            position: relative;
            font-size: 0.9em;
            cursor: pointer;
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        .artifact-card:hover { 
            transform: rotateY(180deg);
        }
        .artifact-card.locked { 
            background: repeating-linear-gradient(135deg, #e9ecef 0 8px, #dee2e6 8px 16px); 
            color: #868e96; 
            border-color: #adb5bd;
            opacity: 0.6;
        }
        .artifact-card.locked::before {
            content: "ğŸ”’";
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 1.2em;
        }
        .artifact-card.locked:hover {
            transform: none !important;
        }
        .artifact-card.owned {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-color: #1e7e34;
        }
        .artifact-card.owned::after {
            content: "âœ“";
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 1.2em;
            color: white;
            z-index: 10;
            transform: rotateY(0deg);
        }
        .artifact-card.owned:hover::after {
            transform: rotateY(0deg);
        }
        .artifact-front {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px;
        }
        .artifact-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-radius: 13px;
        }
        .artifact-level {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .artifact-stats {
            font-size: 0.8em;
            line-height: 1.3;
        }

        /* ìƒì  ìŠ¤íƒ€ì¼ */
        .shop-container {
            background: white;
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 1100px;
            width: 95%;
        }

        .shop-container h2 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
            font-size: 2.2em;
        }

        .shop-timer {
            text-align: center;
            color: #6c757d;
            font-size: 1.1em;
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .shop-probability {
            text-align: center;
            color: #495057;
            font-size: 0.85em;
            margin-bottom: 25px;
            padding: 8px 12px;
            background: #e9ecef;
            border-radius: 6px;
            font-weight: 500;
        }

        .shop-items {
            display: flex;
            flex-direction: row;
            gap: 30px;
            justify-content: center;
        }

        .shop-item {
            background: #f8f9fa;
            border: 4px solid #dee2e6;
            border-radius: 12px;
            padding: 35px 25px;
            text-align: center;
            height: 450px;
            width: 280px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 18px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .shop-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .shop-item.sold-out {
            background: #e9ecef !important;
            border-color: #adb5bd !important;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .shop-item.sold-out:hover {
            transform: none;
            box-shadow: none;
        }

        .shop-item .sold-out-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.5em;
            font-weight: bold;
            pointer-events: none;
        }

        /* ìƒì  ë¬¼í’ˆ ë“±ê¸‰ë³„ ë°°ê²½ìƒ‰ */
        .shop-item.common {
            background: #ffffff;
            border-color: #dee2e6;
        }

        .shop-item.common:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
        }

        .shop-item.rare {
            background: linear-gradient(135deg, #d4f4dd 0%, #a8e6cf 100%);
            border-color: #28a745;
        }

        .shop-item.rare:hover {
            background: linear-gradient(135deg, #c3f0d0 0%, #90e0b8 100%);
            border-color: #218838;
        }

        .shop-item.epic {
            background: linear-gradient(135deg, #cfe2ff 0%, #9ec5fe 100%);
            border-color: #0d6efd;
        }

        .shop-item.epic:hover {
            background: linear-gradient(135deg, #b6d4fe 0%, #85b5fc 100%);
            border-color: #0a58ca;
        }

        .shop-item.hero {
            background: linear-gradient(135deg, #e0cffc 0%, #c29ffa 100%);
            border-color: #6f42c1;
        }

        .shop-item.hero:hover {
            background: linear-gradient(135deg, #d4bef9 0%, #b085f5 100%);
            border-color: #5a32a3;
        }

        .shop-item.legendary {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
            border-color: #ffc107;
        }

        .shop-item.legendary:hover {
            background: linear-gradient(135deg, #ffecb5 0%, #ffd966 100%);
            border-color: #e0a800;
        }

        .shop-item-name {
            font-weight: bold;
            font-size: 1.4em;
            color: #333;
        }

        .shop-item-price {
            font-size: 1.3em;
            color: #495057;
            font-weight: bold;
        }

        .shop-item-desc {
            font-size: 1em;
            color: #6c757d;
            line-height: 1.5;
        }

        /* í™•ë¥ í‘œ ìŠ¤íƒ€ì¼ */
        .probability-list {
            margin-top: 20px;
        }

        .probability-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin: 6px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            font-size: 1.1em;
            position: relative;
            transition: all 0.3s ease;
            z-index: 20;
        }

        .probability-item:not(.no-hover):hover {
            background: #e3f2fd;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
        }

        .shining-info {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #f39c12;
            border-radius: 0 0 15px 15px;
            padding: 12px 15px;
            font-size: 0.85em;
            color: #8b4513;
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.3);
            transform: translateY(-100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
            opacity: 0;
            backdrop-filter: blur(10px);
            pointer-events: none;
        }

        .probability-item:not(.no-hover):hover .shining-info {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .probability-item:not(.no-hover):hover .shining-info:hover {
            transform: translateY(0);
            opacity: 1;
        }

        .shining-info .effect-title {
            font-weight: bold;
            font-size: 1.05em;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .shining-info         .effect-probability {
            background: rgba(255, 255, 255, 0.7);
            padding: 4px 8px;
            border-radius: 10px;
            margin: 2px 0;
            font-weight: bold;
            color: #8b4513;
            border: 1px solid rgba(243, 156, 18, 0.3);
            display: flex;
            flex-direction: column;
            gap: 1px;
            font-size: 0.9em;
        }

        .shining-info .effect-probability small {
            font-size: 0.8em;
            color: #8b4513;
            font-weight: normal;
            opacity: 0.8;
        }

        .shining-info .effect-description {
            font-size: 0.85em;
            color: #8b4513;
            margin-top: 8px;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            border-left: 3px solid #f39c12;
        }

        .probability-item:not(.no-hover):hover {
            margin-bottom: 380px;
        }
        .artifact-effect {
            color: #007bff;
            font-weight: bold;
        }

        .participant-name {
            font-weight: bold;
            color: #333;
        }

        .probability-value {
            color: #007bff;
            font-weight: bold;
            font-size: 1.1em;
        }

        /* ë³´ê´€ì†Œ ìŠ¤íƒ€ì¼ */
        .storage-container .container {
            max-width: 600px;
            width: 95%;
        }

        .storage-list {
            max-height: 600px;
            overflow-y: auto;
            margin-top: 20px;
        }

        /* ì•„ì´í…œ ë³´ê´€ì†Œ ì „ìš© ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
        #itemStorageList {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
            margin-top: 20px;
        }

        #itemStorageList .storage-item {
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 8px;
        }

        #itemStorageList .storage-item-header {
            flex-direction: column;
            gap: 3px;
        }

        #itemStorageList .storage-item-name {
            font-size: 0.85em;
            font-weight: bold;
            text-align: center;
        }

        #itemStorageList .storage-item-count {
            font-size: 1em;
            font-weight: bold;
        }

        #itemStorageList .storage-item-info {
            font-size: 0.6em;
            margin-top: auto;
        }

        /* ì•„ì´í…œ ë³´ê´€ì†Œ ì»¨í…Œì´ë„ˆ ë„ˆë¹„ í™•ì¥ */
        .item-storage-screen .container {
            max-width: 900px;
        }

        /* í…Œë§ˆë³„ ë°°ê²½ ê·¸ë¼ë°ì´ì…˜ */
        body.theme-orange {
            background: linear-gradient(135deg, #ff7043 0%, #ff5722 100%) !important;
        }

        body.theme-green {
            background: linear-gradient(135deg, #66bb6a 0%, #2e7d32 100%) !important;
        }

        body.theme-gray {
            background: linear-gradient(135deg, #78909c 0%, #37474f 100%) !important;
        }

        body.theme-yellow {
            background: linear-gradient(135deg, #ffeb3b 0%, #ff8f00 100%) !important;
        }

        body.theme-pink {
            background: linear-gradient(135deg, #f06292 0%, #ad1457 100%) !important;
        }

        body.theme-purple {
            background: linear-gradient(135deg, #ba68c8 0%, #7b1fa2 100%) !important;
        }

        /* í…Œë§ˆ ì„ íƒ ë²„íŠ¼ */
        .theme-selector {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .theme-button {
            width: 30px;
            height: 30px;
            border: 2px solid #fff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-button:hover {
            transform: scale(1.1);
            border-color: #007bff;
        }

        .theme-button.active {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
        }

        .theme-button.default {
            background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
        }

        .theme-button.orange {
            background: linear-gradient(135deg, #ff8a65 0%, #ff5722 100%);
        }

        .theme-button.green {
            background: linear-gradient(135deg, #81c784 0%, #4caf50 100%);
        }

        .theme-button.gray {
            background: linear-gradient(135deg, #90a4ae 0%, #607d8b 100%);
        }

        .theme-button.yellow {
            background: linear-gradient(135deg, #fff176 0%, #ffc107 100%);
        }

        .theme-button.pink {
            background: linear-gradient(135deg, #f48fb1 0%, #e91e63 100%);
        }

        .theme-button.purple {
            background: linear-gradient(135deg, #ba68c8 0%, #7b1fa2 100%);
        }

        .storage-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .storage-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #28a745;
            width: 240px;
            min-width: 240px;
            transition: all 0.3s ease;
            position: relative;
        }

        /* ë³´ê´€ì†Œ ì•„ì´í…œ ì„ íƒ ì‹œ ì‚´ì§ ì—°í•´ ë³´ì´ë„ë¡ */
        .storage-item.selected { filter: brightness(1.08) saturate(0.9); }
        /* ì˜¤ë²„ ì‹œì—ë„ ì—°í•´ ë³´ì´ë„ë¡ */
        .storage-item:hover { filter: brightness(1.08) saturate(0.9); }

        /* ë³´ê´€ì†Œ ì•„ì´í…œ ë‚´ ì•¡ì…˜ ë²„íŠ¼ë“¤ */
        .storage-item .action-btn {
            position: absolute;
            bottom: 8px;
            padding: 6px 10px;
            font-size: 0.85em;
            font-weight: 800;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            user-select: none;
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        }
        .storage-item .action-back {
            left: 10px;
            background: #dc3545; /* ë¹¨ê°„ìƒ‰ */
        }
        .storage-item .action-upgrade {
            right: 10px;
            background: #28a745; /* ì´ˆë¡ìƒ‰ */
        }
        .storage-item .enhance-info {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 42px; /* ë²„íŠ¼ë“¤ ìœ„ì— í‘œì‹œ */
            background: rgba(0,0,0,0.65);
            color: #fff;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.8em;
            white-space: nowrap;
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        }

        /* ì˜¤ë²„ ì‹œ ì»¨íŠ¸ë¡¤ê³¼ ì •ë³´ í‘œì‹œ */
        .storage-item:hover .action-btn { display: block; }
        .storage-item:hover .enhance-info { display: block; }

        /* ê¸°ë³¸ ë§ˆìš°ìŠ¤ ì˜¤ë²„ íš¨ê³¼ ì œê±° - ê°•í™”ëœ ì•„ì´í…œë§Œ íš¨ê³¼ ì ìš© */

        .storage-item.diamond {
            background: linear-gradient(135deg, #b9f2ff 0%, #87ceeb 50%, #00bfff 100%);
            border-left-color: #4682b4;
            color: #191970;
            box-shadow: 0 4px 15px rgba(0, 191, 255, 0.3);
        }

        .storage-item.golden {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
            border-left-color: #b8860b;
            color: #8b4513;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .storage-item.sparkling {
            background: #ffeaa7;
            border-left-color: #f39c12;
            color: #e67e22;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .storage-item.shining {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #f0ad4e;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .storage-item.rainbow {
            background: #ffe3e8; /* ì¡°ê¸ˆ ë” ì—°í•œ íŒŒìŠ¤í…”í†¤ */
            border-left-color: #ced4da; /* ì—°í•œ íšŒìƒ‰ êµ¬ë¶„ì„  */
            color: #2b2d42;
            animation: rainbowCycle 1.8s linear infinite;
            box-shadow: 0 4px 10px rgba(255, 255, 255, 0.2);
            filter: brightness(1.03) saturate(0.7);
        }

        .storage-item .name {
            font-weight: bold;
            font-size: 1.4em;
            color: #333;
            word-break: break-word;
        }

        .storage-item .probability {
            color: #007bff;
            font-size: 0.9em;
            margin-top: 4px;
            font-weight: bold;
        }

        .storage-item .time {
            color: #6c757d;
            font-size: 0.85em;
            margin-top: 4px;
        }

        .storage-item .count {
            position: absolute;
            bottom: 8px;
            right: 12px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }

        .storage-item .sell-button {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 24px;
            height: 24px;
            background: #dc3545;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            display: none;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .storage-item .sell-button:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .storage-item:hover .sell-button {
            display: flex;
        }

        .clear-storage {
            background: #dc3545;
      color: white;
      border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 25px;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .clear-storage:hover {
            background: #c82333;
        }

        /* ê°•í™” í™•ë¥ /íŒŒê´´ í™•ë¥  í•˜ë‹¨ ì¢Œì¸¡ í‘œì‹œ */
        .storage-item .enhance-stats {
            position: absolute;
            bottom: 8px;
            left: 10px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 0.8em;
            line-height: 1.2;
            display: none;
        }
         .storage-item:hover .enhance-stats { display: block; }

         /* ê°•í™”ë¨ ë¼ë²¨ ìŠ¤íƒ€ì¼ */
         .enhanced-label {
             color: #6c757d;
             font-size: 0.75em;
             font-style: italic;
             margin-top: 2px;
         }

         /* ê°•í™” ë‹¨ê³„ë³„ ëˆ„ì  íš¨ê³¼ */
         
         /* 1ê°•: íš¨ê³¼ ì—†ìŒ */
         
        /* 2ê°•: ë§ˆìš°ìŠ¤ ì˜¤ë²„ì‹œ ê´‘íƒ íš¨ê³¼ */
        .storage-item[data-enhance-level="2"]:hover {
             position: relative;
             overflow: hidden;
         }
        .storage-item[data-enhance-level="2"]:hover::after {
             content: '';
             position: absolute;
             top: -50%;
             left: -50%;
             width: 200%;
             height: 200%;
             background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shine 0.8s ease-in-out;
             pointer-events: none;
         }

         /* 3ê°• ì´ìƒ: ë§ˆìš°ìŠ¤ ì˜¤ë²„ì‹œ ê´‘íƒ íš¨ê³¼ */
         .storage-item[data-enhance-level="3"]:hover,
         .storage-item[data-enhance-level="4"]:hover,
         .storage-item[data-enhance-level="5"]:hover {
             position: relative;
             overflow: hidden;
         }
         .storage-item[data-enhance-level="3"]:hover::after,
         .storage-item[data-enhance-level="4"]:hover::after,
         .storage-item[data-enhance-level="5"]:hover::after {
             content: '';
             position: absolute;
             top: -50%;
             left: -50%;
             width: 200%;
             height: 200%;
             background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
             animation: shine 0.8s ease-in-out;
             pointer-events: none;
         }

        /* 3ê°•: ë§ˆìš°ìŠ¤ ì˜¤ë²„ì‹œ ì ë‹¹íˆ ì˜¬ë¼ê° */
        .storage-item[data-enhance-level="3"]:hover,
        .storage-item[data-enhance-level="4"]:hover,
        .storage-item[data-enhance-level="5"]:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }

        /* 4ê°•: ê²€ì€ìƒ‰ í…Œë‘ë¦¬ì™€ ë‘êº¼ìš´ ê¸€ì”¨ */
        .storage-item[data-enhance-level="4"] {
            border: 3px solid #000000;
            font-weight: bold;
        }
        .storage-item[data-enhance-level="4"] .name {
            font-weight: 900;
        }
        
        /* 4ê°•: ë§ˆìš°ìŠ¤ ì˜¤ë²„ì‹œ ì¶”ê°€ íš¨ê³¼ */
        .storage-item[data-enhance-level="4"]:hover,
        .storage-item[data-enhance-level="5"]:hover {
            border: 3px solid #6c757d;
            transform: translateY(-4px);
        }

        /* 5ê°•: ë§ˆìš°ìŠ¤ ì˜¤ë²„ì‹œ í”ë“¤ë¦¼ íš¨ê³¼ */
        .storage-item[data-enhance-level="5"]:hover {
            animation: maxLevelShake 0.8s ease-in-out infinite alternate;
            z-index: 1;
            position: relative;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        @keyframes autoShine {
            0% { 
                opacity: 0;
                transform: translateX(-100%) translateY(-100%) rotate(45deg); 
            }
            50% { 
                opacity: 1;
                transform: translateX(0%) translateY(0%) rotate(45deg); 
            }
            100% { 
                opacity: 0;
                transform: translateX(100%) translateY(100%) rotate(45deg); 
            }
        }

        @keyframes maxLevelShake {
            0% {
                transform: translateY(-4px) rotate(-1.5deg);
                box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            }
            100% {
                transform: translateY(-4px) rotate(1.5deg);
                box-shadow: 0 8px 24px rgba(0,0,0,0.18);
            }
        }


         /* ê°•í™”ëœ ì„¸í˜¸ í‘œì‹œ ìŠ¤íƒ€ì¼ */
         .probability-item.enhanced {
             background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
             border-left: 4px solid #f39c12;
         }

         .probability-item.enhanced .participant-name {
             color: #d68910;
             font-weight: bold;
         }

         .enhancement-indicator {
             display: inline-block;
             background: #f39c12;
             color: white;
             padding: 2px 8px;
             border-radius: 12px;
             font-size: 0.75em;
             font-weight: bold;
             margin-left: 8px;
             animation: pulse 2s infinite;
        }

  </style>
</head>
<body>
    <!-- ì„¸í˜¸ì½”ì¸ & ë²„í”„ UI -->
    <div id="coinBuffContainer">
        <div id="coinDisplay">
            <span id="coinAmount">0</span> ì„¸í˜¸ì½”ì¸
        </div>
        <div id="buffContainer">
            <!-- ë²„í”„ ì•„ì´ì½˜ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <!-- ì„¤ì • íŒ¨ë„ -->
    <div id="settingsPanel" class="collapsed" onclick="toggleSettingsPanelClick(event)">
        <div id="settingsHeader">
            <span class="title"></span>
            <span class="hamburger" aria-label="menu">
                <span></span>
                <span></span>
                <span></span>
            </span>
            <span id="settingsChevron" style="display:none">â–¼</span>
        </div>
        <div id="settingsContent">
            <div class="settings-row"><span class="settings-key">ì´ ë½‘ê¸° íšŸìˆ˜</span><span class="settings-val" id="statTotalDraws">0</span></div>
            <div class="settings-row rarest"><span class="settings-key">ê°€ì¥ ë‚®ì€ í™•ë¥ ë¡œ íšë“</span><span class="settings-val" id="statRarest">-</span></div>
            <div class="settings-row"><span class="settings-key">í”Œë ˆì´ ì‹œê°„</span><span class="settings-val" id="statPlaytime">00:00:00</span></div>
            <div class="settings-row"><span class="settings-key">í…Œë§ˆ ë³€ê²½</span></div>
            <div class="theme-selector" id="themeSelector">
                <!-- í…Œë§ˆ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
            <button class="settings-reset" onclick="resetAllData()">ì´ˆê¸°í™”</button>
        </div>
    </div>
    <div class="main-container" id="mainContainer">
        <!-- ì•„ì´í…œ ë³´ê´€ì†Œ í™”ë©´ (ë§¨ ì™¼ìª½) -->
        <div class="screen storage-container item-storage-screen">
            <div class="container">
                <h1>ğŸ“¦ ì•„ì´í…œ ë³´ê´€ì†Œ</h1>
                <div id="itemStorageContent">
                    <div class="storage-list" id="itemStorageList">
                        <p>ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìƒì  í™”ë©´ -->
        <div class="screen">
            <div class="shop-container">
                <h2>ğŸ›’ ìƒì </h2>
                <div class="shop-timer" id="shopTimer">ê°±ì‹ ê¹Œì§€: 30:00</div>
                <div class="shop-probability" id="shopProbability">ì¼ë°˜ 45% | í¬ê·€ 27.5% | ë ˆì–´ 17.5% | ì˜ì›… 7.5% | ì „ì„¤ 2.5%</div>
                <div class="shop-items" id="shopItems">
                    <div class="shop-item">
                        <div class="shop-item-name">???</div>
                        <div class="shop-item-desc">ë¬¼í’ˆì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤...</div>
                        <div class="shop-item-price">??? ê³¨ë“œ</div>
                    </div>
                    <div class="shop-item">
                        <div class="shop-item-name">???</div>
                        <div class="shop-item-desc">ë¬¼í’ˆì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤...</div>
                        <div class="shop-item-price">??? ê³¨ë“œ</div>
                    </div>
                    <div class="shop-item">
                        <div class="shop-item-name">???</div>
                        <div class="shop-item-desc">ë¬¼í’ˆì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤...</div>
                        <div class="shop-item-price">??? ê³¨ë“œ</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- í™•ë¥ í‘œ í™”ë©´ -->
        <div class="screen">
            <div class="container">
                <h1>ğŸ“Š í™•ë¥ í‘œ</h1>
                <div id="probabilityContent">
                    <p>ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>

        <!-- ë½‘ê¸° í™”ë©´ (ê°€ìš´ë°) -->
        <div class="screen">
            <div class="container">
                <h1>ğŸ² ì„¸í˜¸ë½‘ê¸°</h1>
                
                <div class="draw-area">
                    <div id="resultDisplay" class="result-display">
                        ë½‘ê¸°ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!
                    </div>
                    
                    <button id="drawButton" class="draw-button" onclick="startDraw()">
                        ğŸ¯ ë½‘ê¸° ì‹œì‘!
                    </button>
                    <div id="trumpCardInfo" style="margin-top: 10px; color: #adb5bd; font-size: 0.9em; text-align: center; display: none;">
                        <!-- íŠ¸ëŸ¼í”„ì¹´ë“œ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
  </div>

        <!-- ë³´ê´€ì†Œ í™”ë©´ (ì˜¤ë¥¸ìª½) -->
        <div class="screen storage-container">
            <div class="container">
                <h1>ğŸ“¦ ë³´ê´€ì†Œ</h1>
                <div id="storageContent">
                    <div class="storage-list" id="storageList">
                        <p>ë½‘íŒ ê²°ê³¼ê°€ ì—¬ê¸°ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
                    </div>
                    <button class="clear-storage" onclick="clearStorage()">
                        ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
                    </button>
                </div>
            </div>
        </div>

        <!-- 4ë²ˆì§¸ í™”ë©´: ğŸº ìœ ë¬¼ ë½‘ê¸° -->
        <div class="screen">
            <div class="container">
                <h1>ğŸº ìœ ë¬¼ ë½‘ê¸°</h1>
                <div class="draw-area">
                    <div class="result-display reset" id="artifactResult">ìœ ë¬¼ ë½‘ê¸°ë¥¼ ì¤€ë¹„í•´ì£¼ì„¸ìš”!</div>
                    <button class="draw-button" id="artifactDrawButton" onclick="startArtifactDraw()">ğŸº ìœ ë¬¼ ë½‘ê¸°</button>
                    <div id="artifactCooldown" style="margin-top: 10px; color: #6c757d; font-size: 0.9em;"></div>
                    <div style="margin-top: 15px; color: #adb5bd; font-size: 0.8em; text-align: center; line-height: 1.4;">
                        (ìœ ë¬¼ì„ ë½‘ì„ í™•ë¥ ì€ 50%ì´ê³ , ìœ ë¬¼ë³„ í™•ë¥ ì€ ëª¨ë‘ ê· ì¼í•©ë‹ˆë‹¤)
                    </div>
                </div>
            </div>
        </div>

        <!-- 5ë²ˆì§¸ í™”ë©´: ğŸº ìœ ë¬¼ ì»¬ë ‰ì…˜ (ê°€ë¡œ íšŒì „ ìºëŸ¬ì…€) -->
        <div class="screen">
            <div class="container">
                <h1>ğŸº ìœ ë¬¼ ì»¬ë ‰ì…˜</h1>
                <div id="artifactCarousel" class="artifact-carousel">
                    <div class="artifact-grid" id="artifactGrid"></div>
                </div>
            </div>
        </div>
  </div>

    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë„íŠ¸ -->
    <div class="navigation-dots">
         <div class="dot" id="dot-0" onclick="goToScreen(0)"></div>
         <div class="dot" id="dot-1" onclick="goToScreen(1)"></div>
         <div class="dot" id="dot-2" onclick="goToScreen(2)"></div>
         <div class="dot active" id="dot-3" onclick="goToScreen(3)"></div>
         <div class="dot" id="dot-4" onclick="goToScreen(4)"></div>
         <div class="dot" id="dot-5" onclick="goToScreen(5)"></div>
         <div class="dot" id="dot-6" onclick="goToScreen(6)"></div>
    </div>

  <script>
        // ì†Œìˆ˜ í‘œì‹œ í¬ë§·í„°: ìœ í•œì†Œìˆ˜ëŠ” ëìë¦¬ê¹Œì§€, ë¬´í•œì†Œìˆ˜ëŠ” ì†Œìˆ˜ 3ìë¦¬ + '...'
        function formatFiniteOrEllipsis(value, maxCheckDecimals = 12) {
            const num = Number(value);
            if (!isFinite(num)) return String(value);
            const abs = Math.abs(num);
            if (Math.abs(abs - Math.round(abs)) < 1e-12) return String(Math.round(num));
            for (let k = 0; k <= maxCheckDecimals; k++) {
                const scaled = num * Math.pow(10, k);
                if (Math.abs(scaled - Math.round(scaled)) < 1e-9) {
                    const fixed = num.toFixed(k);
                    return fixed.replace(/\.?0+$/, '');
                }
            }
            return num.toFixed(3) + '...';
        }

        // í™•ë¥ í‘œ: ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ìƒì„¸ í‘œì‹œ (í´ë¦­ í† ê¸€ ì œê±°)
        function attachProbabilityToggle(hostId) {
            const host = document.getElementById(hostId);
            if (!host) return;
            host.querySelectorAll('.probability-item').forEach(item => {
                const detail = item.querySelector('.shining-info');
                if (!detail) return;
                // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼/í´ë¦­ í•¸ë“¤ëŸ¬ ì œê±°í•˜ì—¬ CSS :hoverë¡œ ë™ì‘
                detail.style.display = '';
                item.classList.remove('no-hover');
                item.onclick = null;
            });
        }
        // ì°¸ê°€ì ëª©ë¡ê³¼ í™•ë¥  ì„¤ì • (ì„¸í˜¸ë½‘ê¸° í™•ë¥ : ê½ 70%, 10ëª…ì˜ ì„¸í˜¸ ê°ê° 3%)
        let participants = [
            { name: "ê½", weight: 70 },
            { name: "ì„¸í˜¸ë¡œë¦¬", weight: 3 },
            { name: "ì„¸í˜¸ê²Œì´", weight: 3 },
            { name: "ì„¸í˜¸í¼ë¦¬", weight: 3 },
            { name: "ì”¹ë•ì„¸í˜¸", weight: 3 },
            { name: "ë§ˆì£ ì´ìŠ¤íŠ¸ ì„¸í˜¸", weight: 3 },
            { name: "í‰ë²”í•œ ì„¸í˜¸", weight: 3 },
            { name: "TSì„¸í˜¸", weight: 3 },
            { name: "ì‡¼íƒ€ì„¸í˜¸", weight: 3 },
            { name: "ì—ê²ì„¸í˜¸", weight: 3 },
            { name: "ë‹ˆê±°ì„¸í˜¸", weight: 3 }
        ];
        // ìœ ë¬¼ì„ ê¸°ë°˜ ìœ íš¨ í™•ë¥ (ê°€ì¤‘ì¹˜) ê³„ì‚°: ë ˆë²¨ë‹¹ ê½ -7, ê° ì„¸í˜¸ +0.7
        function getEffectiveParticipants() {
            const stone = artifactStorage.find(item => item.name === 'ì„¸í˜¸ë¡œë¦¬ì˜ ìœ ë¬¼ì„');
            const level = stone ? stone.level : 0;
            let adjusted = participants.map(p => ({ ...p }));
            
            // ìœ ë¬¼ì„ íš¨ê³¼ ì ìš© - ë ˆë²¨ë‹¹ 8%p ì ˆëŒ€ê°’ ê°ì†Œí•˜ê³  ì¤„ì–´ë“  ë§Œí¼ì„ ì„¸í˜¸ì—ê²Œ ë¶„ë°°
            if (level) {
            const miss = adjusted.find(p => p.name === 'ê½');
                if (miss) {
                    const totalWeight = adjusted.reduce((sum, p) => sum + p.weight, 0);
                    const reductionPercent = 8 * level; // ë ˆë²¨ë‹¹ 8%p (ì ˆëŒ€ê°’)
                    const reducedWeight = totalWeight * (reductionPercent / 100); // ì „ì²´ ê°€ì¤‘ì¹˜ì˜ 8%
                    miss.weight = Math.max(0, miss.weight - reducedWeight);
                    // ì¤„ì–´ë“  í™•ë¥ ì„ ëª¨ë“  ì„¸í˜¸ì—ê²Œ ê· ë“± ë¶„ë°°
                    const sehos = adjusted.filter(p => p.name !== 'ê½');
                    const perSeho = reducedWeight / sehos.length;
                    sehos.forEach(p => p.weight += perSeho);
                }
            }
            
            // í–‰ìš´ í¬ì…˜ íš¨ê³¼ ì ìš© - ì ˆëŒ€ê°’ìœ¼ë¡œ ì¤„ì´ê³  ë¶„ë°°
            const luckBuff = activeBuffs.find(b => b.type === 'luck' && b.endTime > Date.now());
            if (luckBuff) {
                const reductionPercent = [5, 10, 20][luckBuff.level - 1]; // 5%p, 10%p, 20%p
                const miss = adjusted.find(p => p.name === 'ê½');
                if (miss) {
                    const totalWeight = adjusted.reduce((sum, p) => sum + p.weight, 0);
                    const reducedWeight = totalWeight * (reductionPercent / 100); // ì „ì²´ ê°€ì¤‘ì¹˜ì˜ x%
                    miss.weight = Math.max(0, miss.weight - reducedWeight);
                    // ì¤„ì–´ë“  í™•ë¥ ì„ ëª¨ë“  ì„¸í˜¸ì—ê²Œ ê· ë“± ë¶„ë°°
                    const sehos = adjusted.filter(p => p.name !== 'ê½');
                    const perSeho = reducedWeight / sehos.length;
                    sehos.forEach(p => p.weight += perSeho);
                }
            }
            
            // íŠ¸ëŸ¼í”„ì¹´ë“œ íš¨ê³¼ ì ìš©: ê½ ì œì™¸
            if (shouldGuaranteeSpecialEffect()) {
                adjusted = adjusted.filter(p => p.name !== 'ê½');
            }
            
            // ìš©ì‚¬ì˜ ì‹¬íŒ íš¨ê³¼ ì ìš©
            if (specialItemCount > 0) {
                // ê½ ì œê±°
                adjusted = adjusted.filter(p => p.name !== 'ê½');
                
                // ëª¨ë“  íŠ¹ë³„íš¨ê³¼ í™•ë¥ ì„ 20%ë¡œ ì„¤ì •
                const specialEffects = adjusted.filter(p => 
                    p.name.includes('ë¬´ì§€ê°¯ë¹›') || 
                    p.name.includes('ë‹¤ì´ì•„ëª¬ë“œìƒ‰') || 
                    p.name.includes('í™©ê¸ˆìƒ‰') || 
                    p.name.includes('ë²ˆì©ì´ëŠ”') || 
                    p.name.includes('ë¹›ë‚˜ëŠ”')
                );
                
                if (specialEffects.length > 0) {
                    // íŠ¹ë³„íš¨ê³¼ë“¤ì˜ ê°€ì¤‘ì¹˜ë¥¼ 20%ë¡œ í†µì¼
                    const specialWeight = 20;
                    specialEffects.forEach(p => p.weight = specialWeight);
                    
                    // ë‚˜ë¨¸ì§€ í™•ë¥ ì„ ì¼ë°˜ ì„¸í˜¸ë“¤ì—ê²Œ ë¶„ë°°
                    const normalSehos = adjusted.filter(p => !specialEffects.includes(p));
                    const remainingWeight = 100 - (specialEffects.length * specialWeight);
                    const normalWeight = remainingWeight / normalSehos.length;
                    normalSehos.forEach(p => p.weight = normalWeight);
                }
            }
            
            return adjusted;
        }
        let isDrawing = false;
        let currentScreen = 3; // 0: ì•„ì´í…œ ë³´ê´€ì†Œ, 1: ìƒì , 2: í™•ë¥ í‘œ, 3: ë½‘ê¸°, 4: ì„¸í˜¸ ë³´ê´€ì†Œ, 5: ìœ ë¬¼ ë½‘ê¸°, 6: ìœ ë¬¼ ì»¬ë ‰ì…˜
        
        // ì„¸í˜¸ì½”ì¸ & ë²„í”„ ê´€ë ¨ ë³€ìˆ˜
        let sehoCoin = 0; // ì´ˆê¸° ì„¸í˜¸ì½”ì¸
        let activeBuffs = []; // í™œì„± ë²„í”„ ëª©ë¡ { type, level, endTime }
        let purchasedThemes = []; // êµ¬ë§¤í•œ í…Œë§ˆ ëª©ë¡
         let currentTheme = 'default'; // í˜„ì¬ í…Œë§ˆ
         let specialItemCount = 0; // ìš©ì‚¬ì˜ ì‹¬íŒ ê°œìˆ˜
         let noCooldownCount = 0; // ì£¼ë§ íš¨ê³¼ ì¹´ìš´í„°
         let nameChangedItems = []; // ì´ë¦„ì´ ë°”ë€ ì•„ì´í…œë“¤ (ë³€í™˜ê¸° íš¨ê³¼)
         let nameChangeTimer = null; // ì´ë¦„ ë³€ê²½ íš¨ê³¼ íƒ€ì´ë¨¸
        
        // ìƒì  ê´€ë ¨ ë³€ìˆ˜
        let shopItems = []; // í˜„ì¬ ìƒì ì— ìˆëŠ” ë¬¼í’ˆë“¤
        let purchasedInCurrentShop = []; // í˜„ì¬ ìƒì ì—ì„œ êµ¬ë§¤í•œ ì•„ì´í…œ ì¸ë±ìŠ¤
        let allShopItems = [
            // í¬ì…˜ë¥˜ - ì¼ë°˜ ë“±ê¸‰
            { name: 'í–‰ìš´í¬ì…˜â… ', price: 10, rarity: 'common', type: 'potion', effect: 'luck', level: 1, minQty: 1, maxQty: 10 },
            { name: 'ì†ë„í¬ì…˜â… ', price: 10, rarity: 'common', type: 'potion', effect: 'speed', level: 1, minQty: 1, maxQty: 10 },
            // í¬ì…˜ë¥˜ - í¬ê·€ ë“±ê¸‰
            { name: 'í–‰ìš´í¬ì…˜â…¡', price: 30, rarity: 'rare', type: 'potion', effect: 'luck', level: 2, minQty: 1, maxQty: 5 },
            { name: 'ì†ë„í¬ì…˜â…¡', price: 30, rarity: 'rare', type: 'potion', effect: 'speed', level: 2, minQty: 1, maxQty: 5 },
            // í¬ì…˜ë¥˜ - ë ˆì–´ ë“±ê¸‰ ê·¸ë£¹
            { name: 'í–‰ìš´í¬ì…˜â…¢', price: 100, rarity: 'epic', type: 'potion', effect: 'luck', level: 3, minQty: 1, maxQty: 3 },
            { name: 'ì†ë„í¬ì…˜â…¢', price: 100, rarity: 'epic', type: 'potion', effect: 'speed', level: 3, minQty: 1, maxQty: 3 },
            // í¬ê·€ ë“±ê¸‰ ì•„ì´í…œ
            { name: 'ì“¸ë°ì—†ëŠ” ë³€í™˜ê¸°', price: 30, rarity: 'rare', type: 'special', effect: 'name_converter', minQty: 1, maxQty: 1 },
            // ë ˆì–´ ë“±ê¸‰ ì•„ì´í…œ
            { name: 'ì£¼ë§', price: 250, rarity: 'epic', type: 'special', effect: 'remove_cooldown', minQty: 1, maxQty: 1 },
            { name: '1339í¬ì…˜', price: 250, rarity: 'epic', type: 'potion', effect: 'speed_boost', level: 4, minQty: 1, maxQty: 1 },
            { name: 'ë³´ì¡°ë°°í„°ë¦¬', price: 250, rarity: 'epic', type: 'special', effect: 'refresh_shop', minQty: 1, maxQty: 1 },
            { name: 'ëŸ­í‚¤ë°•ìŠ¤', price: 250, rarity: 'epic', type: 'special', effect: 'lucky_box', minQty: 1, maxQty: 1 },
            // í…Œë§ˆ - ì˜ì›… ë“±ê¸‰
            { name: 'í…Œë§ˆ_ì£¼í™©', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'orange', oneTime: true },
            { name: 'í…Œë§ˆ_ì´ˆë¡', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'green', oneTime: true },
            { name: 'í…Œë§ˆ_íšŒìƒ‰', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'gray', oneTime: true },
            { name: 'í…Œë§ˆ_ë…¸ë€ìƒ‰', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'yellow', oneTime: true },
            { name: 'í…Œë§ˆ_í•‘í¬ìƒ‰', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'pink', oneTime: true },
            { name: 'í…Œë§ˆ_ë³´ë¼', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'purple', oneTime: true },
            // íŠ¹ìˆ˜ ì•„ì´í…œ - ì˜ì›… ë“±ê¸‰
            { name: 'ìš©ì‚¬ì˜ ì‹¬íŒ', price: 5000, rarity: 'hero', type: 'potion', effect: 'guaranteed_special', minQty: 1, maxQty: 1 }
        ]; // ì „ì²´ ìƒì  ë¬¼í’ˆ ëª©ë¡
        let shopRefreshTime = 0; // ë‹¤ìŒ ìƒì  ê°±ì‹  ì‹œê°„ (íƒ€ì„ìŠ¤íƒ¬í”„)
        let shopTimerInterval = null;
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ëœë¤ë½‘ê¸° í™”ë©´ìœ¼ë¡œ ì‹œì‘
        window.onload = function() {
             // í…ŒìŠ¤íŠ¸ìš©: localStorage ì´ˆê¸°í™” (í•œ ë²ˆë§Œ ì‹¤í–‰)
             // localStorage.removeItem('sehorory_state_v1');
             
             goToScreen(3); // ëœë¤ë½‘ê¸° í™”ë©´(ê°€ìš´ë°)ìœ¼ë¡œ ì‹œì‘
            updateProbabilityTable(); // í™•ë¥ í‘œ ì´ˆê¸°í™”
            loadState(); // ì €ì¥ëœ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
            startPlaytimeTicker();
             updateTrumpCardInfo(); // íŠ¸ëŸ¼í”„ì¹´ë“œ ì •ë³´ ì—…ë°ì´íŠ¸
             initShop(); // ìƒì  ì´ˆê¸°í™”
             updateItemStorageDisplay(); // ì•„ì´í…œ ë³´ê´€ì†Œ ì´ˆê¸°í™”
             updateCoinDisplay(); // ì„¸í˜¸ì½”ì¸ í‘œì‹œ ì—…ë°ì´íŠ¸
             updateBuffDisplay(); // ë²„í”„ í‘œì‹œ ì—…ë°ì´íŠ¸
             startBuffTimer(); // ë²„í”„ íƒ€ì´ë¨¸ ì‹œì‘
             updateDotStates(); // ë„íŠ¸ ìƒíƒœ ì´ˆê¸°í™”
             // í…Œë§ˆ ì„ íƒê¸° ì´ˆê¸°í™” (DOMì´ ì¤€ë¹„ëœ í›„)
             setTimeout(() => {
                 initThemeSelector();
                 applyTheme(currentTheme);
             }, 100);
        };
        let storage = []; // ë½‘íŒ ê²°ê³¼ ì €ì¥ì†Œ
        let startX = 0;
        let startY = 0;
        let artifactStorage = []; // ìœ ë¬¼ ì €ì¥ì†Œ
        let lastArtifactDraw = 0; // ë§ˆì§€ë§‰ ìœ ë¬¼ ë½‘ê¸° ì‹œê°„
        let baseArtifactCooldown = 180; // ê¸°ë³¸ ìœ ë¬¼ ë½‘ê¸° ì¿¨ë‹¤ìš´ (ì´ˆ)
        let totalDraws = 0; // ì´ ë½‘ê¸° íšŸìˆ˜
        let rarestItem = null; // { name, realProbabilityNum }
        let startTime = Date.now();
        let playtimeTimer = null;
        let lastEnhancementTime = 0; // ë§ˆì§€ë§‰ ê°•í™” ì‹œê°„
        let pausedTime = 0; // ì¼ì‹œì •ì§€ëœ ì‹œê°„ ëˆ„ì 
        let lastPauseTime = 0; // ë§ˆì§€ë§‰ ì¼ì‹œì •ì§€ ì‹œì 
        let enhancementCooldown = 1000; // ê°•í™” ì¿¨ë‹¤ìš´ (1ì´ˆ)
        let sehoDrawCount = 0; // ì„¸í˜¸ ë½‘ê¸° íšŸìˆ˜ ì¶”ì 

        // ìƒíƒœ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° (localStorage)
        function saveState() {
            try {
                 const data = {
                     storage,
                     artifactStorage,
                     lastArtifactDraw,
                     totalDraws,
                     rarestItem,
                     startTime,
                     pausedTime,
                     sehoDrawCount,
                     shopItems,
                     shopRefreshTime,
                     purchasedInCurrentShop,
                     sehoCoin,
                     activeBuffs,
                     purchasedThemes,
                     currentTheme,
                     itemStorage,
                     specialItemCount,
                     noCooldownCount,
                     nameChangedItems
                 };
                localStorage.setItem('sehorory_state_v1', JSON.stringify(data));
            } catch (e) { console.log('save failed'); }
        }

        // í…ŒìŠ¤íŠ¸ìš© ìœ ë¬¼ ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeTestArtifacts() {
            const artifactNames = [
                'ì„¸í˜¸ë¡œë¦¬ì˜ ë¶€ì ', 'ì„¸í˜¸í¼ë¦¬ì˜ ë¶€ì ', 'ì„¸í˜¸ê²Œì´ì˜ ë¶€ì ',
                'ë§ˆì£ ì´ìŠ¤íŠ¸ì„¸í˜¸ì˜ ë¶€ì ', 'ì”¹ë•ì„¸í˜¸ì˜ ë¶€ì ', 'TSì„¸í˜¸ì˜ ë¶€ì ',
                'ì‡¼íƒ€ì„¸í˜¸ì˜ ë¶€ì ', 'ì—ê²ì„¸í˜¸ì˜ ë¶€ì ', 'ë‹ˆê±°ì„¸í˜¸ì˜ ë¶€ì ',
                'ì„¸í˜¸ë¡œë¦¬ì˜ ì‹œê°„ê°€ì†ê¸°', 'ì„¸í˜¸ë¡œë¦¬ì˜ 7ëª©ê±¸ì´',
                'ì„¸í˜¸ë¡œë¦¬ì˜ ìœ ë¬¼ì„', 'ì„¸í˜¸ë¡œë¦¬ì˜ ë¬´ì§€ê°¯ë¹› ë³´ì„',
                'ì„¸í˜¸ë¡œë¦¬ì˜ ì‹ ì„±í•œ ë§ì¹˜', 'ì„¸í˜¸ë¡œë¦¬ì˜ íŠ¸ëŸ¼í”„ì¹´ë“œ'
            ];
            artifactNames.forEach(name => {
                artifactStorage.push({
                    name: name,
                    level: 3,
                    date: new Date().toLocaleDateString('ko-KR'),
                    time: new Date().toLocaleTimeString('ko-KR')
                });
            });
            saveState(); // ìƒíƒœ ì €ì¥
        }

        function loadState() {
            try {
                const raw = localStorage.getItem('sehorory_state_v1');
                if (!raw) {
                    // ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ìƒíƒœ ìœ ì§€
                    updateStorageDisplay();
                    initArtifactCarousel();
                    updateSettingsStats();
                    return;
                }
                const data = JSON.parse(raw);
                if (Array.isArray(data.storage)) storage = data.storage;
                if (Array.isArray(data.artifactStorage)) artifactStorage = data.artifactStorage;
                if (typeof data.lastArtifactDraw === 'number') lastArtifactDraw = data.lastArtifactDraw;
                if (typeof data.totalDraws === 'number') totalDraws = data.totalDraws;
                if (data.rarestItem) rarestItem = data.rarestItem;
                if (typeof data.startTime === 'number') startTime = data.startTime;
                if (typeof data.pausedTime === 'number') pausedTime = data.pausedTime;
                if (typeof data.sehoDrawCount === 'number') sehoDrawCount = data.sehoDrawCount;
                if (Array.isArray(data.shopItems)) shopItems = data.shopItems;
                if (typeof data.shopRefreshTime === 'number') shopRefreshTime = data.shopRefreshTime;
                if (Array.isArray(data.purchasedInCurrentShop)) purchasedInCurrentShop = data.purchasedInCurrentShop;
                if (typeof data.sehoCoin === 'number') sehoCoin = data.sehoCoin;
                if (Array.isArray(data.activeBuffs)) activeBuffs = data.activeBuffs;
                if (Array.isArray(data.purchasedThemes)) purchasedThemes = data.purchasedThemes;
                if (typeof data.currentTheme === 'string') currentTheme = data.currentTheme;
                 if (Array.isArray(data.itemStorage)) itemStorage = data.itemStorage;
                 if (typeof data.specialItemCount === 'number') specialItemCount = data.specialItemCount;
                 if (typeof data.noCooldownCount === 'number') noCooldownCount = data.noCooldownCount;
                 if (Array.isArray(data.nameChangedItems)) nameChangedItems = data.nameChangedItems;
                
                updateStorageDisplay();
                initArtifactCarousel();
                updateSettingsStats();
                // ìœ ë¬¼ ë½‘ê¸° ì¿¨ë‹¤ìš´ ë³µêµ¬
                const now = Date.now();
                const remainingMs = getArtifactCooldown() * 1000 - (now - lastArtifactDraw);
                if (remainingMs > 0) startArtifactCooldown();
            } catch (e) { console.log('load failed'); }
        }

        // ê°€ì¤‘ì¹˜ ê¸°ë°˜ ëœë¤ ì„ íƒ í•¨ìˆ˜
        function getWeightedRandom() {
            const pool = getEffectiveParticipants();
            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            let random = Math.random() * totalWeight;
            
            for (let participant of pool) {
                random -= participant.weight;
                if (random <= 0) {
                    return participant;
                }
            }
            return pool[pool.length - 1]; // fallback
        }

        // ë½‘ê¸° ì‹œì‘
        function startDraw() {
            if (isDrawing) return;
            
            if (participants.length === 0) {
                document.getElementById('resultDisplay').textContent = 'ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤!';
                return;
            }

            isDrawing = true;
            const button = document.getElementById('drawButton');
            button.textContent = 'ë½‘ëŠ” ì¤‘...';
            button.disabled = true;

            // ê²°ê³¼ í‘œì‹œ ì˜ì—­ ì´ˆê¸°í™”
            const resultDisplay = document.getElementById('resultDisplay');
            resultDisplay.textContent = 'ë½‘ëŠ” ì¤‘...';
            resultDisplay.className = 'result-display reset';
            resultDisplay.style.fontSize = '2.2em';

            // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ (ì†ë„í¬ì…˜ ì ìš©)
            let count = 0;
            const spinInterval = getSpinInterval();
            const interval = setInterval(() => {
                const randomParticipant = getWeightedRandom();
                resultDisplay.textContent = randomParticipant.name;
                resultDisplay.className = 'result-display reset';
                resultDisplay.style.fontSize = '2.2em';
                count++;
                
                if (count > 45) {
                    clearInterval(interval);
                    finishDraw();
                }
            }, spinInterval);
        }

        // ë½‘ê¸° ì™„ë£Œ
        function finishDraw() {
            const winner = getWeightedRandom(); // ê°€ì¤‘ì¹˜ ê¸°ë°˜ ëœë¤ ì„ íƒ
            
            const resultDisplay = document.getElementById('resultDisplay');
            
             // ê½ ì²˜ë¦¬: í†µê³„ ì¦ê°€ë§Œ í•˜ê³  ì¢…ë£Œ (íŠ¸ëŸ¼í”„ì¹´ë“œ íš¨ê³¼ ë°œë™ ì‹œì—ëŠ” ê½ì´ ë‚˜ì˜¬ ìˆ˜ ì—†ìŒ)
            if (winner && winner.name === 'ê½') {
                resultDisplay.textContent = 'ê½';
                resultDisplay.className = 'result-display miss';
                totalDraws += 1;
                 // ê½ì´ì–´ë„ ì„¸í˜¸ ë½‘ê¸° íšŸìˆ˜ ì¦ê°€ (íŠ¸ëŸ¼í”„ì¹´ë“œ íš¨ê³¼ë¥¼ ìœ„í•´)
                 sehoDrawCount += 1;
                updateSettingsStats();
                 updateDotStates(); // ë„íŠ¸ ìƒíƒœ ì—…ë°ì´íŠ¸
                 // íŠ¸ëŸ¼í”„ì¹´ë“œ ì •ë³´ ì—…ë°ì´íŠ¸
                 updateTrumpCardInfo();
                const button = document.getElementById('drawButton');
                button.textContent = 'ğŸ¯ ë½‘ê¸° ì‹œì‘!';
                button.disabled = false;
                isDrawing = false;
                saveState();
                return;
             }
            
            // ì„¸í˜¸ë¥¼ ë½‘ì•˜ì„ ë•Œ ì„¸í˜¸ ë½‘ê¸° íšŸìˆ˜ ì¦ê°€
            if (winner && winner.name !== 'ê½') {
                sehoDrawCount += 1;
                // íŠ¸ëŸ¼í”„ì¹´ë“œ ì •ë³´ ì—…ë°ì´íŠ¸
                updateTrumpCardInfo();
            }
            
            // ìœ ë¬¼ íš¨ê³¼ ì ìš©
            const specialEffectBonus = getSpecialEffectBonus(winner.name);
            const rainbowBonus = getRainbowBonus();
            
            // ë…ë¦½ì ì¸ 5ë‹¨ê³„ ë½‘ê¸°: ë¹›ë‚˜ëŠ” 20%, ë²ˆì©ì´ëŠ” 5%, í™©ê¸ˆ 1%, ë‹¤ì´ì•„ 0.2%, ë¬´ì§€ê°¯ë¹› 0.02%
            const random1 = Math.random();
            const random2 = Math.random();
            const random3 = Math.random();
            const random4 = Math.random();
            const random5 = Math.random();
            let effectType = 'normal';
            let displayText = winner.name;
            
            // ê½ ì²˜ë¦¬: íš¨ê³¼ ì—†ìŒ, ë³´ê´€ì†Œ ì €ì¥ ì•ˆ í•¨
            if (winner.name === 'ê½') {
                resultDisplay.textContent = 'ê½';
                resultDisplay.className = 'result-display miss';
                const button = document.getElementById('drawButton');
                button.textContent = 'ğŸ¯ ë½‘ê¸° ì‹œì‘!';
                button.disabled = false;
                isDrawing = false;
                return;
            }
            
            // íŠ¸ëŸ¼í”„ì¹´ë“œ íš¨ê³¼ í™•ì¸ (ì„¸í˜¸ë¥¼ ë½‘ì•˜ì„ ë•Œë§Œ)
            const isGuaranteedSpecial = shouldGuaranteeSpecialEffect();
            
            if (isGuaranteedSpecial) {
                // íŠ¸ëŸ¼í”„ì¹´ë“œ íš¨ê³¼ ë°œë™: ì›ë˜ íŠ¹ë³„íš¨ê³¼ ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©´ì„œ ì¼ë°˜ ì„¸í˜¸ë§Œ ì œì™¸
                const totalSpecialChance = 0.0002 * (1 + rainbowBonus) + 0.002 * (1 + specialEffectBonus) + 
                                         0.01 * (1 + specialEffectBonus) + 0.2 * (1 + specialEffectBonus) + 
                                         0.05 * (1 + specialEffectBonus);
                
                // íŠ¹ë³„íš¨ê³¼ ë¹„ìœ¨ì„ 100%ë¡œ ì •ê·œí™”
                const normalizedRainbow = (0.0002 * (1 + rainbowBonus)) / totalSpecialChance;
                const normalizedDiamond = (0.002 * (1 + specialEffectBonus)) / totalSpecialChance;
                const normalizedGolden = (0.01 * (1 + specialEffectBonus)) / totalSpecialChance;
                const normalizedShining = (0.2 * (1 + specialEffectBonus)) / totalSpecialChance;
                const normalizedSparkling = (0.05 * (1 + specialEffectBonus)) / totalSpecialChance;
                
                const specialRandom = Math.random();
                let cumulative = 0;
                
                if (specialRandom < (cumulative += normalizedRainbow)) {
                    effectType = 'rainbow';
                    displayText = `ë¬´ì§€ê°¯ë¹› ${winner.name}`;
                } else if (specialRandom < (cumulative += normalizedDiamond)) {
                    effectType = 'diamond';
                    displayText = `ë‹¤ì´ì•„ëª¬ë“œìƒ‰ ${winner.name}`;
                } else if (specialRandom < (cumulative += normalizedGolden)) {
                    effectType = 'golden';
                    displayText = `í™©ê¸ˆìƒ‰ ${winner.name}`;
                } else if (specialRandom < (cumulative += normalizedShining)) {
                    effectType = 'shining';
                    displayText = `ë¹›ë‚˜ëŠ” ${winner.name}`;
                } else {
                    effectType = 'sparkling';
                    displayText = `ë²ˆì©ì´ëŠ” ${winner.name}`;
                }
            } else {
                // ì¼ë°˜ ë½‘ê¸°: ì›ë˜ í™•ë¥ ëŒ€ë¡œ
            if (random5 < 0.0002 * (1 + rainbowBonus)) {
                effectType = 'rainbow';
                displayText = `ë¬´ì§€ê°¯ë¹› ${winner.name}`;
            } else if (random4 < 0.002 * (1 + specialEffectBonus)) {
                effectType = 'diamond';
                displayText = `ë‹¤ì´ì•„ëª¬ë“œìƒ‰ ${winner.name}`;
            } else if (random3 < 0.01 * (1 + specialEffectBonus)) {
                effectType = 'golden';
                displayText = `í™©ê¸ˆìƒ‰ ${winner.name}`;
            } else if (random1 < 0.2 * (1 + specialEffectBonus)) {
                effectType = 'shining';
                displayText = `ë¹›ë‚˜ëŠ” ${winner.name}`;
            } else if (random2 < 0.05 * (1 + specialEffectBonus)) {
                effectType = 'sparkling';
                displayText = `ë²ˆì©ì´ëŠ” ${winner.name}`;
                }
            }
            
            resultDisplay.textContent = displayText;
            
            // íš¨ê³¼ì— ë”°ë¥¸ í´ë˜ìŠ¤ ì„¤ì •
            if (effectType === 'rainbow') {
                resultDisplay.className = 'result-display rainbow';
                playRainbowSound();
            } else if (effectType === 'diamond') {
                resultDisplay.className = 'result-display diamond';
                playDiamondSound();
            } else if (effectType === 'golden') {
                resultDisplay.className = 'result-display golden';
                playGoldenSound();
            } else if (effectType === 'shining') {
                resultDisplay.className = 'result-display shining';
            } else if (effectType === 'sparkling') {
                resultDisplay.className = 'result-display sparkling';
            } else {
                resultDisplay.className = 'result-display winner';
            }
            
             // ë³´ê´€ì†Œì— ì¶”ê°€ (ì›ë³¸ ì´ë¦„ë§Œ ì „ë‹¬, effectTypeì€ ë³„ë„ë¡œ)
             addToStorage(winner.name, effectType, winner);
            totalDraws += 1;
            updateSettingsStats();
             updateDotStates(); // ë„íŠ¸ ìƒíƒœ ì—…ë°ì´íŠ¸
            saveState();
            
            // í™”ë©´ë“¤ ë™ê¸°í™” ê°±ì‹ 
            renderBelowProbability();
            updateStorageDisplay();
            
            // ë²„íŠ¼ ìƒíƒœ ë³µì›
            const button = document.getElementById('drawButton');
            button.textContent = 'ğŸ¯ ë½‘ê¸° ì‹œì‘!';
            button.disabled = false;
            isDrawing = false;
        }

        // ë³´ê´€ì†Œì— ì¶”ê°€
        function addToStorage(winner, effectType = 'normal', participant = null) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR');
            
            // ì›ë³¸ í™•ë¥  ê³„ì‚°
            const pool = getEffectiveParticipants();
            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            const participantData = participant || pool.find(p => p.name === winner);
            const baseProbabilityNum = participantData ? ((participantData.weight / totalWeight) * 100) : 0;
            const baseProbability = formatFiniteOrEllipsis(baseProbabilityNum);
            
            // ì‹¤ì œ í™•ë¥  ê³„ì‚° (íš¨ê³¼ í¬í•¨, ê°•í™” íš¨ê³¼ ë°˜ì˜)
            let realProbabilityNum = baseProbabilityNum;
            // participant.nameì„ ì‚¬ìš©í•˜ì—¬ ì›ë³¸ ì„¸í˜¸ ì´ë¦„ìœ¼ë¡œ íŠ¹ë³„íš¨ê³¼ ë³´ë„ˆìŠ¤ ê³„ì‚°
            const specialEffectBonus = getSpecialEffectBonus(participant ? participant.name : winner);
            
            if (effectType === 'rainbow') {
                // ë¬´ì§€ê°¯ë¹›ì˜ ì‹¤í™•ë¥  (ë…ë¦½ ë‹¨ê³„) í‘œê¸°: ê¸°ë³¸ í™•ë¥  * 0.0002 * (1 + ë¬´ì§€ê°¯ë¹› ë³´ì„ ë³´ë„ˆìŠ¤)
                realProbabilityNum = baseProbabilityNum * 0.0002 * (1 + getRainbowBonus());
            } else if (effectType === 'diamond') {
                realProbabilityNum = baseProbabilityNum * 0.002 * (1 + specialEffectBonus);
            } else if (effectType === 'golden') {
                realProbabilityNum = baseProbabilityNum * 0.01 * (1 + specialEffectBonus);
            } else if (effectType === 'shining') {
                realProbabilityNum = baseProbabilityNum * 0.2 * (1 + specialEffectBonus);
            } else if (effectType === 'sparkling') {
                realProbabilityNum = baseProbabilityNum * 0.05 * (1 + specialEffectBonus);
            }
            const realProbability = formatFiniteOrEllipsis(realProbabilityNum);
            // ë ˆì–´ë„ ê°±ì‹  (ê°€ì¥ ë‚®ì€ ì‹¤í™•ë¥ )
            try {
                const rp = Number(realProbabilityNum);
                if (!isNaN(rp) && rp >= 0) {
                    if (!rarestItem || rp < rarestItem.realProbabilityNum) {
                        // ì›ë³¸ ì´ë¦„ê³¼ effectTypeì„ í•¨ê»˜ ì €ì¥
                        let displayName = winner;
                        if (effectType === 'rainbow') {
                            displayName = `ğŸŒˆ ${winner} ğŸŒˆ`;
                        } else if (effectType === 'diamond') {
                            displayName = `ğŸ’ ë‹¤ì´ì•„ëª¬ë“œìƒ‰ ${winner} ğŸ’`;
                        } else if (effectType === 'golden') {
                            displayName = `ğŸ† í™©ê¸ˆìƒ‰ ${winner} ğŸ†`;
                        } else if (effectType === 'sparkling') {
                            displayName = `âš¡ ë²ˆì©ì´ëŠ” ${winner} âš¡`;
                        } else if (effectType === 'shining') {
                            displayName = `âœ¨ ë¹›ë‚˜ëŠ” ${winner} âœ¨`;
                        }
                        rarestItem = { name: displayName, realProbabilityNum: rp };
                    }
                }
            } catch (e) {}
            
            // ê°™ì€ ì•„ì´í…œì´ ìˆëŠ”ì§€ í™•ì¸ (ê°•í™” ë‹¨ê³„ë„ ê³ ë ¤)
            // ë½‘ê¸°ë¡œ ì–»ì€ ì•„ì´í…œì€ í•­ìƒ ê°•í™” ë‹¨ê³„ 0ì´ë¯€ë¡œ, ê°•í™” ë‹¨ê³„ 0ì¸ ê²ƒë§Œ ì°¾ìŒ
            const existingItem = storage.find(item => 
                item.name === winner && 
                item.effectType === effectType &&
                (item.enhanceLevel || 0) === 0
            );
            
            if (existingItem) {
                // ê°™ì€ ì•„ì´í…œì´ ìˆìœ¼ë©´ ê°œìˆ˜ ì¦ê°€
                existingItem.count = (existingItem.count || 1) + 1;
                existingItem.time = timeString; // ìµœì‹  ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                existingItem.date = now.toLocaleDateString('ko-KR');
            } else {
                // ìƒˆë¡œìš´ ì•„ì´í…œ ì¶”ê°€
            storage.push({
                name: winner,
                time: timeString,
                date: now.toLocaleDateString('ko-KR'),
                effectType: effectType,
                baseProbability: baseProbability,
                realProbability: realProbability,
                count: 1,
                enhanceLevel: 0
            });
            }
            
            // ìš©ì‚¬ì˜ ì‹¬íŒ íš¨ê³¼ ì‚¬ìš©
            if (specialItemCount > 0) {
                specialItemCount--;
            }
            
            updateStorageDisplay();
            saveState();
        }

        // ë³´ê´€ì†Œ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateStorageDisplay() {
            // ë©”ì¸ ë³´ê´€ì†Œ ì˜ì—­ (ê¸°ì¡´)
            const storageList = document.getElementById('storageList');
            // ì˜¤ë²„ë ˆì´ ë³´ê´€ì†Œ ì˜ì—­ë“¤
            const storageSehoOverlay = document.querySelector('#sehoOverlay #sehoStor .storage-list');
            const storageArtiOverlay = document.querySelector('#artiOverlay #artiStor .storage-list');
            
            if (storage.length === 0) {
                if (storageList) storageList.innerHTML = '<p>ë½‘íŒ ê²°ê³¼ê°€ ì—¬ê¸°ì— ì €ì¥ë©ë‹ˆë‹¤.</p>';
                if (storageSehoOverlay) storageSehoOverlay.innerHTML = '<p>ë½‘íŒ ê²°ê³¼ê°€ ì—¬ê¸°ì— ì €ì¥ë©ë‹ˆë‹¤.</p>';
                if (storageArtiOverlay) storageArtiOverlay.innerHTML = '<p>ë½‘íŒ ê²°ê³¼ê°€ ì—¬ê¸°ì— ì €ì¥ë©ë‹ˆë‹¤.</p>';
                return;
            }

            // ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ ê°•í™” ë²„íŠ¼ ì²˜ë¦¬ (ë©”ì¸/ì˜¤ë²„ë ˆì´ ê°ê°)
            function bindUpgradeDelegation(host) {
                if (!host) return;
                host.onclick = (e) => {
                    const target = e.target;
                    if (target && target.classList && target.classList.contains('action-upgrade')) {
                        const itemDiv = target.closest('.storage-item');
                        if (!itemDiv) return;
                        const idxAttr = itemDiv.getAttribute('data-index');
                        if (idxAttr == null) return;
                        const idx = parseInt(idxAttr, 10);
                        performUpgrade(idx);
                        e.stopPropagation();
                    }
                };
            }

            bindUpgradeDelegation(storageList);
            bindUpgradeDelegation(storageSehoOverlay);
            bindUpgradeDelegation(storageArtiOverlay);

            // í™•ë¥ ì´ ë‚®ì€ ìˆœìœ¼ë¡œ ì •ë ¬ (ê°•í™”ëœ í™•ë¥  ê¸°ì¤€)
            const sortedStorage = [...storage].sort((a, b) => {
                // ê°•í™”ëœ í™•ë¥  ê³„ì‚°
                const getEffectiveProbability = (item) => {
                    const baseProb = parseFloat(item.realProbability) || 0;
                    const level = item.enhanceLevel || 0;
                    if (level === 0) return baseProb;
                    
                    // ê°•í™” ë‹¨ê³„ì— ë”°ë¥¸ ì„±ê³µ í™•ë¥ ë“¤
                    const enhanceChances = [0.8, 0.7, 0.55, 0.35, 0.1];
                    let effectiveProb = baseProb;
                    
                    // ê° ê°•í™” ë‹¨ê³„ì˜ ì„±ê³µ í™•ë¥ ì„ ê³±í•´ì„œ ìµœì¢… í™•ë¥  ê³„ì‚°
                    for (let i = 0; i < level; i++) {
                        effectiveProb *= enhanceChances[i] || 1;
                    }
                    
                    return effectiveProb;
                };
                
                const aProb = getEffectiveProbability(a);
                const bProb = getEffectiveProbability(b);
                
                // í™•ë¥ ì´ ë‚®ì€ ìˆœìœ¼ë¡œ ì •ë ¬
                return aProb - bProb;
            });

            if (storageList) storageList.innerHTML = '';
            if (storageSehoOverlay) storageSehoOverlay.innerHTML = '';
            if (storageArtiOverlay) storageArtiOverlay.innerHTML = '';
            
            // 2ê°œì”© ê·¸ë£¹ìœ¼ë¡œ ë‚˜ëˆ„ì–´ í‘œì‹œ
            for (let i = 0; i < sortedStorage.length; i += 2) {
                const row = document.createElement('div');
                row.className = 'storage-row';
                
                for (let j = 0; j < 2 && i + j < sortedStorage.length; j++) {
                    const item = sortedStorage[i + j];
                    const div = document.createElement('div');
                    
                     div.className = `storage-item ${item.effectType}`;
                     const originalIndex = storage.indexOf(item);
                     div.setAttribute('data-index', String(originalIndex));
                     
                     // ì´ë¦„ì´ ë°”ë€ ì•„ì´í…œ í‘œì‹œ
                     if (nameChangedItems.includes(originalIndex)) {
                         div.style.border = '3px solid #ff6b6b';
                         div.style.animation = 'pulse 1s ease-in-out infinite';
                     }
                    
                    // ê°•í™” ë‹¨ê³„ì— ë”°ë¥¸ ì‹œê°ì  íš¨ê³¼ ì ìš©
                    const enhanceLevel = item.enhanceLevel || 0;
                    if (enhanceLevel > 0) {
                        div.setAttribute('data-enhance-level', String(enhanceLevel));
                    }
                    
                    let displayName = item.name;
                    const level = Math.max(0, item.enhanceLevel || 0);
                    if (level > 0) displayName = `${displayName} (+${level})`;
                    let probabilityText = `${item.realProbability}%`;
                    
                    if (item.effectType === 'rainbow') {
                        displayName = `ğŸŒˆ ${displayName} ğŸŒˆ`;
                    } else if (item.effectType === 'diamond') {
                        displayName = `ğŸ’ ë‹¤ì´ì•„ëª¬ë“œìƒ‰ ${displayName} ğŸ’`;
                    } else if (item.effectType === 'golden') {
                        displayName = `ğŸ† í™©ê¸ˆìƒ‰ ${displayName} ğŸ†`;
                    } else if (item.effectType === 'sparkling') {
                        displayName = `âš¡ ë²ˆì©ì´ëŠ” ${displayName} âš¡`;
                    } else if (item.effectType === 'shining') {
                        displayName = `âœ¨ ë¹›ë‚˜ëŠ” ${displayName} âœ¨`;
                    }
                    
                    let countHtml = '';
                    if (item.count && item.count > 1) {
                        countHtml = `<div class="count">Ã—${item.count}</div>`;
                    }
                    
                    const infoText = getEnhanceInfoText(level);
                    const rates = calculateEnhanceRates(level);
                    const enhancedLabel = level > 0 ? '<div class="enhanced-label">(ê°•í™”ë¨)</div>' : '';
                    
                    // ìœ ë¬¼ íš¨ê³¼ê°€ ìˆì„ ë•Œ ìƒ‰ìƒ ì ìš©
                    const successColor = rates.hasArtifactEffect ? 'style="color: #87CEEB;"' : '';
                    const destroyColor = rates.hasArtifactEffect ? 'style="color: #87CEEB;"' : '';
                    
                    div.innerHTML = `
                        <button class=\"sell-button\" onclick=\"sellItem(${originalIndex}, event)\" title=\"íŒë§¤\">ğŸ—‘ï¸</button>
                        <div class=\"name\">${displayName}</div>
                        <div class=\"probability\">${probabilityText}</div>
                        ${enhancedLabel}
                        <div class=\"time\">${item.date} ${item.time}</div>
                        ${countHtml}
                        <div class=\"enhance-stats\">ì„±ê³µí™•ë¥ : <span ${successColor}>${formatPercent(rates.success)}</span><br>íŒŒê´´í™•ë¥ : <span ${destroyColor}>${formatPercent(rates.destroy)}</span></div>
                        <div class=\"action-btn action-upgrade\">ê°•í™”í•˜ê¸°</div>
                    `;

                    const upgBtn = div.querySelector('.action-upgrade');
                    if (upgBtn) {
                        if (level >= 5) {
                            upgBtn.style.opacity = '0.5';
                            upgBtn.style.cursor = 'not-allowed';
                            upgBtn.disabled = true;
                        } else {
                            // ì¿¨íƒ€ì„ í™•ì¸
                            const now = Date.now();
                            const isOnCooldown = (now - lastEnhancementTime) < enhancementCooldown;
                            
                            if (isOnCooldown) {
                                upgBtn.disabled = true;
                                upgBtn.style.opacity = '0.5';
                                upgBtn.style.cursor = 'not-allowed';
                                upgBtn.style.backgroundColor = '#adb5bd';
                                upgBtn.textContent = 'ì¿¨íƒ€ì„...';
                            } else {
                                upgBtn.disabled = false;
                                upgBtn.style.opacity = '1';
                                upgBtn.style.cursor = 'pointer';
                                upgBtn.style.backgroundColor = '#28a745';
                                upgBtn.textContent = 'ê°•í™”í•˜ê¸°';
                                upgBtn.onclick = (e) => { performUpgrade(originalIndex); e.stopPropagation(); };
                            }
                        }
                    }
                    row.appendChild(div);
                }
                
                if (storageList) storageList.appendChild(row);
                if (storageSehoOverlay) storageSehoOverlay.appendChild(row.cloneNode(true));
                if (storageArtiOverlay) storageArtiOverlay.appendChild(row.cloneNode(true));
            }
        }

        // ì˜¤ë²„ë ˆì´ ì´ˆê¸°í™”/ì œì–´
        function initOverlayPanels() {
            // ì„¸í˜¸ ì˜¤ë²„ë ˆì´
            const sehoOverlay = document.createElement('div');
            sehoOverlay.id = 'sehoOverlay';
            sehoOverlay.className = 'overlay';
            sehoOverlay.innerHTML = `
                <div class="overlay-header">
                    <button class="tab-button active" data-target="sehoProb" onclick="switchOverlayTab(event, 'sehoOverlay')">í™•ë¥ í‘œ</button>
                    <button class="tab-button" data-target="sehoStor" onclick="switchOverlayTab(event, 'sehoOverlay')">ë³´ê´€ì†Œ</button>
                </div>
                <div id="sehoProb" class="panel-content"></div>
                <div id="sehoStor" class="panel-content" style="display:none"><div class="storage-list"></div></div>
            `;
            document.body.appendChild(sehoOverlay);

            // ìœ ë¬¼ ì˜¤ë²„ë ˆì´
            const artiOverlay = document.createElement('div');
            artiOverlay.id = 'artiOverlay';
            artiOverlay.className = 'overlay';
            artiOverlay.innerHTML = `
                <div class="overlay-header">
                    <button class="tab-button active" data-target="artiColl" onclick="switchOverlayTab(event, 'artiOverlay')">ìœ ë¬¼ ì»¬ë ‰ì…˜</button>
                    <button class="tab-button" data-target="artiStor" onclick="switchOverlayTab(event, 'artiOverlay')">ë³´ê´€ì†Œ</button>
                </div>
                <div id="artiColl" class="panel-content"><div class="artifact-grid" id="artifactGridOverlay"></div></div>
                <div id="artiStor" class="panel-content" style="display:none"><div class="storage-list"></div></div>
            `;
            document.body.appendChild(artiOverlay);

            renderOverlayProbability();
            updateStorageDisplay();
            initArtifactCollection();
        }

        // ê°•í™” ì‹œìŠ¤í…œ
        const enhanceChances = [0.8, 0.7, 0.55, 0.35, 0.1]; // 0->1 ... 4->5 (ì›ë˜ í™•ë¥ )

        function formatPercent(p) { return Math.round(p * 1000) / 10 + '%'; }

        // ì„¸í˜¸ë¡œë¦¬ì˜ ì‹ ì„±í•œ ë§ì¹˜ ìœ ë¬¼ íš¨ê³¼ í™•ì¸
        function getHammerArtifactEffect() {
            const hammer = artifactStorage.find(item => item.name === 'ì„¸í˜¸ë¡œë¦¬ì˜ ì‹ ì„±í•œ ë§ì¹˜');
            return hammer ? hammer.level : 0;
        }

        // ì„¸í˜¸ë¡œë¦¬ì˜ íŠ¸ëŸ¼í”„ì¹´ë“œ ìœ ë¬¼ íš¨ê³¼ í™•ì¸
        function getTrumpCardArtifactEffect() {
            const trumpCard = artifactStorage.find(item => item.name === 'ì„¸í˜¸ë¡œë¦¬ì˜ íŠ¸ëŸ¼í”„ì¹´ë“œ');
            return trumpCard ? trumpCard.level : 0;
        }

        // íŠ¸ëŸ¼í”„ì¹´ë“œ íš¨ê³¼ë¡œ íŠ¹ë³„íš¨ê³¼ ë³´ì¥ ì—¬ë¶€ í™•ì¸
        function shouldGuaranteeSpecialEffect() {
            const trumpLevel = getTrumpCardArtifactEffect();
            if (trumpLevel === 0) return false;
            
            // ë ˆë²¨ë³„ ë³´ì¥ íšŸìˆ˜: 25íšŒ/15íšŒ/10íšŒ
            const guaranteeInterval = trumpLevel === 1 ? 25 : trumpLevel === 2 ? 15 : 10;
            // 1ë²ˆì§¸, 26ë²ˆì§¸, 51ë²ˆì§¸... ì—ì„œ ë°œë™ (0ì´ ì•„ë‹Œ 1ë¶€í„° ì‹œì‘)
            return sehoDrawCount > 0 && sehoDrawCount % guaranteeInterval === 1;
        }

        // íŠ¸ëŸ¼í”„ì¹´ë“œ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateTrumpCardInfo() {
            const trumpCardInfo = document.getElementById('trumpCardInfo');
            const trumpLevel = getTrumpCardArtifactEffect();
            
            if (trumpLevel > 0) {
                const guaranteeInterval = trumpLevel === 1 ? 25 : trumpLevel === 2 ? 15 : 10;
                const nextGuarantee = guaranteeInterval - ((sehoDrawCount - 1) % guaranteeInterval);
                
                if (nextGuarantee === 1) {
                    trumpCardInfo.innerHTML = `ğŸ´ íŠ¸ëŸ¼í”„ì¹´ë“œ íš¨ê³¼: ì¤€ë¹„ ì™„ë£Œ! ë‹¤ìŒ ë½‘ê¸°ì—ì„œ íŠ¹ë³„íš¨ê³¼ ë³´ì¥`;
                } else {
                    trumpCardInfo.innerHTML = `ğŸ´ íŠ¸ëŸ¼í”„ì¹´ë“œ íš¨ê³¼: ${nextGuarantee}íšŒ í›„ íŠ¹ë³„íš¨ê³¼ ë³´ì¥`;
                }
                trumpCardInfo.style.display = 'block';
            } else {
                trumpCardInfo.style.display = 'none';
            }
        }

        // ê°•í™” í™•ë¥  ê³„ì‚° (ìœ ë¬¼ íš¨ê³¼ í¬í•¨)
        function calculateEnhanceRates(level) {
            const baseSuccess = enhanceChances[level] || 0;
            const baseFail = 1 - baseSuccess;
            const baseDestroy = baseFail * 0.10;
            
            const hammerLevel = getHammerArtifactEffect();
            let finalSuccess = baseSuccess;
            let finalDestroy = baseDestroy;
            
            if (hammerLevel > 0) {
                // íŒŒê´´í™•ë¥  ê°ì†ŒëŸ‰ ê³„ì‚°: ë ˆë²¨ë³„ ê³ ì • ìˆ˜ì¹˜ 0.5%/1%/2%
                const destroyReduction = hammerLevel === 1 ? 0.005 : hammerLevel === 2 ? 0.01 : 0.02;
                const reducedDestroy = Math.max(0, baseDestroy - destroyReduction);
                const destroyReductionAmount = baseDestroy - reducedDestroy;
                
                // ê°ì†Œëœ íŒŒê´´í™•ë¥ ì„ ì„±ê³µí™•ë¥ ì— ì¶”ê°€
                finalSuccess = baseSuccess + destroyReductionAmount;
                finalDestroy = reducedDestroy;
            }
            
            return { success: finalSuccess, destroy: finalDestroy, hasArtifactEffect: hammerLevel > 0 };
        }

        function getEnhanceInfoText(level) {
            if (level >= 5) return 'ìµœëŒ€ ê°•í™” ë‹¨ê³„(5ê°•)ì…ë‹ˆë‹¤.';
            const rates = calculateEnhanceRates(level);
            const colorStyle = rates.hasArtifactEffect ? 'style="color: #87CEEB;"' : '';
            return `ê°•í™” í™•ë¥ : <span ${colorStyle}>${formatPercent(rates.success)}</span> / íŒŒê´´ í™•ë¥ : <span ${colorStyle}>${formatPercent(rates.destroy)}</span> (ì‹¤íŒ¨ ì‹œ 1ë‹¨ê³„ í•˜ë½, 0ê°• ë¯¸ë§Œ í•˜ë½ ì—†ìŒ)`;
        }

        function injectEnhanceControls(container, index) {
            const item = storage[index];
            if (!item) return;
            const level = Math.max(0, item.enhanceLevel || 0);
            const info = document.createElement('div');
            info.className = 'enhance-info';
            info.textContent = getEnhanceInfoText(level);
            container.appendChild(info);

            const back = document.createElement('div');
            back.className = 'action-btn action-back';
            back.textContent = 'ë’¤ë¡œê°€ê¸°';
            back.onclick = (e) => {
                container.classList.remove('selected');
                if (info) info.remove();
                back.remove();
                if (upg) upg.remove();
                e.stopPropagation();
            };
            container.appendChild(back);

            const upg = document.createElement('div');
            upg.className = 'action-btn action-upgrade';
            upg.textContent = 'ê°•í™”í•˜ê¸°';
            if (level >= 5) {
                upg.style.opacity = '0.5';
                upg.style.cursor = 'not-allowed';
            } else {
                upg.onclick = (e) => {
                    performUpgrade(index);
                    e.stopPropagation();
                };
            }
            container.appendChild(upg);
        }

         function performUpgrade(index) {
             const item = storage[index];
             if (!item) return;
             
             // ì¿¨íƒ€ì„ í™•ì¸ (ì£¼ë§ íš¨ê³¼ê°€ ìˆìœ¼ë©´ ì¿¨íƒ€ì„ ë¬´ì‹œ)
             const now = Date.now();
             if (noCooldownCount <= 0 && now - lastEnhancementTime < enhancementCooldown) {
                 const remainingTime = Math.ceil((enhancementCooldown - (now - lastEnhancementTime)) / 1000);
                 alert(`ê°•í™” ì¿¨íƒ€ì„ ì¤‘ì…ë‹ˆë‹¤. ${remainingTime}ì´ˆ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
                 return;
             }
             
             // ì£¼ë§ íš¨ê³¼ ì‚¬ìš©
             if (noCooldownCount > 0) {
                 noCooldownCount--;
             }
            
            // ê°•í™” ì‹œì‘ ì‚¬ìš´ë“œ
            playEnhanceStartSound();
            
            let level = Math.max(0, item.enhanceLevel || 0);
            if (level >= 5) return;
            
            // ìœ ë¬¼ íš¨ê³¼ë¥¼ í¬í•¨í•œ ê°•í™” í™•ë¥  ê³„ì‚°
            const rates = calculateEnhanceRates(level);
            const success = rates.success;
            const destroy = rates.destroy;
            const r = Math.random();
            if (r < success) {
                level += 1;
                
                // ê°•í™” ì„±ê³µ ì‹œ - ê°™ì€ ê°•í™” ë‹¨ê³„ ì•„ì´í…œì´ ìˆìœ¼ë©´ í•©ì¹˜ê¸°
                const now = new Date();
                const timeString = now.toLocaleTimeString('ko-KR');
                
                // ê°™ì€ ê°•í™” ë‹¨ê³„ì˜ ì•„ì´í…œì´ ìˆëŠ”ì§€ í™•ì¸
                const existingEnhancedItem = storage.find(storageItem => 
                    storageItem.name === item.name && 
                    storageItem.effectType === item.effectType &&
                    (storageItem.enhanceLevel || 0) === level
                );
                
                if (existingEnhancedItem) {
                    // ê°™ì€ ê°•í™” ë‹¨ê³„ê°€ ìˆìœ¼ë©´ ê°œìˆ˜ ì¦ê°€
                    existingEnhancedItem.count = (existingEnhancedItem.count || 1) + 1;
                    existingEnhancedItem.time = timeString;
                    existingEnhancedItem.date = now.toLocaleDateString('ko-KR');
                } else {
                    // ìƒˆë¡œìš´ ê°•í™” ë‹¨ê³„ ì•„ì´í…œ ì¶”ê°€
                    const newItem = {
                        name: item.name,
                        time: timeString,
                        date: now.toLocaleDateString('ko-KR'),
                        effectType: item.effectType,
                        baseProbability: item.baseProbability,
                        realProbability: item.realProbability,
                        count: 1,
                        enhanceLevel: level
                    };
                    storage.push(newItem);
                }
                
                // ê¸°ì¡´ ì•„ì´í…œ ê°œìˆ˜ ê°ì†Œ ë˜ëŠ” ì œê±°
                if ((item.count || 1) > 1) {
                    item.count -= 1;
                } else {
                    storage.splice(index, 1);
                }
                
                // ê°•í™” ì„±ê³µ ì‚¬ìš´ë“œ (5ê°•ì€ íŠ¹ë³„í•œ ì‚¬ìš´ë“œ)
                if (level === 5) {
                    setTimeout(() => playMaxEnhanceSuccessSound(), 200);
                } else {
                    setTimeout(() => playEnhanceSuccessSound(), 200);
                }
            } else {
                // ì‹¤íŒ¨
                const r2 = Math.random();
                if (r2 < destroy) {
                    // íŒŒê´´: ë™ì¼ í•­ëª© ìˆ˜ëŸ‰ ê°ì†Œ ë˜ëŠ” ì œê±°
                    if ((item.count || 1) > 1) {
                        item.count -= 1;
                    } else {
                        storage.splice(index, 1);
                    }
                    // íŒŒê´´ ì‚¬ìš´ë“œ
                    setTimeout(() => playEnhanceDestroySound(), 200);
                } else {
                    // í•˜ë½: 0 ë¯¸ë§Œìœ¼ë¡œëŠ” ë‚´ë ¤ê°€ì§€ ì•ŠìŒ
                    const newLevel = Math.max(0, level - 1);
                    
                    if (newLevel !== level) {
                        // ê°•í™” ë‹¨ê³„ê°€ ë°”ë€ŒëŠ” ê²½ìš°
                        const now = new Date();
                        const timeString = now.toLocaleTimeString('ko-KR');
                        
                        // ê°™ì€ ê°•í™” ë‹¨ê³„ì˜ ì•„ì´í…œì´ ìˆëŠ”ì§€ í™•ì¸
                        const existingItem = storage.find(storageItem => 
                            storageItem.name === item.name && 
                            storageItem.effectType === item.effectType &&
                            (storageItem.enhanceLevel || 0) === newLevel
                        );
                        
                        if (existingItem) {
                            // ê°™ì€ ê°•í™” ë‹¨ê³„ê°€ ìˆìœ¼ë©´ ê°œìˆ˜ ì¦ê°€
                            existingItem.count = (existingItem.count || 1) + 1;
                            existingItem.time = timeString;
                            existingItem.date = now.toLocaleDateString('ko-KR');
                        } else {
                            // ìƒˆë¡œìš´ ê°•í™” ë‹¨ê³„ ì•„ì´í…œ ì¶”ê°€
                            const newItem = {
                                name: item.name,
                                time: timeString,
                                date: now.toLocaleDateString('ko-KR'),
                                effectType: item.effectType,
                                baseProbability: item.baseProbability,
                                realProbability: item.realProbability,
                                count: 1,
                                enhanceLevel: newLevel
                            };
                            storage.push(newItem);
                        }
                        
                        // ê¸°ì¡´ ì•„ì´í…œ ê°œìˆ˜ ê°ì†Œ ë˜ëŠ” ì œê±°
                        if ((item.count || 1) > 1) {
                            item.count -= 1;
                        } else {
                            storage.splice(index, 1);
                        }
                    }
                    
                    // ì‹¤íŒ¨ ì‚¬ìš´ë“œ
                    setTimeout(() => playEnhanceFailSound(), 200);
                }
            }
            
            // ê°•í™” ì‹œê°„ ê¸°ë¡
            lastEnhancementTime = now;
            
            // ëª¨ë“  ê°•í™” ë²„íŠ¼ ë¹„í™œì„±í™”
            disableAllEnhanceButtons();
            
            // 1ì´ˆ í›„ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
            setTimeout(() => {
                enableAllEnhanceButtons();
            }, enhancementCooldown);
            
            saveState();
            updateStorageDisplay();
        }

        // ëª¨ë“  ê°•í™” ë²„íŠ¼ ë¹„í™œì„±í™”
        function disableAllEnhanceButtons() {
            const buttons = document.querySelectorAll('.action-upgrade');
            buttons.forEach(button => {
                button.disabled = true;
                button.style.opacity = '0.5';
                button.style.cursor = 'not-allowed';
                button.style.backgroundColor = '#adb5bd';
                button.textContent = 'ê°•í™”ì¤‘';
            });
        }

        // ëª¨ë“  ê°•í™” ë²„íŠ¼ í™œì„±í™”
        function enableAllEnhanceButtons() {
            const buttons = document.querySelectorAll('.action-upgrade');
            buttons.forEach(button => {
                const itemDiv = button.closest('.storage-item');
                if (!itemDiv) return;
                
                const idxAttr = itemDiv.getAttribute('data-index');
                if (idxAttr == null) return;
                const idx = parseInt(idxAttr, 10);
                const item = storage[idx];
                
                if (item && (item.enhanceLevel || 0) < 5) {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                    button.style.backgroundColor = '#28a745';
                    button.textContent = 'ê°•í™”í•˜ê¸°';
                }
            });
        }

        function switchOverlayTab(e, overlayId) {
            const overlay = document.getElementById(overlayId);
            overlay.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            e.currentTarget.classList.add('active');
            const target = e.currentTarget.getAttribute('data-target');
            overlay.querySelectorAll('.panel-content').forEach(p => p.style.display = 'none');
            overlay.querySelector('#' + target).style.display = 'block';
            if (target.endsWith('Stor')) updateStorageDisplay();
            if (target === 'artiColl') initArtifactCollection();
        }

        function openOverlay(which) {
            if (which === 'seho') {
                document.getElementById('sehoOverlay').classList.add('open');
                renderOverlayProbability();
                updateStorageDisplay();
            } else if (which === 'arti') {
                document.getElementById('artiOverlay').classList.add('open');
                initArtifactCollection();
                updateStorageDisplay();
            }
        }

        function closeOverlays() {
            const s = document.getElementById('sehoOverlay');
            const a = document.getElementById('artiOverlay');
            if (s) s.classList.remove('open');
            if (a) a.classList.remove('open');
        }

        function renderOverlayProbability() {
            const probHost = document.querySelector('#sehoOverlay #sehoProb');
            if (!probHost) return;
            const pool = getEffectiveParticipants();
            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            const sortedParticipants = [...pool].sort((a, b) => b.weight - a.weight);
            let listHTML = '<div class="probability-list" id="probListInline">';
            sortedParticipants.forEach(participant => {
                const probability = ((participant.weight / totalWeight) * 100).toFixed(2);
                if (participant.name === 'ê½') {
                    listHTML += `
                        <div class="probability-item no-hover">
                            <span class="participant-name">${participant.name}</span>
                            <span class="probability-value">${probability}%</span>
                        </div>
                    `;
                    return;
                }
                // ìœ ë¬¼ íš¨ê³¼ ì ìš©
                const specialEffectBonus = getSpecialEffectBonus(participant.name);
                const rainbowBonus = getRainbowBonus();
                
                const rainbowProbability = (probability * 0.0002 * (1 + rainbowBonus)).toFixed(5);
                const diamondProbability = (probability * 0.002 * (1 + specialEffectBonus)).toFixed(4);
                const goldenProbability = (probability * 0.01 * (1 + specialEffectBonus)).toFixed(3);
                const shiningProbability = (probability * 0.2 * (1 + specialEffectBonus)).toFixed(2);
                const sparklingProbability = (probability * 0.05 * (1 + specialEffectBonus)).toFixed(3);
                
                listHTML += `
                    <div class="probability-item">
                        <span class="participant-name">${participant.name}</span>
                        <span class="probability-value">${probability}%</span>
                        <div class="shining-info">
                            <div class="effect-title">
                                <span>âœ¨</span>
                                <span>íŠ¹ë³„ íš¨ê³¼ í™•ë¥ </span>
                            </div>
                            <div class="effect-probability">
                                âœ¨ ë¹›ë‚˜ëŠ” ${participant.name}: ${shiningProbability}% <span class="artifact-effect">(+${(shiningProbability - (probability * 0.2)).toFixed(2)}%)</span>
                                <small>(ë½‘íŒ í›„ 20% í™•ë¥ )</small>
                            </div>
                            <div class="effect-probability">
                                âš¡ ë²ˆì©ì´ëŠ” ${participant.name}: ${sparklingProbability}% <span class="artifact-effect">(+${(sparklingProbability - (probability * 0.05)).toFixed(3)}%)</span>
                                <small>(ë½‘íŒ í›„ 5% í™•ë¥ )</small>
                            </div>
                            <div class="effect-probability">
                                ğŸ† í™©ê¸ˆìƒ‰ ${participant.name}: ${goldenProbability}% <span class="artifact-effect">(+${(goldenProbability - (probability * 0.01)).toFixed(3)}%)</span>
                                <small>(ë½‘íŒ í›„ 1% í™•ë¥ )</small>
                            </div>
                            <div class="effect-probability">
                                ğŸ’ ë‹¤ì´ì•„ëª¬ë“œìƒ‰ ${participant.name}: ${diamondProbability}% <span class="artifact-effect">(+${(diamondProbability - (probability * 0.002)).toFixed(4)}%)</span>
                                <small>(ë½‘íŒ í›„ 0.2% í™•ë¥ )</small>
                            </div>
                            <div class="effect-probability">
                                ğŸŒˆ ë¬´ì§€ê°¯ë¹› ${participant.name}: ${rainbowProbability}% <span class="artifact-effect">(+${(rainbowProbability - (probability * 0.0002)).toFixed(5)}%)</span>
                                <small>(ë½‘íŒ í›„ 0.02% í™•ë¥ )</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            listHTML += '</div>';
            probHost.innerHTML = listHTML;
            attachProbabilityToggle('probListOverlay');
        }

        // ì„¸í˜¸ ì¸ë¼ì¸ íŒ¨ë„ ì´ˆê¸°í™” ë° í† ê¸€/íƒ­
        function initInlinePanels() {
            // ì²˜ìŒ ì—´ë¦´ ë•Œ í˜„ì¬ í™•ë¥ í‘œë¥¼ ì¸ë¼ì¸ì—ë„ ë Œë”
            renderInlineProbability();
        }

        function toggleSehoPanel() {
            const panel = document.getElementById('sehoExtraPanel');
            panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none';
            if (panel.style.display === 'block') {
                // ì—´ë¦´ ë•Œ ìµœì‹  ë°ì´í„°ë¡œ ê°±ì‹ 
                renderInlineProbability();
                updateStorageDisplay();
            }
        }

        function switchSehoTab(e) {
            document.querySelectorAll('#sehoExtraPanel .tab-button').forEach(btn => btn.classList.remove('active'));
            e.currentTarget.classList.add('active');
            const target = e.currentTarget.getAttribute('data-target');
            const prob = document.getElementById('probabilityContentInline');
            const stor = document.getElementById('storageListInline');
            if (target === 'probabilityContentInline') {
                prob.style.display = 'block';
                stor.style.display = 'none';
                renderInlineProbability();
            } else {
                prob.style.display = 'none';
                stor.style.display = 'block';
                updateStorageDisplay();
            }
        }

        function renderInlineProbability() {
            const inline = document.getElementById('probabilityContentInline');
            if (!inline) return;
            // ê¸°ì¡´ updateProbabilityTable ë¡œì§ì„ ì¬ì‚¬ìš©í•˜ì—¬ HTML ìƒì„±
            const pool = getEffectiveParticipants();
            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            const sortedParticipants = [...pool].sort((a, b) => b.weight - a.weight);
            let listHTML = '<div class="probability-list" id="probListOverlay">';
            sortedParticipants.forEach(participant => {
                const probNum = (participant.weight / totalWeight) * 100;
                const probability = formatFiniteOrEllipsis(probNum);
                if (participant.name === 'ê½') {
                    listHTML += `
                        <div class="probability-item no-hover">
                            <span class="participant-name">${participant.name}</span>
                            <span class="probability-value">${probability}%</span>
                        </div>
                    `;
                    return;
                }
                // ìœ ë¬¼ íš¨ê³¼ ì ìš©
                const specialEffectBonus = getSpecialEffectBonus(participant.name);
                const rainbowBonus = getRainbowBonus();
                
                const rainbowProbability = formatFiniteOrEllipsis(probNum * 0.0002 * (1 + rainbowBonus));
                const diamondProbability = formatFiniteOrEllipsis(probNum * 0.002 * (1 + specialEffectBonus));
                const goldenProbability = formatFiniteOrEllipsis(probNum * 0.01 * (1 + specialEffectBonus));
                const shiningProbability = formatFiniteOrEllipsis(probNum * 0.2 * (1 + specialEffectBonus));
                const sparklingProbability = formatFiniteOrEllipsis(probNum * 0.05 * (1 + specialEffectBonus));
                
                listHTML += `
                    <div class="probability-item">
                        <span class="participant-name">${participant.name}</span>
                        <span class="probability-value">${probability}%</span>
                        <div class="shining-info">
                            <div class="effect-title">
                                <span>âœ¨</span>
                                <span>íŠ¹ë³„ íš¨ê³¼ í™•ë¥ </span>
                            </div>
                            <div class="effect-probability">
                                âœ¨ ë¹›ë‚˜ëŠ” ${participant.name}: ${shiningProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.2 * specialEffectBonus)}%)</span>
                                <small>(ë½‘íŒ í›„ 20% í™•ë¥ )</small>
                            </div>
                            <div class="effect-probability">
                                âš¡ ë²ˆì©ì´ëŠ” ${participant.name}: ${sparklingProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.05 * specialEffectBonus)}%)</span>
                                <small>(ë½‘íŒ í›„ 5% í™•ë¥ )</small>
                            </div>
                            <div class="effect-probability">
                                ğŸ† í™©ê¸ˆìƒ‰ ${participant.name}: ${goldenProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.01 * specialEffectBonus)}%)</span>
                                <small>(ë½‘íŒ í›„ 1% í™•ë¥ )</small>
                            </div>
                            <div class="effect-probability">
                                ğŸ’ ë‹¤ì´ì•„ëª¬ë“œìƒ‰ ${participant.name}: ${diamondProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.002 * specialEffectBonus)}%)</span>
                                <small>(ë½‘íŒ í›„ 0.2% í™•ë¥ )</small>
                            </div>
                            <div class="effect-probability">
                                ğŸŒˆ ë¬´ì§€ê°¯ë¹› ${participant.name}: ${rainbowProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.0002 * rainbowBonus)}%)</span>
                                <small>(ë½‘íŒ í›„ 0.02% í™•ë¥ )</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            listHTML += '</div>';
            inline.innerHTML = listHTML;
            attachProbabilityToggle('probListInline');
        }

        // ìœ ë¬¼ ì»¬ë ‰ì…˜ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
        function initArtifactCarousel() {
            const grid = document.getElementById('artifactGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            // ìœ ë¬¼ ì´ë¦„ë“¤ (ì»¬ë ‰ì…˜)
            const artifactNames = [
                'ì„¸í˜¸ë¡œë¦¬ì˜ ë¶€ì ', 'ì„¸í˜¸í¼ë¦¬ì˜ ë¶€ì ', 'ì„¸í˜¸ê²Œì´ì˜ ë¶€ì ',
                'ë§ˆì£ ì´ìŠ¤íŠ¸ì„¸í˜¸ì˜ ë¶€ì ', 'ì”¹ë•ì„¸í˜¸ì˜ ë¶€ì ', 'TSì„¸í˜¸ì˜ ë¶€ì ',
                'ì‡¼íƒ€ì„¸í˜¸ì˜ ë¶€ì ', 'ì—ê²ì„¸í˜¸ì˜ ë¶€ì ', 'ë‹ˆê±°ì„¸í˜¸ì˜ ë¶€ì ',
                'ì„¸í˜¸ë¡œë¦¬ì˜ ì‹œê°„ê°€ì†ê¸°', 'ì„¸í˜¸ë¡œë¦¬ì˜ 7ëª©ê±¸ì´',
                'ì„¸í˜¸ë¡œë¦¬ì˜ ìœ ë¬¼ì„', 'ì„¸í˜¸ë¡œë¦¬ì˜ ë¬´ì§€ê°¯ë¹› ë³´ì„',
                'ì„¸í˜¸ë¡œë¦¬ì˜ ì‹ ì„±í•œ ë§ì¹˜', 'ì„¸í˜¸ë¡œë¦¬ì˜ íŠ¸ëŸ¼í”„ì¹´ë“œ'
            ];
            
            
            for (let i = 0; i < artifactNames.length; i++) {
                const card = document.createElement('div');
                const isLocked = false; // í…ŒìŠ¤íŠ¸ìš©: ëª¨ë“  ìœ ë¬¼ì´ ì ê²¨ìˆì§€ ì•ŠìŒ
                card.className = 'artifact-card' + (isLocked ? ' locked' : '');
                
                // ì•ë©´
                const front = document.createElement('div');
                front.className = 'artifact-front';
                front.textContent = artifactNames[i];
                
                // ë’·ë©´
                const back = document.createElement('div');
                back.className = 'artifact-back';
                
                // ì‹¤ì œ ìœ ë¬¼ ë ˆë²¨ í™•ì¸
                const ownedArtifact = artifactStorage.find(item => item.name === artifactNames[i]);
                const artifactLevel = ownedArtifact ? ownedArtifact.level : 0;
                
                const level = document.createElement('div');
                level.className = 'artifact-level';
                level.textContent = `ë ˆë²¨ ${artifactLevel}`;
                
                const stats = document.createElement('div');
                stats.className = 'artifact-stats';
                stats.textContent = getArtifactStats(artifactNames[i], artifactLevel);
                
                back.appendChild(level);
                back.appendChild(stats);
                
                card.appendChild(front);
                card.appendChild(back);
                
                grid.appendChild(card);
            }
            
            updateArtifactDisplay();
        }
        
        // ìœ ë¬¼ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateArtifactDisplay() {
            const grid = document.getElementById('artifactGrid');
            if (!grid) return;
            
            const cards = grid.children;
            
            for (let i = 0; i < cards.length; i++) {
                const card = cards[i];
                const front = card.querySelector('.artifact-front');
                const back = card.querySelector('.artifact-back');
                const levelEl = back.querySelector('.artifact-level');
                const statsEl = back.querySelector('.artifact-stats');
                
                if (!front || !back || !levelEl || !statsEl) continue;
                
                const artifactName = front.textContent;
                
                // owned í´ë˜ìŠ¤ ì œê±°
                card.classList.remove('owned', 'locked');
                
                // ë³´ìœ í•œ ìœ ë¬¼ì¸ì§€ í™•ì¸
                const ownedArtifact = artifactStorage.find(item => item.name === artifactName);
                if (ownedArtifact) {
                    card.classList.add('owned');
                    levelEl.textContent = `ë ˆë²¨ ${ownedArtifact.level}`;
                    statsEl.textContent = getArtifactStats(artifactName, ownedArtifact.level);
                } else {
                    card.classList.add('locked');
                    levelEl.textContent = 'ë ˆë²¨ 0';
                    statsEl.textContent = getArtifactStats(artifactName, 0);
                }
            }
        }
        
        // ìœ ë¬¼ ëŠ¥ë ¥ì¹˜ ë°˜í™˜
        function getArtifactStats(artifactName, level) {
            const baseStats = {
                'ì„¸í˜¸ë¡œë¦¬ì˜ ë¶€ì ': 'íŠ¹ë³„íš¨ê³¼ í™•ë¥  ì¦ê°€',
                'ì„¸í˜¸í¼ë¦¬ì˜ ë¶€ì ': 'íŠ¹ë³„íš¨ê³¼ í™•ë¥  ì¦ê°€',
                'ì„¸í˜¸ê²Œì´ì˜ ë¶€ì ': 'íŠ¹ë³„íš¨ê³¼ í™•ë¥  ì¦ê°€',
                'ë§ˆì£ ì´ìŠ¤íŠ¸ì„¸í˜¸ì˜ ë¶€ì ': 'íŠ¹ë³„íš¨ê³¼ í™•ë¥  ì¦ê°€',
                'ì”¹ë•ì„¸í˜¸ì˜ ë¶€ì ': 'íŠ¹ë³„íš¨ê³¼ í™•ë¥  ì¦ê°€',
                'TSì„¸í˜¸ì˜ ë¶€ì ': 'íŠ¹ë³„íš¨ê³¼ í™•ë¥  ì¦ê°€',
                'ì‡¼íƒ€ì„¸í˜¸ì˜ ë¶€ì ': 'íŠ¹ë³„íš¨ê³¼ í™•ë¥  ì¦ê°€',
                'ì—ê²ì„¸í˜¸ì˜ ë¶€ì ': 'íŠ¹ë³„íš¨ê³¼ í™•ë¥  ì¦ê°€',
                'ë‹ˆê±°ì„¸í˜¸ì˜ ë¶€ì ': 'íŠ¹ë³„íš¨ê³¼ í™•ë¥  ì¦ê°€',
                'ì„¸í˜¸ë¡œë¦¬ì˜ ì‹œê°„ê°€ì†ê¸°': 'ë½‘ê¸° ì†ë„ ì¦ê°€',
                'ì„¸í˜¸ë¡œë¦¬ì˜ 7ëª©ê±¸ì´': 'ê½ í™•ë¥  ê°ì†Œ',
                'ì„¸í˜¸ë¡œë¦¬ì˜ ìœ ë¬¼ì„': 'ìœ ë¬¼ ë½‘ê¸° ëŒ€ê¸°ì‹œê°„ ê°ì†Œ',
                'ì„¸í˜¸ë¡œë¦¬ì˜ ë¬´ì§€ê°¯ë¹› ë³´ì„': 'ë¬´ì§€ê°¯ë¹› í™•ë¥  ì¦ê°€',
                'ì„¸í˜¸ë¡œë¦¬ì˜ ì‹ ì„±í•œ ë§ì¹˜': 'ê°•í™” íŒŒê´´í™•ë¥  ê°ì†Œ',
                'ì„¸í˜¸ë¡œë¦¬ì˜ íŠ¸ëŸ¼í”„ì¹´ë“œ': 'ì„¸í˜¸ íŠ¹ë³„íš¨ê³¼ ë³´ì¥'
            };
            
            const baseStat = baseStats[artifactName] || 'ì•Œ ìˆ˜ ì—†ëŠ” ëŠ¥ë ¥';
            
            if (level === 0) {
                return 'íšë“í•˜ì§€ ì•ŠìŒ';
            } else if (level === 1) {
                if (artifactName.includes('ë¶€ì ')) {
                    return baseStat + ' (15% ì¦ê°€)';
                } else if (artifactName === 'ì„¸í˜¸ë¡œë¦¬ì˜ ì‹œê°„ê°€ì†ê¸°') {
                    return baseStat + ' (10% ê°ì†Œ)';
                } else if (artifactName === 'ì„¸í˜¸ë¡œë¦¬ì˜ 7ëª©ê±¸ì´') {
                    return baseStat + ' (7% ê°ì†Œ)';
                } else if (artifactName === 'ì„¸í˜¸ë¡œë¦¬ì˜ ìœ ë¬¼ì„') {
                    return baseStat + ' (ê½ 8% ê°ì†Œ, ìœ ë¬¼ë½‘ê¸° ì‹œê°„ 10% ê°ì†Œ)';
                } else if (artifactName === 'ì„¸í˜¸ë¡œë¦¬ì˜ ë¬´ì§€ê°¯ë¹› ë³´ì„') {
                    return baseStat + ' (75% ì¦ê°€)';
                }
                return baseStat + ' (ë ˆë²¨ 1)';
            } else if (level === 2) {
                if (artifactName.includes('ë¶€ì ')) {
                    return baseStat + ' (30% ì¦ê°€)';
                } else if (artifactName === 'ì„¸í˜¸ë¡œë¦¬ì˜ ì‹œê°„ê°€ì†ê¸°') {
                    return baseStat + ' (25% ê°ì†Œ)';
                } else if (artifactName === 'ì„¸í˜¸ë¡œë¦¬ì˜ 7ëª©ê±¸ì´') {
                    return baseStat + ' (14% ê°ì†Œ)';
                } else if (artifactName === 'ì„¸í˜¸ë¡œë¦¬ì˜ ìœ ë¬¼ì„') {
                    return baseStat + ' (ê½ 16% ê°ì†Œ, ìœ ë¬¼ë½‘ê¸° ì‹œê°„ 20% ê°ì†Œ)';
                } else if (artifactName === 'ì„¸í˜¸ë¡œë¦¬ì˜ ë¬´ì§€ê°¯ë¹› ë³´ì„') {
                    return baseStat + ' (150% ì¦ê°€)';
                }
                return baseStat + ' (ë ˆë²¨ 2)';
            } else if (level === 3) {
                if (artifactName.includes('ë¶€ì ')) {
                    return baseStat + ' (45% ì¦ê°€)';
                } else if (artifactName === 'ì„¸í˜¸ë¡œë¦¬ì˜ ì‹œê°„ê°€ì†ê¸°') {
                    return baseStat + ' (50% ê°ì†Œ)';
                } else if (artifactName === 'ì„¸í˜¸ë¡œë¦¬ì˜ 7ëª©ê±¸ì´') {
                    return baseStat + ' (21% ê°ì†Œ)';
                } else if (artifactName === 'ì„¸í˜¸ë¡œë¦¬ì˜ ìœ ë¬¼ì„') {
                    return baseStat + ' (ê½ 24% ê°ì†Œ, ìœ ë¬¼ë½‘ê¸° ì‹œê°„ 30% ê°ì†Œ)';
                } else if (artifactName === 'ì„¸í˜¸ë¡œë¦¬ì˜ ë¬´ì§€ê°¯ë¹› ë³´ì„') {
                    return baseStat + ' (225% ì¦ê°€)';
                }
                return baseStat + ' (ë ˆë²¨ 3)';
            }
            
            return baseStat;
        }

        function toggleArtifactPanel() {
            const panel = document.getElementById('artifactPanel');
            panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none';
        }

        function switchArtifactTab(e) {
            document.querySelectorAll('#artifactPanel .tab-button').forEach(btn => btn.classList.remove('active'));
            e.currentTarget.classList.add('active');
        }

        function startArtifactDraw() {
            // í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ì¿¨ë‹¤ìš´ ì œê±°
             const now = Date.now();
             const cooldownTime = getArtifactCooldown() * 1000; // ìœ ë¬¼ íš¨ê³¼ ì ìš©ëœ ì¿¨ë‹¤ìš´
             
            // // ì¿¨ë‹¤ìš´ í™•ì¸
             if (now - lastArtifactDraw < cooldownTime) {
                 const remainingTime = Math.ceil((cooldownTime - (now - lastArtifactDraw)) / 1000);
                 const button = document.getElementById('artifactDrawButton');
                 if (button) {
                     button.disabled = true;
                     button.classList.add('disabled');
                     button.textContent = `ëŒ€ê¸°ì¤‘... (${remainingTime}s)`;
                 }
                 return;
             }
            
            const button = document.getElementById('artifactDrawButton');
            const resultEl = document.getElementById('artifactResult');
            const cooldownEl = document.getElementById('artifactCooldown');
            
            if (!button || !resultEl) return;
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            button.disabled = true;
            button.textContent = 'ë½‘ëŠ” ì¤‘...';
            button.classList.add('disabled');
            
            // ì‚¬ìš© ê°€ëŠ¥í•œ ìœ ë¬¼ ëª©ë¡ ê¸°ë°˜ (ì „ì²´ ìœ ë¬¼ íšë“ í™•ë¥  50%, ìœ ë¬¼ ê°„ ê· ë“± ë¶„ë°°)
            const availableArtifacts = getAvailableArtifacts();
            
            // ì• ë‹ˆë©”ì´ì…˜
            resultEl.className = 'result-display reset';
            let count = 0;
            const interval = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * Math.max(availableArtifacts.length, 1));
                resultEl.textContent = availableArtifacts.length > 0 ? availableArtifacts[randomIndex] : 'ê½';
                count++;
                
                if (count > 20) {
                    clearInterval(interval);
                    
                    // ìµœì¢… ê²°ê³¼
                    const random = Math.random();
                    let result = 'ê½';
                    let resultClass = 'result-display reset';
                    
                    if (random < 0.5) { // 50% í™•ë¥ ë¡œ ìœ ë¬¼ íšë“ (ìœ ë¬¼ ê°„ ê· ë“±)
                        if (availableArtifacts.length > 0) {
                            const artifactIndex = Math.floor(Math.random() * availableArtifacts.length);
                            result = availableArtifacts[artifactIndex];
                            resultClass = 'result-display golden';
                            
                            // ìœ ë¬¼ ì €ì¥ì†Œì— ì¶”ê°€
                            addToArtifactStorage(result);
                        } else {
                            result = 'ê½';
                            resultClass = 'result-display reset';
                        }
                    }
                    
                    resultEl.textContent = result;
                    resultEl.className = resultClass;
                    
                // ì¿¨ë‹¤ìš´ ì‹œì‘ (í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ë¹„í™œì„±í™”)
                 lastArtifactDraw = now;
                 startArtifactCooldown();
                 saveState();
                    
                    // ë²„íŠ¼ ë³µì›
                    button.disabled = true;
                    button.classList.add('disabled');
                    startArtifactCooldown();
                }
            }, 80);
        }
        
        // ìœ ë¬¼ ì €ì¥ì†Œì— ì¶”ê°€
        function addToArtifactStorage(artifactName) {
            const existingArtifact = artifactStorage.find(item => item.name === artifactName);
            
            if (existingArtifact) {
                // ê°™ì€ ìœ ë¬¼ì´ ìˆìœ¼ë©´ ë ˆë²¨ ì¦ê°€ (ìµœëŒ€ 3ë ˆë²¨)
                if (existingArtifact.level < 3) {
                    existingArtifact.level = (existingArtifact.level || 1) + 1;
                    existingArtifact.count = (existingArtifact.count || 1) + 1;
                } else {
                    // ì´ë¯¸ ìµœëŒ€ ë ˆë²¨ì´ë©´ ê°œìˆ˜ë§Œ ì¦ê°€
                    existingArtifact.count = (existingArtifact.count || 1) + 1;
                }
            } else {
                // ìƒˆë¡œìš´ ìœ ë¬¼ ì¶”ê°€
                artifactStorage.push({
                    name: artifactName,
                    level: 1,
                    count: 1
                });
            }
            
            // ìœ ë¬¼ ì»¬ë ‰ì…˜ ì—…ë°ì´íŠ¸
            updateArtifactDisplay();
            // íŠ¸ëŸ¼í”„ì¹´ë“œ ì •ë³´ ì—…ë°ì´íŠ¸
            updateTrumpCardInfo();
            saveState();
        }
        
        // ìœ ë¬¼ ë½‘ê¸° ì¿¨ë‹¤ìš´ ì‹œì‘
        function startArtifactCooldown() {
            const cooldownEl = document.getElementById('artifactCooldown');
            const button = document.getElementById('artifactDrawButton');
            if (!cooldownEl) return;
            
            let remainingTime = Math.ceil((getArtifactCooldown() * 1000 - (Date.now() - lastArtifactDraw)) / 1000);
            if (isNaN(remainingTime) || remainingTime < 0) remainingTime = getArtifactCooldown();
            
            const updateCooldown = () => {
                if (remainingTime > 0) {
                    cooldownEl.textContent = `ë‹¤ìŒ ë½‘ê¸°ê¹Œì§€ ${remainingTime}ì´ˆ`;
                    if (button) {
                        button.disabled = true;
                        button.classList.add('disabled');
                        button.textContent = `ëŒ€ê¸°ì¤‘... (${remainingTime}s)`;
                    }
                    remainingTime--;
                    setTimeout(updateCooldown, 1000);
                } else {
                    cooldownEl.textContent = 'ìœ ë¬¼ ë½‘ê¸° ì¤€ë¹„ ì™„ë£Œ!';
                    if (button) {
                        button.disabled = false;
                        button.classList.remove('disabled');
                        button.textContent = 'ğŸº ìœ ë¬¼ ë½‘ê¸°';
                    }
                    saveState();
                }
            };
            
            updateCooldown();
        }

        // ì„¤ì • íŒ¨ë„ í† ê¸€ ë° í†µê³„ ê°±ì‹ /ì´ˆê¸°í™”
        function toggleSettingsPanel() {
            const panel = document.getElementById('settingsPanel');
            if (!panel) return;
            const isOpen = panel.classList.contains('open');
            panel.classList.toggle('open', !isOpen);
            panel.classList.toggle('collapsed', isOpen);
        }

        function updateSettingsStats() {
            const td = document.getElementById('statTotalDraws');
            const rr = document.getElementById('statRarest');
            if (td) td.textContent = totalDraws;
            if (rr) {
                if (!rarestItem) rr.textContent = '-';
                else {
                    rr.textContent = `${rarestItem.name} (${formatFiniteOrEllipsis(rarestItem.realProbabilityNum)}%)`;
                }
            }
            const pt = document.getElementById('statPlaytime');
            if (pt) pt.textContent = formatElapsedTime(Date.now() - startTime);
        }

        function resetAllData() {
            if (!confirm('ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ê¸°ë¡ì´ ì‚­ì œë©ë‹ˆë‹¤.')) return;
            
            // ëª¨ë“  ê²Œì„ ë°ì´í„° ì´ˆê¸°í™”
            storage = [];
            artifactStorage = [];
            lastArtifactDraw = 0;
            totalDraws = 0;
            rarestItem = null;
            startTime = Date.now();
            pausedTime = 0;
            lastPauseTime = 0;
            sehoDrawCount = 0;
            
            // ìƒì  ê´€ë ¨ ë°ì´í„° ì´ˆê¸°í™”
            shopItems = [];
            shopRefreshTime = 0;
            purchasedInCurrentShop = [];
            
            // ì„¸í˜¸ì½”ì¸ & ë²„í”„ ê´€ë ¨ ë°ì´í„° ì´ˆê¸°í™”
            sehoCoin = 0;
            activeBuffs = [];
            purchasedThemes = [];
            currentTheme = 'default';
            
            // ì•„ì´í…œ ë³´ê´€ì†Œ ì´ˆê¸°í™”
            itemStorage = [];
            
             // íŠ¹ìˆ˜ ì•„ì´í…œ ì´ˆê¸°í™”
             specialItemCount = 0;
             noCooldownCount = 0;
             nameChangedItems = [];
             if (nameChangeTimer) clearTimeout(nameChangeTimer);
            
            // í™”ë©´ ì—…ë°ì´íŠ¸
            updateStorageDisplay();
            updateItemStorageDisplay();
            initArtifactCarousel();
            updateSettingsStats();
            updateCoinDisplay();
            updateBuffDisplay();
            updateDotStates();
            updateShopDisplay();
            initThemeSelector();
            applyTheme(currentTheme);
            
            // localStorage ì™„ì „ ì‚­ì œ
            localStorage.removeItem('sehorory_state_v1');
            
            saveState();
            alert('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        // ìœ ë¬¼ íš¨ê³¼ ê³„ì‚° í•¨ìˆ˜ë“¤
        function getArtifactCooldown() {
            const artifact = artifactStorage.find(item => item.name === 'ì„¸í˜¸ë¡œë¦¬ì˜ ìœ ë¬¼ì„');
            if (!artifact) return baseArtifactCooldown;
            
            const reduction = artifact.level * 0.1; // ë ˆë²¨ë‹¹ 10% ê°ì†Œ
            return Math.max(10, baseArtifactCooldown * (1 - reduction)); // ìµœì†Œ 10ì´ˆ
        }
        
        function getMissReduction() {
            // ìœ ë¬¼ì„ ê¸°ì¤€: ë ˆë²¨ë‹¹ 7%p ê½ ê°ì†Œ
            const artifact = artifactStorage.find(item => item.name === 'ì„¸í˜¸ë¡œë¦¬ì˜ ìœ ë¬¼ì„');
            if (!artifact) return 0;
            return artifact.level * 7;
        }

         // ì†ë„í¬ì…˜ ë ˆë²¨ì— ë”°ë¼ ë½‘ê¸° ìŠ¤í•€ ê°„ê²© ê°ì†Œ (ê¸°ë³¸ 40ms)
         function getSpinInterval() {
             const base = 40;
             let totalReduction = 0;
             
             // ìœ ë¬¼ ì‹œê°„ê°€ì†ê¸° íš¨ê³¼
             const speedArtifact = artifactStorage.find(item => item.name === 'ì„¸í˜¸ë¡œë¦¬ì˜ ì‹œê°„ê°€ì†ê¸°');
             if (speedArtifact) {
                 const lv = speedArtifact.level || 1;
             const map = { 1: 0.10, 2: 0.25, 3: 0.50 };
                 totalReduction += map[lv] || 0.10;
             }
             
             // ì†ë„ í¬ì…˜ íš¨ê³¼
             const speedBuff = activeBuffs.find(b => b.type === 'speed' && b.endTime > Date.now());
             if (speedBuff) {
                 const buffReduction = [0.075, 0.15, 0.30][speedBuff.level - 1];
                 totalReduction += buffReduction;
             }
             
             // 1339í¬ì…˜ íš¨ê³¼ (15~50% ëœë¤ ê°ì†Œ)
             const speedBoostBuff = activeBuffs.find(b => b.type === 'speed_boost' && b.endTime > Date.now());
             if (speedBoostBuff) {
                 const randomReduction = 0.15 + Math.random() * 0.35; // 15%~50%
                 totalReduction += randomReduction;
             }
             
             return Math.max(8, Math.round(base * (1 - totalReduction)));
         }
        
        function getSpecialEffectBonus(participantName) {
            // í•´ë‹¹ ì„¸í˜¸ì˜ ë¶€ì ë§Œ ì ìš©
            const amuletName = `${participantName}ì˜ ë¶€ì `;
            const artifact = artifactStorage.find(item => item.name === amuletName);
            
            if (!artifact) return 0;
            
            // ë ˆë²¨ë³„ íŠ¹ë³„íš¨ê³¼ í™•ë¥  ì¦ê°€: 10%, 30%, 50%
            const level = artifact.level;
            if (level === 1) return 0.10; // 10%
            if (level === 2) return 0.30; // 30%
            if (level === 3) return 0.50; // 50%
            return 0;
        }
        
        function getRainbowBonus() {
            const artifact = artifactStorage.find(item => item.name === 'ì„¸í˜¸ë¡œë¦¬ì˜ ë¬´ì§€ê°¯ë¹› ë³´ì„');
            if (!artifact) return 0;
            
            return artifact.level * 0.75; // ë ˆë²¨ë‹¹ 75% ì¦ê°€
        }
        
        // ì‚¬ìš© ê°€ëŠ¥í•œ ìœ ë¬¼ ëª©ë¡ ë°˜í™˜ (3ë ˆë²¨ ë‹¬ì„±í•œ ìœ ë¬¼ ì œì™¸)
        function getAvailableArtifacts() {
            const allArtifacts = [
                'ì„¸í˜¸ë¡œë¦¬ì˜ ë¶€ì ', 'ì„¸í˜¸í¼ë¦¬ì˜ ë¶€ì ', 'ì„¸í˜¸ê²Œì´ì˜ ë¶€ì ',
                'ë§ˆì£ ì´ìŠ¤íŠ¸ì„¸í˜¸ì˜ ë¶€ì ', 'ì”¹ë•ì„¸í˜¸ì˜ ë¶€ì ', 'TSì„¸í˜¸ì˜ ë¶€ì ',
                'ì‡¼íƒ€ì„¸í˜¸ì˜ ë¶€ì ', 'ì—ê²ì„¸í˜¸ì˜ ë¶€ì ', 'ë‹ˆê±°ì„¸í˜¸ì˜ ë¶€ì ',
                'ì„¸í˜¸ë¡œë¦¬ì˜ ì‹œê°„ê°€ì†ê¸°', 'ì„¸í˜¸ë¡œë¦¬ì˜ 7ëª©ê±¸ì´',
                'ì„¸í˜¸ë¡œë¦¬ì˜ ìœ ë¬¼ì„', 'ì„¸í˜¸ë¡œë¦¬ì˜ ë¬´ì§€ê°¯ë¹› ë³´ì„',
                'ì„¸í˜¸ë¡œë¦¬ì˜ ì‹ ì„±í•œ ë§ì¹˜', 'ì„¸í˜¸ë¡œë¦¬ì˜ íŠ¸ëŸ¼í”„ì¹´ë“œ'
            ];
            
            return allArtifacts.filter(artifactName => {
                const artifact = artifactStorage.find(item => item.name === artifactName);
                return !artifact || artifact.level < 3;
            });
        }

        // ë³´ê´€ì†Œ ì „ì²´ ì‚­ì œ
        function clearStorage() {
            if (confirm('ë³´ê´€ì†Œë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                storage = [];
                updateStorageDisplay();
            }
        }

        // í™•ë¥ í‘œ ì—…ë°ì´íŠ¸
        function updateProbabilityTable() {
            const content = document.getElementById('probabilityContent');
            
      if (participants.length === 0) {
                content.innerHTML = '<p>ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

            // ìœ ë¬¼ ë° í¬ì…˜ íš¨ê³¼ê°€ ì ìš©ëœ ì°¸ê°€ì ëª©ë¡ ì‚¬ìš©
            const effectiveParticipants = getEffectiveParticipants();
            const totalWeight = effectiveParticipants.reduce((sum, p) => sum + p.weight, 0);
            
            // í™•ë¥ ìˆœìœ¼ë¡œ ì •ë ¬ (ë†’ì€ í™•ë¥ ë¶€í„°)
            const sortedParticipants = [...effectiveParticipants].sort((a, b) => b.weight - a.weight);
            
            let listHTML = '<div class="probability-list" id="probListBelow">';
            
            sortedParticipants.forEach(participant => {
                const probNum = (participant.weight / totalWeight) * 100;
                const probability = formatFiniteOrEllipsis(probNum);
                if (participant.name === 'ê½') {
                    // ì›ë˜ ê½ í™•ë¥  ê³„ì‚°
                    const originalMiss = participants.find(p => p.name === 'ê½');
                    const originalTotal = participants.reduce((sum, p) => sum + p.weight, 0);
                    const originalProbNum = (originalMiss.weight / originalTotal) * 100;
                    
                    // ê°ì†ŒëŸ‰ ê³„ì‚°
                    const reduction = originalProbNum - probNum;
                    const displayText = reduction > 0 
                        ? `${formatFiniteOrEllipsis(originalProbNum)}% <span class="artifact-effect">(-${formatFiniteOrEllipsis(reduction)}%)</span>`
                        : `${probability}%`;
                    
                    listHTML += `
                    <div class="probability-item no-hover">
                        <span class="participant-name">${participant.name}</span>
                        <span class="probability-value">${displayText}</span>
                    </div>`;
                    return;
                }
                
                // ìœ ë¬¼ íš¨ê³¼ ì ìš©
                const specialEffectBonus = getSpecialEffectBonus(participant.name);
                const rainbowBonus = getRainbowBonus();
                
                const rainbowProbability = formatFiniteOrEllipsis(probNum * 0.0002 * (1 + rainbowBonus));
                const diamondProbability = formatFiniteOrEllipsis(probNum * 0.002 * (1 + specialEffectBonus));
                const goldenProbability = formatFiniteOrEllipsis(probNum * 0.01 * (1 + specialEffectBonus));
                const shiningProbability = formatFiniteOrEllipsis(probNum * 0.2 * (1 + specialEffectBonus));
                const sparklingProbability = formatFiniteOrEllipsis(probNum * 0.05 * (1 + specialEffectBonus));
                
                listHTML += `
                    <div class="probability-item">
                        <span class="participant-name">${participant.name}</span>
                        <span class="probability-value">${probability}%</span>
                        <div class="shining-info">
                            <div class="effect-title">
                                <span>âœ¨</span>
                                <span>íŠ¹ë³„ íš¨ê³¼ í™•ë¥ </span>
                            </div>
                            <div class="effect-probability">
                                âœ¨ ë¹›ë‚˜ëŠ” ${participant.name}: ${shiningProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.2 * specialEffectBonus)}%)</span>
                                <small>(ë½‘íŒ í›„ 20% í™•ë¥ )</small>
                            </div>
                            <div class="effect-probability">
                                âš¡ ë²ˆì©ì´ëŠ” ${participant.name}: ${sparklingProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.05 * specialEffectBonus)}%)</span>
                                <small>(ë½‘íŒ í›„ 5% í™•ë¥ )</small>
                            </div>
                            <div class="effect-probability">
                                ğŸ† í™©ê¸ˆìƒ‰ ${participant.name}: ${goldenProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.01 * specialEffectBonus)}%)</span>
                                <small>(ë½‘íŒ í›„ 1% í™•ë¥ )</small>
                            </div>
                            <div class="effect-probability">
                                ğŸ’ ë‹¤ì´ì•„ëª¬ë“œìƒ‰ ${participant.name}: ${diamondProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.002 * specialEffectBonus)}%)</span>
                                <small>(ë½‘íŒ í›„ 0.2% í™•ë¥ )</small>
                            </div>
                            <div class="effect-probability">
                                ğŸŒˆ ë¬´ì§€ê°¯ë¹› ${participant.name}: ${rainbowProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.0002 * rainbowBonus)}%)</span>
                                <small>(ë½‘íŒ í›„ 0.02% í™•ë¥ )</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listHTML += '</div>';
            content.innerHTML = listHTML;
            attachProbabilityToggle('probListMain');
        }

         // ë„íŠ¸ ìƒíƒœ ì—…ë°ì´íŠ¸ (ë½‘ê¸° íšŸìˆ˜ì— ë”°ë¥¸ ì ê¸ˆ í•´ì œ)
         function updateDotStates() {
             // ì•„ì´í…œ ë³´ê´€ì†Œ (0ë²ˆ): 150íšŒ ì´ìƒ
             const dot0 = document.getElementById('dot-0');
             if (totalDraws >= 150) {
                 dot0.classList.remove('locked');
             } else {
                 dot0.classList.add('locked');
             }
             
             // ìƒì  (1ë²ˆ): 150íšŒ ì´ìƒ
             const dot1 = document.getElementById('dot-1');
             if (totalDraws >= 150) {
                 dot1.classList.remove('locked');
             } else {
                 dot1.classList.add('locked');
             }
             
             // ìœ ë¬¼ ë½‘ê¸° (5ë²ˆ): 50íšŒ ì´ìƒ
             const dot5 = document.getElementById('dot-5');
             if (totalDraws >= 50) {
                 dot5.classList.remove('locked');
             } else {
                 dot5.classList.add('locked');
             }
             
             // ìœ ë¬¼ ì»¬ë ‰ì…˜ (6ë²ˆ): 50íšŒ ì´ìƒ
             const dot6 = document.getElementById('dot-6');
             if (totalDraws >= 50) {
                 dot6.classList.remove('locked');
             } else {
                 dot6.classList.add('locked');
             }
        }

        // í™”ë©´ ì „í™˜
        function goToScreen(screenIndex) {
             // ë½‘ê¸° íšŸìˆ˜ ì œí•œ í™•ì¸
             if (screenIndex === 0 && totalDraws < 150) {
                 alert('ì•„ì´í…œ ë³´ê´€ì†ŒëŠ” 150íšŒ ë½‘ê¸° ì´ìƒë¶€í„° ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
                 return;
             }
             
             if (screenIndex === 1 && totalDraws < 150) {
                 alert('ìƒì ì€ 150íšŒ ë½‘ê¸° ì´ìƒë¶€í„° ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
                 return;
             }
             
             if (screenIndex === 5 && totalDraws < 50) {
                 alert('ìœ ë¬¼ ë½‘ê¸°ëŠ” 50íšŒ ë½‘ê¸° ì´ìƒë¶€í„° ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
                 return;
             }
             
             if (screenIndex === 6 && totalDraws < 50) {
                 alert('ìœ ë¬¼ ì»¬ë ‰ì…˜ì€ 50íšŒ ë½‘ê¸° ì´ìƒë¶€í„° ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
                 return;
             }
             
            currentScreen = screenIndex;
            const container = document.getElementById('mainContainer');
            container.style.transform = `translateX(-${screenIndex * 100}vw)`;
            
            // ë„íŠ¸ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.dot').forEach((dot, index) => {
                dot.classList.toggle('active', index === screenIndex);
            });
            if (screenIndex === 0) {
                 updateItemStorageDisplay();
            } else if (screenIndex === 2) {
                 updateProbabilityTable();
            } else if (screenIndex === 4) {
                 updateStorageDisplay();
             } else if (screenIndex === 6) {
                initArtifactCarousel();
            }
        }

        // í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.addEventListener('touchstart', function(e) {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', function(e) {
            if (!startX || !startY) return;
            
            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            const diffX = startX - endX;
            const diffY = startY - endY;
            
            // ìˆ˜í‰ ìŠ¤ì™€ì´í”„ê°€ ìˆ˜ì§ ìŠ¤ì™€ì´í”„ë³´ë‹¤ í´ ë•Œë§Œ ì²˜ë¦¬
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                if (diffX > 0) {
                    // ì™¼ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ (ë‹¤ìŒ í™”ë©´)
                    if (currentScreen < 6) {
                        goToScreen(currentScreen + 1);
                    }
                } else {
                    // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ (ì´ì „ í™”ë©´)
                    if (currentScreen > 0) {
                        goToScreen(currentScreen - 1);
                    }
                }
            }
            
            startX = 0;
            startY = 0;
        });

        // ì•„ë˜ íŒ¨ë„ ë Œë”ë§
        function renderBelowProbability() {
            const probHost = document.getElementById('sehoProbBelow');
            if (!probHost) return;
            const pool = getEffectiveParticipants();
            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            const sortedParticipants = [...pool].sort((a, b) => b.weight - a.weight);
            let listHTML = '<div class="probability-list">';
            sortedParticipants.forEach(participant => {
                const probNum = (participant.weight / totalWeight) * 100;
                const probability = formatFiniteOrEllipsis(probNum);
                if (participant.name === 'ê½') {
                    // ê½ í™•ë¥ ì— ìœ ë¬¼ íš¨ê³¼ ì ìš©
                    const missReduction = getMissReduction();
                    const missProbability = Math.max(0, probNum - missReduction);
                    const missDisplay = missReduction > 0 ? `${formatFiniteOrEllipsis(missProbability)}% <span class="artifact-effect">(-${formatFiniteOrEllipsis(missReduction)}%)</span>` : `${probability}%`;
                    
                    listHTML += `
                    <div class="probability-item no-hover">
                        <span class="participant-name">${participant.name}</span>
                        <span class="probability-value">${missDisplay}</span>
                    </div>`;
                    return;
                }
                
                // ìœ ë¬¼ íš¨ê³¼ ì ìš©
                const specialEffectBonus = getSpecialEffectBonus(participant.name);
                const rainbowBonus = getRainbowBonus();
                
                const rainbowProbability = formatFiniteOrEllipsis(probNum * 0.0002 * (1 + rainbowBonus));
                const diamondProbability = formatFiniteOrEllipsis(probNum * 0.002 * (1 + specialEffectBonus));
                const goldenProbability = formatFiniteOrEllipsis(probNum * 0.01 * (1 + specialEffectBonus));
                const shiningProbability = formatFiniteOrEllipsis(probNum * 0.2 * (1 + specialEffectBonus));
                const sparklingProbability = formatFiniteOrEllipsis(probNum * 0.05 * (1 + specialEffectBonus));
                
                listHTML += `
                    <div class="probability-item">
                        <span class="participant-name">${participant.name}</span>
                        <span class="probability-value">${probability}%</span>
                        <div class="shining-info">
                            <div class="effect-title">
                                <span>âœ¨</span>
                                <span>íŠ¹ë³„ íš¨ê³¼ í™•ë¥ </span>
                            </div>
                            <div class="effect-probability">
                                âœ¨ ë¹›ë‚˜ëŠ” ${participant.name}: ${shiningProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.2 * specialEffectBonus)}%)</span>
                                <small>(ë½‘íŒ í›„ 20% í™•ë¥ )</small>
                            </div>
                            <div class="effect-probability">
                                âš¡ ë²ˆì©ì´ëŠ” ${participant.name}: ${sparklingProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.05 * specialEffectBonus)}%)</span>
                                <small>(ë½‘íŒ í›„ 5% í™•ë¥ )</small>
                            </div>
                            <div class="effect-probability">
                                ğŸ† í™©ê¸ˆìƒ‰ ${participant.name}: ${goldenProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.01 * specialEffectBonus)}%)</span>
                                <small>(ë½‘íŒ í›„ 1% í™•ë¥ )</small>
                            </div>
                            <div class="effect-probability">
                                ğŸ’ ë‹¤ì´ì•„ëª¬ë“œìƒ‰ ${participant.name}: ${diamondProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.002 * specialEffectBonus)}%)</span>
                                <small>(ë½‘íŒ í›„ 0.2% í™•ë¥ )</small>
                            </div>
                            <div class="effect-probability">
                                ğŸŒˆ ë¬´ì§€ê°¯ë¹› ${participant.name}: ${rainbowProbability}% <span class="artifact-effect">(+${formatFiniteOrEllipsis(probNum * 0.0002 * rainbowBonus)}%)</span>
                                <small>(ë½‘íŒ í›„ 0.02% í™•ë¥ )</small>
                            </div>
                        </div>
                    </div>`;
            });
            listHTML += '</div>';
            probHost.innerHTML = listHTML;
            attachProbabilityToggle('probListBelow');
        }

        function openBottomPanel(which) {
            if (which === 'seho') {
                const panel = document.getElementById('sehoBottomPanel');
                if (panel) {
                    panel.style.display = 'block';
                    renderBelowProbability();
                    updateStorageDisplay();
                }
            } else if (which === 'arti') {
                const panel = document.getElementById('artiBottomPanel');
                const gridBelow = document.getElementById('artifactGridBelow');
                if (panel) {
                    panel.style.display = 'block';
                    if (gridBelow) {
                        gridBelow.innerHTML = '';
                        for (let i = 1; i <= 30; i++) {
                            const cell = document.createElement('div');
                            cell.className = 'artifact-cell locked';
                            cell.textContent = `ìŠ¬ë¡¯ ${i}`;
                            gridBelow.appendChild(cell);
                        }
                    }
                    updateStorageDisplay();
                }
                const topGrid = document.getElementById('artifactCollection');
                if (topGrid) topGrid.style.display = 'none';
            }
        }

        function closeBottomPanels() {
            const seho = document.getElementById('sehoBottomPanel');
            const arti = document.getElementById('artiBottomPanel');
            if (seho) seho.style.display = 'none';
            if (arti) arti.style.display = 'none';
        }

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ì»´í“¨í„°ìš©)
        document.addEventListener('keydown', function(e) {
            // í™”ì‚´í‘œ í‚¤ë¡œ í™”ë©´ ì „í™˜
            if (e.key === 'ArrowLeft') {
                // ì™¼ìª½ í™”ì‚´í‘œ - ì´ì „ í™”ë©´
                if (currentScreen > 0) {
                    goToScreen(currentScreen - 1);
                }
            } else if (e.key === 'ArrowRight') {
                // ì˜¤ë¥¸ìª½ í™”ì‚´í‘œ - ë‹¤ìŒ í™”ë©´
                if (currentScreen < 6) {
                    goToScreen(currentScreen + 1);
                }
            }
        });

        // íŠ¹ë³„ íš¨ê³¼ í•¨ìˆ˜ë“¤
        function createConfetti() {
            const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                
                document.body.appendChild(confetti);
                
                // 5ì´ˆ í›„ ì œê±°
                setTimeout(() => {
                    if (confetti.parentNode) {
                        confetti.parentNode.removeChild(confetti);
                    }
                }, 5000);
            }
        }

        function playGoldenSound() {
            // í™©ê¸ˆìƒ‰ ì‚¬ìš´ë“œ íš¨ê³¼ (Web Audio API ì‚¬ìš©)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playDiamondSound() {
            // ë‹¤ì´ì•„ëª¬ë“œìƒ‰ ì‚¬ìš´ë“œ íš¨ê³¼ (ë” ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ì†Œë¦¬)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator1 = audioContext.createOscillator();
                const oscillator2 = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator1.connect(gainNode);
                oscillator2.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // í•˜ëª¨ë‹ˆë¥¼ ì´ë£¨ëŠ” ë‘ ìŒ
                oscillator1.frequency.setValueAtTime(880, audioContext.currentTime); // A5
                oscillator2.frequency.setValueAtTime(1108.73, audioContext.currentTime); // C#6
                
                oscillator1.frequency.setValueAtTime(1046.5, audioContext.currentTime + 0.1); // C6
                oscillator2.frequency.setValueAtTime(1318.51, audioContext.currentTime + 0.1); // E6
                
                oscillator1.frequency.setValueAtTime(1174.66, audioContext.currentTime + 0.2); // D6
                oscillator2.frequency.setValueAtTime(1479.98, audioContext.currentTime + 0.2); // F#6
                
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
                
                oscillator1.start(audioContext.currentTime);
                oscillator2.start(audioContext.currentTime);
                oscillator1.stop(audioContext.currentTime + 0.8);
                oscillator2.stop(audioContext.currentTime + 0.8);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playRainbowSound() {
            // ë¬´ì§€ê°¯ë¹› ì‚¬ìš´ë“œ íš¨ê³¼ (ë°˜ì§ì´ëŠ” ìƒìŠ¹ ì•„ë¥´í˜ì§€ì˜¤)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const gain = audioContext.createGain();
                gain.connect(audioContext.destination);
                gain.gain.setValueAtTime(0.28, audioContext.currentTime);
                const freqs = [659.25, 783.99, 987.77, 1318.51, 1567.98, 1975.53];
                freqs.forEach((f, i) => {
                    const o = audioContext.createOscillator();
                    o.type = 'triangle';
                    o.frequency.setValueAtTime(f, audioContext.currentTime + i * 0.07);
                    o.connect(gain);
                    const start = audioContext.currentTime + i * 0.07;
                    o.start(start);
                    o.stop(start + 0.22);
                });
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        // ê°•í™” ê´€ë ¨ ì‚¬ìš´ë“œ í•¨ìˆ˜ë“¤ (ëŒ€ì¥ì¥ì´ ë§ì¹˜ ëŠë‚Œ)
        function playEnhanceStartSound() {
            // ê°•í™” ì‹œì‘ ì‚¬ìš´ë“œ (ë§ì¹˜ ë‚´ë ¤ì¹˜ëŠ” ì†Œë¦¬)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator1 = audioContext.createOscillator();
                const oscillator2 = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator1.connect(gainNode);
                oscillator2.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // ë‚®ì€ ìŒê³¼ ë†’ì€ ìŒì˜ ì¡°í•©ìœ¼ë¡œ ê¸ˆì† ì¶©ëŒê° í‘œí˜„
                oscillator1.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator2.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator1.type = 'sawtooth';
                oscillator2.type = 'square';
                
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                
                oscillator1.start(audioContext.currentTime);
                oscillator2.start(audioContext.currentTime);
                oscillator1.stop(audioContext.currentTime + 0.15);
                oscillator2.stop(audioContext.currentTime + 0.15);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playEnhanceSuccessSound() {
            // ê°•í™” ì„±ê³µ ì‚¬ìš´ë“œ (ê°„ë‹¨í•œ ì„±ê³µìŒ)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.12, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playEnhanceFailSound() {
            // ê°•í™” ì‹¤íŒ¨ ì‚¬ìš´ë“œ (ê°„ë‹¨í•œ ì‹¤íŒ¨ìŒ)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playEnhanceDestroySound() {
            // ê°•í™” íŒŒê´´ ì‚¬ìš´ë“œ (ê°„ë‹¨í•œ íŒŒê´´ìŒ)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(80, audioContext.currentTime);
                oscillator.type = 'sawtooth';
                
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.25);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.25);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playMaxEnhanceSuccessSound() {
            // 5ê°• ì„±ê³µ íŠ¹ë³„ ì‚¬ìš´ë“œ (ê°„ë‹¨í•œ "ë¤" ì†Œë¦¬)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // ê°„ë‹¨í•œ "ë¤" ì†Œë¦¬
                oscillator.frequency.setValueAtTime(1046.50, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function startPlaytimeTicker() {
            if (playtimeTimer) clearInterval(playtimeTimer);
            playtimeTimer = setInterval(() => {
                const pt = document.getElementById('statPlaytime');
                if (pt) {
                    const currentTime = Date.now();
                    const totalPlaytime = currentTime - startTime - pausedTime;
                    pt.textContent = formatElapsedTime(totalPlaytime);
                }
            }, 1000);
        }

        function formatElapsedTime(ms) {
            const totalSec = Math.max(0, Math.floor(ms / 1000));
            const h = String(Math.floor(totalSec / 3600)).padStart(2, '0');
            const m = String(Math.floor((totalSec % 3600) / 60)).padStart(2, '0');
            return `${h}:${m}`;
        }

        // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì²˜ë¦¬
        function handleVisibilityChange() {
            if (document.hidden) {
                // í˜ì´ì§€ê°€ ìˆ¨ê²¨ì¡Œì„ ë•Œ - ì¼ì‹œì •ì§€ ì‹œê°„ ê¸°ë¡
                lastPauseTime = Date.now();
            } else {
                // í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì¼ ë•Œ - ì¼ì‹œì •ì§€ëœ ì‹œê°„ì„ ëˆ„ì 
                if (lastPauseTime > 0) {
                    pausedTime += Date.now() - lastPauseTime;
                    lastPauseTime = 0;
                }
            }
        }

        // í˜ì´ì§€ ê°€ì‹œì„± ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        document.addEventListener('visibilitychange', handleVisibilityChange);

        // ========== ìƒì  ì‹œìŠ¤í…œ ==========
        
        // ìƒì  ì´ˆê¸°í™”
        function initShop() {
            const now = Date.now();
            
            // ì €ì¥ëœ ìƒì  ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ê°±ì‹  ì‹œê°„ì´ ì§€ë‚¬ì„ ë•Œë§Œ ê°±ì‹ 
            if (shopItems.length === 0 || now >= shopRefreshTime) {
                refreshShop();
            } else {
                // ì €ì¥ëœ ìƒì  ë°ì´í„°ê°€ ìˆìœ¼ë©´ í™”ë©´ ì—…ë°ì´íŠ¸ë§Œ
                updateShopDisplay();
            }
            
            // íƒ€ì´ë¨¸ ì‹œì‘
            startShopTimer();
        }
        
        // ìƒì  ë¬¼í’ˆ ê°±ì‹  (ëœë¤ 3ê°œ ì„ íƒ)
        function refreshShop() {
            const now = Date.now();
            shopRefreshTime = now + 30 * 60 * 1000; // 30ë¶„ í›„
            
            shopItems = [];
            purchasedInCurrentShop = []; // êµ¬ë§¤ ê¸°ë¡ ì´ˆê¸°í™”
            
            // ë“±ê¸‰ë³„ í™•ë¥ : ì¼ë°˜ 45%, í¬ê·€ 27.5%, ë ˆì–´ 17.5%, ì˜ì›… 7.5%, ì „ì„¤ 2.5%
            const rarityProbabilities = {
                'common': 45,
                'rare': 27.5,
                'epic': 17.5,
                'hero': 7.5,
                'legendary': 2.5
            };
            
            // ë“±ê¸‰ë³„ í™•ë¥ ì— ë”°ë¼ 3ê°œ ì„ íƒ
            for (let i = 0; i < 3; i++) {
                // 1ë‹¨ê³„: ë“±ê¸‰ ì„ íƒ
                const random = Math.random() * 100;
                let selectedRarity = 'common';
                let cumulative = 0;
                
                for (const [rarity, probability] of Object.entries(rarityProbabilities)) {
                    cumulative += probability;
                    if (random <= cumulative) {
                        selectedRarity = rarity;
                        break;
                    }
                }
                
                // 2ë‹¨ê³„: í•´ë‹¹ ë“±ê¸‰ì˜ ì•„ì´í…œ ì¤‘ì—ì„œ ëœë¤ ì„ íƒ
                const availableItems = allShopItems.filter(item => {
                    // êµ¬ë§¤ ê°€ëŠ¥í•œ ì•„ì´í…œë§Œ í•„í„°ë§
                    if (item.oneTime && purchasedThemes.includes(item.name)) {
                        return false;
                    }
                    return item.rarity === selectedRarity;
                });
                
                if (availableItems.length === 0) {
                    // í•´ë‹¹ ë“±ê¸‰ì— ì•„ì´í…œì´ ì—†ìœ¼ë©´ ì¼ë°˜ ë“±ê¸‰ìœ¼ë¡œ ëŒ€ì²´
                    const commonItems = allShopItems.filter(item => {
                        if (item.oneTime && purchasedThemes.includes(item.name)) {
                            return false;
                        }
                        return item.rarity === 'common';
                    });
                    if (commonItems.length > 0) {
                        const randomIndex = Math.floor(Math.random() * commonItems.length);
                        const selectedItem = commonItems[randomIndex];
                        
                        // í¬ì…˜ì¸ ê²½ìš° ê°œìˆ˜ ëœë¤ ê²°ì •
                        if (selectedItem.type === 'potion') {
                            const qty = Math.floor(Math.random() * (selectedItem.maxQty - selectedItem.minQty + 1)) + selectedItem.minQty;
                            shopItems.push({
                                ...selectedItem,
                                quantity: qty,
                                displayName: `${selectedItem.name} x${qty}`,
                                totalPrice: selectedItem.price * qty
                            });
                        } else {
                            shopItems.push({
                                ...selectedItem,
                                quantity: 1,
                                displayName: selectedItem.name,
                                totalPrice: selectedItem.price
                            });
                        }
                    }
                    continue;
                }
                
                // í•´ë‹¹ ë“±ê¸‰ì˜ ì•„ì´í…œ ì¤‘ì—ì„œ ëœë¤ ì„ íƒ
                const randomIndex = Math.floor(Math.random() * availableItems.length);
                const selectedItem = availableItems[randomIndex];
                
                // í¬ì…˜ì¸ ê²½ìš° ê°œìˆ˜ ëœë¤ ê²°ì •
                if (selectedItem.type === 'potion') {
                    const qty = Math.floor(Math.random() * (selectedItem.maxQty - selectedItem.minQty + 1)) + selectedItem.minQty;
                    shopItems.push({
                        ...selectedItem,
                        quantity: qty,
                        displayName: `${selectedItem.name} x${qty}`,
                        totalPrice: selectedItem.price * qty
                    });
                } else {
                    shopItems.push({
                        ...selectedItem,
                        quantity: 1,
                        displayName: selectedItem.name,
                        totalPrice: selectedItem.price
                    });
                }
            }
            
            updateShopDisplay();
            saveState();
        }
        
        // ìƒì  í™”ë©´ ì—…ë°ì´íŠ¸
        function updateShopDisplay() {
            const container = document.getElementById('shopItems');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (shopItems.length === 0) {
                // ë¬¼í’ˆì´ ì—†ì„ ë•Œ
                for (let i = 0; i < 3; i++) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'shop-item';
                    itemDiv.innerHTML = `
                        <div class="shop-item-name">???</div>
                        <div class="shop-item-desc">ë¬¼í’ˆì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤...</div>
                        <div class="shop-item-price">??? ì„¸í˜¸ì½”ì¸</div>
                    `;
                    container.appendChild(itemDiv);
                }
            } else {
                // ë¬¼í’ˆ í‘œì‹œ
                shopItems.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    // ë“±ê¸‰ì— ë”°ë¥¸ í´ë˜ìŠ¤ ì¶”ê°€
                    const rarityClass = item.rarity || 'common';
                    const isSoldOut = purchasedInCurrentShop.includes(index);
                    itemDiv.className = `shop-item ${rarityClass}${isSoldOut ? ' sold-out' : ''}`;
                    
                     // ì•„ì´í…œ ì„¤ëª… ìƒì„±
                     let description = '';
                     if (item.type === 'potion') {
                         if (item.effect === 'luck') {
                             const reduction = [5, 10, 20][item.level - 1];
                             description = `5ë¶„ë™ì•ˆ ê½ í™•ë¥  ${reduction}% ê°ì†Œ`;
                         } else if (item.effect === 'speed') {
                             const reduction = [7.5, 15, 30][item.level - 1];
                             description = `5ë¶„ë™ì•ˆ ë½‘ê¸° ì†ë„ ${reduction}% ê°ì†Œ`;
                         } else if (item.effect === 'speed_boost') {
                             description = `10ë¶„ë™ì•ˆ ë½‘ê¸° ì†ë„ 15~50% ê°ì†Œ`;
                         }
                     } else if (item.type === 'theme') {
                         description = `ë°°ê²½ í…Œë§ˆ ë³€ê²½ (1íšŒ êµ¬ë§¤)`;
                     } else if (item.type === 'special') {
                         if (item.effect === 'guaranteed_special') {
                             description = `ë‹¤ìŒ ë½‘ê¸°ì—ì„œ íŠ¹ë³„íš¨ê³¼ í™•ë¥  20%ë¡œ ê³ ì • (ê½ ì‹œ íšŸìˆ˜ ê°ì†Œ ì•ˆë¨)`;
                         } else if (item.effect === 'remove_cooldown') {
                             description = `ë‹¤ìŒ 50íšŒ ë½‘ê¸° ì¿¨íƒ€ì„ ì‚­ì œ`;
                         } else if (item.effect === 'refresh_shop') {
                             description = `3íšŒê¹Œì§€ ì‚¬ìš©ê°€ëŠ¥ / ì‚¬ìš©ì‹œ ì¦‰ì‹œ ìƒì  ê°±ì‹ `;
                         } else if (item.effect === 'lucky_box') {
                             description = `í–‰ìš´í¬ì…˜â…¡ 1~10ê°œ, ì†ë„í¬ì…˜â…¡ 1~10ê°œ íšë“`;
                         } else if (item.effect === 'name_converter') {
                             description = `ë³´ê´€ì†Œ ì„¸í˜¸ 3ê°œì˜ ì´ë¦„ ë³€ê²½`;
                         }
                     }
                    
                    itemDiv.innerHTML = `
                        <div class="shop-item-name">${item.displayName || item.name}</div>
                        <div class="shop-item-desc">${description}</div>
                        <div class="shop-item-price">${item.totalPrice || item.price} ì„¸í˜¸ì½”ì¸</div>
                        ${isSoldOut ? '<div class="sold-out-label">SOLD OUT</div>' : ''}
                    `;
                    
                    if (!isSoldOut) {
                        itemDiv.onclick = () => buyShopItem(item, index);
                    }
                    
                    container.appendChild(itemDiv);
                });
                
                // 3ê°œ ë¯¸ë§Œì´ë©´ ë¹ˆ ìŠ¬ë¡¯ ì¶”ê°€
                for (let i = shopItems.length; i < 3; i++) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'shop-item';
                    itemDiv.innerHTML = `
                        <div class="shop-item-name">???</div>
                        <div class="shop-item-desc">ë¬¼í’ˆì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤...</div>
                        <div class="shop-item-price">??? ì„¸í˜¸ì½”ì¸</div>
                    `;
                    container.appendChild(itemDiv);
                }
            }
        }
        
        // ìƒì  ì•„ì´í…œ êµ¬ë§¤
        function buyShopItem(item, itemIndex) {
            const cost = item.totalPrice || item.price;
            
            // ì´ë¯¸ êµ¬ë§¤í•œ ì•„ì´í…œì¸ì§€ í™•ì¸
            if (purchasedInCurrentShop.includes(itemIndex)) {
                alert('ì´ë¯¸ êµ¬ë§¤í•œ ì•„ì´í…œì…ë‹ˆë‹¤!');
                return;
            }
            
            // ì„¸í˜¸ì½”ì¸ í™•ì¸
            if (sehoCoin < cost) {
                alert(`ì„¸í˜¸ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: ${cost}, ë³´ìœ : ${sehoCoin})`);
                return;
            }
            
            // êµ¬ë§¤ í™•ì¸
            if (!confirm(`${item.displayName || item.name}ì„(ë¥¼) ${cost} ì„¸í˜¸ì½”ì¸ì— êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            // ì„¸í˜¸ì½”ì¸ ì°¨ê°
            sehoCoin -= cost;
            updateCoinDisplay();
            
            // êµ¬ë§¤ ê¸°ë¡ ì¶”ê°€
            purchasedInCurrentShop.push(itemIndex);
            
             // ì•„ì´í…œ íƒ€ì…ì— ë”°ë¼ ì²˜ë¦¬
             if (item.type === 'potion') {
                 // í¬ì…˜ì€ ì•„ì´í…œ ë³´ê´€ì†Œì— ì¶”ê°€
                 addToItemStorage(item.name, item.quantity);
                 alert(`${item.displayName}ì„(ë¥¼) êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤! ì•„ì´í…œ ë³´ê´€ì†Œë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
              } else if (item.type === 'theme') {
                  // í…Œë§ˆëŠ” êµ¬ë§¤ ëª©ë¡ì— ì¶”ê°€
                  if (!purchasedThemes.includes(item.name)) {
                      purchasedThemes.push(item.name);
                      // í…Œë§ˆ ì„ íƒê¸° ì—…ë°ì´íŠ¸
                      initThemeSelector();
                  }
                  alert(`${item.name}ì„(ë¥¼) êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤! ì„¤ì •ì—ì„œ í…Œë§ˆë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
              } else if (item.type === 'special') {
                  if (item.effect === 'guaranteed_special') {
                      // ìš©ì‚¬ì˜ ì‹¬íŒ
                      specialItemCount += item.quantity;
                      alert(`${item.name}ì„(ë¥¼) êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤! ë‹¤ìŒ ë½‘ê¸°ì—ì„œ íŠ¹ë³„íš¨ê³¼ê°€ ì ìš©ë©ë‹ˆë‹¤.`);
                  } else {
                      // ê¸°íƒ€ íŠ¹ìˆ˜ ì•„ì´í…œë“¤ì€ ì•„ì´í…œ ë³´ê´€ì†Œì— ì¶”ê°€
                      addToItemStorage(item.name, item.quantity);
                      alert(`${item.displayName}ì„(ë¥¼) êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤! ì•„ì´í…œ ë³´ê´€ì†Œë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
                  }
              }
            
            // í™”ë©´ ê°±ì‹ 
            updateShopDisplay();
            saveState();
        }
        
        // ìƒì  íƒ€ì´ë¨¸ ì‹œì‘
        function startShopTimer() {
            if (shopTimerInterval) clearInterval(shopTimerInterval);
            
            shopTimerInterval = setInterval(() => {
                const now = Date.now();
                const remaining = Math.max(0, shopRefreshTime - now);
                
                if (remaining === 0) {
                    // ì‹œê°„ì´ ë‹¤ ë˜ë©´ ìƒì  ê°±ì‹ 
                    refreshShop();
                }
                
                // íƒ€ì´ë¨¸ í‘œì‹œ ì—…ë°ì´íŠ¸
                updateShopTimer(remaining);
            }, 1000);
        }
        
        // ìƒì  íƒ€ì´ë¨¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateShopTimer(remainingMs) {
            const timerEl = document.getElementById('shopTimer');
            if (!timerEl) return;
            
            const totalSec = Math.floor(remainingMs / 1000);
            const minutes = Math.floor(totalSec / 60);
            const seconds = totalSec % 60;
            
            timerEl.textContent = `ê°±ì‹ ê¹Œì§€: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // ========== ì•„ì´í…œ ë³´ê´€ì†Œ ì‹œìŠ¤í…œ ==========
        
        let itemStorage = []; // ì•„ì´í…œ ë³´ê´€ì†Œ (ë‚˜ì¤‘ì— êµ¬í˜„)
        
        // ì•„ì´í…œ ë³´ê´€ì†Œ í™”ë©´ ì—…ë°ì´íŠ¸
        function updateItemStorageDisplay() {
            const storageList = document.getElementById('itemStorageList');
            if (!storageList) return;
            
            if (itemStorage.length === 0) {
                storageList.innerHTML = '<p>ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // ì•„ì´í…œ ëª©ë¡ ìƒì„±
            let html = '';
            itemStorage.forEach((item, index) => {
                const name = item.name || '???';
                const count = item.count || 1;
                const date = item.date || '';
                const time = item.time || '';
                
                html += `
                    <div class="storage-item" data-index="${index}" style="cursor: pointer;">
                        <div class="storage-item-header">
                            <span class="storage-item-name">${name}</span>
                            <span class="storage-item-count">x${count}</span>
                        </div>
                        <div class="storage-item-info">
                            <span class="storage-item-date">${date} ${time}</span>
                        </div>
                    </div>
                `;
            });
            
            storageList.innerHTML = html;
            
            // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            storageList.querySelectorAll('.storage-item').forEach((itemEl) => {
                itemEl.addEventListener('click', () => {
                    const index = parseInt(itemEl.getAttribute('data-index'));
                    useItemFromStorage(index);
                });
            });
        }

        // ========== ì„¸í˜¸ì½”ì¸ & ë²„í”„ ì‹œìŠ¤í…œ ==========
        
        // ì„¸í˜¸ì½”ì¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateCoinDisplay() {
            const coinEl = document.getElementById('coinAmount');
            if (coinEl) {
                coinEl.textContent = sehoCoin.toLocaleString();
            }
        }

        // ë²„í”„ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateBuffDisplay() {
            const container = document.getElementById('buffContainer');
            if (!container) return;
            
            container.innerHTML = '';
            const now = Date.now();
            
            activeBuffs.forEach((buff, index) => {
                const remaining = Math.max(0, buff.endTime - now);
                if (remaining === 0) return; // ë§Œë£Œëœ ë²„í”„ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                const timeStr = `${minutes}:${String(seconds).padStart(2, '0')}`;
                
                const buffDiv = document.createElement('div');
                buffDiv.className = `buff-icon ${buff.type}`;
                buffDiv.innerHTML = `
                    <div class="buff-name">${buff.type === 'luck' ? 'í–‰ìš´' : 'ì†ë„'}${buff.level}</div>
                    <div class="buff-timer">${timeStr}</div>
                `;
                buffDiv.title = `${buff.type === 'luck' ? 'í–‰ìš´í¬ì…˜' : 'ì†ë„í¬ì…˜'}â… `.repeat(buff.level) + '\në‚¨ì€ ì‹œê°„: ' + timeStr;
                container.appendChild(buffDiv);
            });
        }

        // ë²„í”„ íƒ€ì´ë¨¸ ì‹œì‘
        let buffTimerInterval = null;
        function startBuffTimer() {
            if (buffTimerInterval) clearInterval(buffTimerInterval);
            
            buffTimerInterval = setInterval(() => {
                const now = Date.now();
                // ë§Œë£Œëœ ë²„í”„ ì œê±°
                activeBuffs = activeBuffs.filter(buff => buff.endTime > now);
                updateBuffDisplay();
                saveState();
            }, 1000);
        }

         // í¬ì…˜ ì‚¬ìš©
         function usePotion(type, level) {
             // ê°™ì€ íƒ€ì…ì˜ ë‹¤ë¥¸ ë ˆë²¨ í¬ì…˜ì´ ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
             const existingSameBuff = activeBuffs.find(b => b.type === type);
             if (existingSameBuff) {
                 alert('ì´ë¯¸ ê°™ì€ íš¨ê³¼ì˜ í¬ì…˜ì„ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤!');
                 return false;
             }
             
             const now = Date.now();
             let duration = 5 * 60 * 1000; // ê¸°ë³¸ 5ë¶„
             
             // 1339í¬ì…˜ì€ 10ë¶„
             if (type === 'speed_boost') {
                 duration = 10 * 60 * 1000;
             }
             
             // ê°™ì€ í¬ì…˜ì´ ìˆìœ¼ë©´ ì‹œê°„ë§Œ ì—°ì¥
             const existing = activeBuffs.find(b => b.type === type && b.level === level);
             if (existing) {
                 existing.endTime = Math.max(existing.endTime, now) + duration;
             } else {
                 activeBuffs.push({
                     type: type,
                     level: level,
                     endTime: now + duration
                 });
             }
             
             updateBuffDisplay();
             saveState();
             return true;
         }

         // íŠ¹ìˆ˜ ì•„ì´í…œ ì‚¬ìš©
         function useSpecialItem(effect, item) {
             if (effect === 'remove_cooldown') {
                 // ì£¼ë§ íš¨ê³¼
                 noCooldownCount += 50;
                 alert('ì£¼ë§ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤! ë‹¤ìŒ 50íšŒ ë½‘ê¸°ì—ì„œ ì¿¨íƒ€ì„ì´ ì‚­ì œë©ë‹ˆë‹¤.');
                 return true;
             } else if (effect === 'refresh_shop') {
                 // ë³´ì¡°ë°°í„°ë¦¬ íš¨ê³¼
                 if (item.usesLeft === undefined) {
                     item.usesLeft = 3;
                 }
                 if (item.usesLeft > 0) {
                     item.usesLeft--;
                     refreshShop();
                     alert(`ë³´ì¡°ë°°í„°ë¦¬ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤! ìƒì ì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤. (ë‚¨ì€ ì‚¬ìš© íšŸìˆ˜: ${item.usesLeft})`);
                     return true;
                 } else {
                     alert('ë³´ì¡°ë°°í„°ë¦¬ì˜ ì‚¬ìš© íšŸìˆ˜ê°€ ëª¨ë‘ ì†Œëª¨ë˜ì—ˆìŠµë‹ˆë‹¤!');
                     return false;
                 }
             } else if (effect === 'lucky_box') {
                 // ëŸ­í‚¤ë°•ìŠ¤ íš¨ê³¼
                 const luckCount = Math.floor(Math.random() * 10) + 1;
                 const speedCount = Math.floor(Math.random() * 10) + 1;
                 
                 addToItemStorage('í–‰ìš´í¬ì…˜â…¡', luckCount);
                 addToItemStorage('ì†ë„í¬ì…˜â…¡', speedCount);
                 
                 // í™”ë©´ ìƒë‹¨ì— ê²°ê³¼ í‘œì‹œ
                 showLuckyBoxResult(luckCount, speedCount);
                 alert(`ëŸ­í‚¤ë°•ìŠ¤ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤! í–‰ìš´í¬ì…˜â…¡ ${luckCount}ê°œ, ì†ë„í¬ì…˜â…¡ ${speedCount}ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`);
                 return true;
             } else if (effect === 'name_converter') {
                 // ì“¸ë°ì—†ëŠ” ë³€í™˜ê¸° íš¨ê³¼
                 convertSehoNames();
                 alert('ì“¸ë°ì—†ëŠ” ë³€í™˜ê¸°ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤! ë³´ê´€ì†Œì˜ ì„¸í˜¸ 3ê°œì˜ ì´ë¦„ì´ ë°”ë€ë‹ˆë‹¤.');
                 return true;
             }
             return false;
         }

        // ì•„ì´í…œ ë³´ê´€ì†Œì— ì•„ì´í…œ ì¶”ê°€
        function addToItemStorage(itemName, quantity = 1) {
            const now = new Date();
            const existing = itemStorage.find(item => item.name === itemName);
            
            if (existing) {
                existing.count += quantity;
                existing.date = now.toLocaleDateString('ko-KR');
                existing.time = now.toLocaleTimeString('ko-KR');
            } else {
                itemStorage.push({
                    name: itemName,
                    count: quantity,
                    date: now.toLocaleDateString('ko-KR'),
                    time: now.toLocaleTimeString('ko-KR')
                });
            }
            
            updateItemStorageDisplay();
            saveState();
        }

         // ì•„ì´í…œ ë³´ê´€ì†Œì—ì„œ ì•„ì´í…œ ì‚¬ìš©
         function useItemFromStorage(index) {
             if (index < 0 || index >= itemStorage.length) return;
             
             const item = itemStorage[index];
             const itemData = allShopItems.find(si => si.name === item.name);
             
             if (!itemData) return;
             
             if (itemData.type === 'potion') {
                 if (usePotion(itemData.effect, itemData.level)) {
                     item.count--;
                     if (item.count <= 0) {
                         itemStorage.splice(index, 1);
                     }
                     updateItemStorageDisplay();
                     saveState();
                     alert(`${item.name}ì„(ë¥¼) ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤!`);
                 }
             } else if (itemData.type === 'special') {
                 if (useSpecialItem(itemData.effect, item)) {
                     item.count--;
                     if (item.count <= 0) {
                         itemStorage.splice(index, 1);
                     }
                     updateItemStorageDisplay();
                     saveState();
                 }
             }
         }

        // ì„¸í˜¸ íŒë§¤ í•¨ìˆ˜
        function sellItem(index, event) {
            event.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
            
            if (index < 0 || index >= storage.length) return;
            
            const item = storage[index];
            const sellPrice = calculateSellPrice(item, 1); // í•˜ë‚˜ì”©ë§Œ íŒë§¤
            
            if (!confirm(`íŒë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (${sellPrice} ì„¸í˜¸ì½”ì¸, ì†Œìˆ˜ì  ë°˜ì˜¬ë¦¼ë¨)`)) {
                return;
            }
            
            // ê°œìˆ˜ê°€ 1ê°œ ì´ìƒì´ë©´ 1ê°œë§Œ ê°ì†Œ, ì•„ë‹ˆë©´ ì•„ì´í…œ ì œê±°
            if ((item.count || 1) > 1) {
                item.count -= 1;
            } else {
                storage.splice(index, 1);
            }
            
            // ì„¸í˜¸ì½”ì¸ ì¦ê°€
            sehoCoin += sellPrice;
            
            // í™”ë©´ ì—…ë°ì´íŠ¸
            updateStorageDisplay();
            updateCoinDisplay();
            saveState();
            
            alert(`${item.name}ì„(ë¥¼) ${sellPrice} ì„¸í˜¸ì½”ì¸ì— íŒë§¤í–ˆìŠµë‹ˆë‹¤!`);
        }

        // ì„¸í˜¸ íŒë§¤ ê°€ê²© ê³„ì‚°
        function calculateSellPrice(item, sellCount = 1) {
            let basePrice;
            
            // íŠ¹ìˆ˜ íš¨ê³¼ë³„ ê¸°ë³¸ ê°€ê²©
            if (item.effectType === 'rainbow') {
                basePrice = 20000; // ë¬´ì§€ê°¯ë¹› íŠ¹ë³„íš¨ê³¼
            } else if (item.effectType === 'diamond') {
                basePrice = 1250; // ë‹¤ì´ì•„ëª¬ë“œìƒ‰ íŠ¹ë³„íš¨ê³¼
            } else if (item.effectType === 'golden') {
                basePrice = 200; // í™©ê¸ˆìƒ‰ íŠ¹ë³„íš¨ê³¼
            } else if (item.effectType === 'sparkling') {
                basePrice = 30; // ë²ˆì©ì´ëŠ” íŠ¹ë³„íš¨ê³¼
            } else if (item.effectType === 'shining') {
                basePrice = 5; // ë¹›ë‚˜ëŠ” íŠ¹ë³„íš¨ê³¼
            } else {
                basePrice = 1; // ì¼ë°˜ì¢…ë¥˜ ëª¨ë“  ì„¸í˜¸
            }
            
            // ê°•í™” ë‹¨ê³„ë³„ ê°€ê²© ë°°ìˆ˜ ì ìš©
            const enhanceLevel = item.enhanceLevel || 0;
            if (enhanceLevel === 1) {
                basePrice *= 1.1; // 1ê°•: 1.1ë°°
            } else if (enhanceLevel === 2) {
                basePrice *= 1.25; // 2ê°•: 1.25ë°°
            } else if (enhanceLevel === 3) {
                basePrice *= 1.5; // 3ê°•: 1.5ë°°
            } else if (enhanceLevel === 4) {
                basePrice *= 2; // 4ê°•: 2ë°°
            } else if (enhanceLevel === 5) {
                basePrice *= 4; // 5ê°•: 4ë°°
            }
            
            // íŒë§¤ ê°œìˆ˜ë§Œí¼ ê°€ê²© ì¦ê°€
            basePrice *= sellCount;
            
            // ì†Œìˆ˜ì  ë°˜ì˜¬ë¦¼
            return Math.round(basePrice);
        }

        // ========== í…Œë§ˆ ì‹œìŠ¤í…œ ==========
        
        // í…Œë§ˆ ì„ íƒê¸° ì´ˆê¸°í™”
        function initThemeSelector() {
            const selector = document.getElementById('themeSelector');
            if (!selector) return;
            
            // ê¸°ì¡´ ë²„íŠ¼ë“¤ ì œê±°
            selector.innerHTML = '';
            
            // ê¸°ë³¸ í…Œë§ˆ (í•­ìƒ ì‚¬ìš© ê°€ëŠ¥)
            const defaultButton = createThemeButton('default', 'ê¸°ë³¸');
            selector.appendChild(defaultButton);
            
            // êµ¬ë§¤í•œ í…Œë§ˆë“¤ë§Œ ì¶”ê°€
            purchasedThemes.forEach(themeName => {
                const themeColor = themeName.replace('í…Œë§ˆ_', '');
                const button = createThemeButton(themeColor, themeColor);
                selector.appendChild(button);
            });
            
            // í˜„ì¬ í…Œë§ˆ í™œì„±í™” í‘œì‹œ
            updateThemeButtons();
        }
        
        // í…Œë§ˆ ë²„íŠ¼ ìƒì„±
        function createThemeButton(themeColor, displayName) {
            const button = document.createElement('div');
            button.className = `theme-button ${themeColor}`;
            button.title = displayName;
            button.onclick = () => changeTheme(themeColor);
            return button;
        }
        
        // í…Œë§ˆ ë³€ê²½
        function changeTheme(themeColor) {
            if (themeColor !== 'default' && !purchasedThemes.includes(`í…Œë§ˆ_${themeColor}`)) {
                alert('ì´ í…Œë§ˆëŠ” êµ¬ë§¤í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
                return;
            }
            
            currentTheme = themeColor;
            applyTheme(themeColor);
            updateThemeButtons();
            saveState();
        }
        
        // í…Œë§ˆ ì ìš©
        function applyTheme(themeColor) {
            const body = document.body;
            
            // ê¸°ì¡´ í…Œë§ˆ í´ë˜ìŠ¤ ì œê±°
            body.className = body.className.replace(/theme-\w+/g, '');
            
            // ìƒˆ í…Œë§ˆ í´ë˜ìŠ¤ ì¶”ê°€
            if (themeColor !== 'default') {
                body.classList.add(`theme-${themeColor}`);
            }
            
            console.log('Applied theme:', themeColor, 'Body classes:', body.className);
        }
        
         // í…Œë§ˆ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
         function updateThemeButtons() {
             const buttons = document.querySelectorAll('.theme-button');
             buttons.forEach(button => {
                 button.classList.remove('active');
                 const themeColor = button.className.match(/theme-button (\w+)/)[1];
                 if (themeColor === currentTheme) {
                     button.classList.add('active');
                 }
             });
         }

         // ëŸ­í‚¤ë°•ìŠ¤ ê²°ê³¼ í‘œì‹œ
         function showLuckyBoxResult(luckCount, speedCount) {
             const resultDiv = document.createElement('div');
             resultDiv.style.cssText = `
                 position: fixed;
                 top: 50%;
                 left: 50%;
                 transform: translate(-50%, -50%);
                 background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
                 border: 3px solid #b8860b;
                 border-radius: 15px;
                 padding: 30px;
                 color: #8b4513;
                 font-size: 1.5em;
                 font-weight: bold;
                 text-align: center;
                 z-index: 10000;
                 box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
                 animation: pulse 0.5s ease-in-out;
             `;
             resultDiv.innerHTML = `
                 <div style="margin-bottom: 15px;">ğŸ ëŸ­í‚¤ë°•ìŠ¤ ê²°ê³¼ ğŸ</div>
                 <div>í–‰ìš´í¬ì…˜â…¡ x${luckCount}</div>
                 <div>ì†ë„í¬ì…˜â…¡ x${speedCount}</div>
             `;
             document.body.appendChild(resultDiv);
             
             setTimeout(() => {
                 if (resultDiv.parentNode) {
                     resultDiv.parentNode.removeChild(resultDiv);
                 }
             }, 3000);
         }

         // ì„¸í˜¸ ì´ë¦„ ë³€í™˜
         function convertSehoNames() {
             if (storage.length === 0) return;
             
             const sehoNames = ['ì„¸í˜¸ë¡œë¦¬', 'ì„¸í˜¸ê²Œì´', 'ì„¸í˜¸í¼ë¦¬', 'ì”¹ë•ì„¸í˜¸', 'ë§ˆì£ ì´ìŠ¤íŠ¸ ì„¸í˜¸', 
                              'í‰ë²”í•œ ì„¸í˜¸', 'TSì„¸í˜¸', 'ì‡¼íƒ€ì„¸í˜¸', 'ì—ê²ì„¸í˜¸', 'ë‹ˆê±°ì„¸í˜¸'];
             
             // ì´ë¦„ì´ ë°”ë€ ì•„ì´í…œë“¤ ì´ˆê¸°í™”
             nameChangedItems = [];
             
             // ëœë¤í•˜ê²Œ 3ê°œ ì„ íƒ (ìµœëŒ€ storage.lengthê°œ)
             const maxItems = Math.min(3, storage.length);
             const selectedIndices = [];
             
             while (selectedIndices.length < maxItems) {
                 const randomIndex = Math.floor(Math.random() * storage.length);
                 if (!selectedIndices.includes(randomIndex)) {
                     selectedIndices.push(randomIndex);
                 }
             }
             
             selectedIndices.forEach(index => {
                 const item = storage[index];
                 if (item && item.name !== 'ê½') {
                     // ì›ë³¸ ì´ë¦„ì—ì„œ íŠ¹ë³„íš¨ê³¼ ì œê±°
                     const originalName = item.name.replace(/âœ¨ ë¹›ë‚˜ëŠ” |âš¡ ë²ˆì©ì´ëŠ” |ğŸ† í™©ê¸ˆìƒ‰ |ğŸ’ ë‹¤ì´ì•„ëª¬ë“œìƒ‰ |ğŸŒˆ ë¬´ì§€ê°¯ë¹› |ğŸŒˆ/g, '');
                     
                     // ìƒˆë¡œìš´ ì´ë¦„ ì„ íƒ
                     const newName = sehoNames[Math.floor(Math.random() * sehoNames.length)];
                     
                     // íŠ¹ë³„íš¨ê³¼ê°€ ìˆë‹¤ë©´ ë‹¤ì‹œ ì¶”ê°€
                     let finalName = newName;
                     if (item.effectType === 'shining') finalName = `âœ¨ ë¹›ë‚˜ëŠ” ${newName} âœ¨`;
                     else if (item.effectType === 'sparkling') finalName = `âš¡ ë²ˆì©ì´ëŠ” ${newName} âš¡`;
                     else if (item.effectType === 'golden') finalName = `ğŸ† í™©ê¸ˆìƒ‰ ${newName} ğŸ†`;
                     else if (item.effectType === 'diamond') finalName = `ğŸ’ ë‹¤ì´ì•„ëª¬ë“œìƒ‰ ${newName} ğŸ’`;
                     else if (item.effectType === 'rainbow') finalName = `ğŸŒˆ ${newName} ğŸŒˆ`;
                     
                     item.name = finalName;
                     nameChangedItems.push(index);
                 }
             });
             
             // 10ì´ˆ í›„ ì´ë¦„ ë³€ê²½ íš¨ê³¼ ì œê±°
             if (nameChangeTimer) clearTimeout(nameChangeTimer);
             nameChangeTimer = setTimeout(() => {
                 nameChangedItems = [];
                 updateStorageDisplay();
             }, 10000);
             
             updateStorageDisplay();
         }

  </script>
</body>
</html>


